(function(){var p;try{(function(){var n={L_Collections_NotFound_Text:"The original result is no longer available:",L_Collections_TryAgain_Text:"Try searching and saving again.",L_FilterName_AlongARoute:"Along a route",L_FilterName_QueryRep_FilterBy_AllPrices:"All Prices",L_FilterName_QueryRep_FilterBy_AllRatings:"All Ratings",L_FiltersBar_Rating_OptionSuffix:"& up",L_LocalSearch_BackToCollections:"Favorites group",L_LocalSearch_BackToSearchResults:"Search results",L_LocalSearch_ReturnToList:"return to list",L_SearchAlongRouteNoneOptionText:"None",L_SearchNearbyGhostTextFormat:"Search near {query}",L_SearchNearbyTerm_1:"Parking",L_SearchNearbyTerm_2:"Hotels",L_SearchNearbyTerm_3:"Restaurants",L_SearchNearbyTerm_4:"Coffee",L_Menu_ReportProblem_Link_Text:"Report a Problem",L_LocalSearch_SearchAlongYourRouteTitle:"{0} along your route",L_SearchNearbyCategoryId_1:"90925",L_SearchNearbyCategoryId_2:"91572",L_SearchNearbyCategoryId_3:"90287",L_SearchNearbyCategoryId_4:"91649",L_SearchNearbyCategoryId_5:"90089",L_SearchNearbyCategoryId_6:"90738",L_SearchNearbyCategoryId_7:"250",L_SearchNearbyTerm_5:"Gas stations",L_SearchNearbyTerm_6:"Grocery stores",L_SearchNearbyTerm_7:"Nearby Transit",L_FiltersBar_UserRating_SelectionLabel:"Rating: {0} stars & up",L_Menu_SuggestAnEdit_Link_Text:"Suggest an edit",L_FiltersBar_UserRating_SelectionLabel_HighestRating:"Rating: {0} stars",L_FilterName_QueryRep_FilterBy_AllCuisines:"All Cuisines",L_PrintEntityAddress_Text:"Address:",L_PrintEntityPhone_Text:"Phone:",L_PrintEntityTitle_Text:"Title:",L_PrintNotes_Watermark:"Type your notes here.",L_PrintEntityWebsite_Text:"Website:",L_PrintCurrency_Text:"$",L_PrintExtendedArea_Text:"Area:",L_PrintExtendedAt_Text:"Located At:",L_PrintExtendedAvgRate_Text:"Average Rate:",L_PrintExtendedCapitol_Text:"Capital:",L_PrintExtendedCC_Text:"Calling Code:",L_PrintExtendedCounty_Text:"County Seat:",L_PrintExtendedCuisine_Text:"Cuisine:",L_PrintExtendedFounded_Text:"Founded:",L_PrintExtendedGDP_Text:"GDP:",L_PrintExtendedHotelClass_Text:"Hotel Class:",L_PrintExtendedLatLong_Text:"Location:",L_PrintExtendedPopulation_Text:"Population:",L_PrintExtendedPrice_Text:"Price:",L_PrintExtendedTravelTip_Text:"Travel Tip:",L_WikipediaTitle_Text:"Wikipedia",L_HoursLabel_Text:"Hours",L_ReportMissingBusiness_Text:"Add a Missing Business",L_AddMissingBusinessCardTitle:"Add missing business",L_AddMissingBusinessMessage:"Did not find what you are looking for?",L_PrintClinicTitle_Text:"Clinic:",L_PrintHomeFactsTitle_Text:"Home Facts",L_PrintLastSoldTitle_Text:"Last Sold:",L_PrintMoreInfoTitle_Text:"More Info",L_PrintSpecialtyTitle_Text:"Specialty:",L_PrintZestimateTitle_Text:"ZEstimate ",L_PrintExperienceTitle_Text:"Years of experience:",L_FilterName_QueryRep_FilterBy_Price:"Price",L_FilterName_QueryRep_FilterBy_Rating:"Rating",L_FilterName_QueryRep_FilterBy_Cuisine:"Cuisine",L_FilterName_QueryRep_FilterBy_OpenTime:"Open time",L_FilterName_QueryRep_FilterBy_Amenities:"Amenities",L_FilterName_QueryRep_SortBy:"Sort by",L_AddNickNameOption:"Add a nickname",L_AddNoteOption:"Add a description",L_EditNickNameOption:"Edit nickname",L_EditNoteOption:"Edit description",L_DeleteNickNameOption:"Delete nickname",L_DeleteNoteOption:"Delete description",L_AddButton:"Add",L_EditButton:"Save",L_AnnotateToolTip:"Add a nickname or description",L_ReservationTitle:"Your Reservation",L_FlightTitle:"Your Flight",L_EventInfoMessage:"This event was inferred from your Outlook email account or calendar.",L_CheckInText:"Check-in",L_CheckOutText:"Check-out",L_SeeEmailLinkText:"See email for this reservation",L_SeeEmailFlightLinkText:"See email for this flight",L_DepartureText:"Departs ",L_ArrivalText:"Arrives at ",L_AirportFormat:"{0} ({1})",L_AirlineFormat:"{0} Confirmation #{1}",L_SeeMoreFlightsText:"See your other flights",L_VenueMapTaskTitle_Suffix:"Directory - ",L_VenueMapTask_NoEntity_Message:"Detailed directory of this level coming soon",L_VenueMapTask_NoCategory_Message:"No business of selected category on this level",L_RichAttributeFeedbackTitle:"Tell Bing about this business",L_PrintTrailInfo_Text:"Trail Data:",L_PrintSeason_Text:"Season:",L_PrintDifficulty_Text:"Difficulty:",L_PrintActivities_Text:"Activities:",L_PrintSeparator_Text:" Â· ",L_PrintAnnualVisitors_Text:"Annual Visitors:",L_PrintArchitects_Text:"Architect(s):",L_PrintArchitectureFirm_Text:"Architecture Firm:",L_PrintArtists_Text:"Artists:",L_PrintAverageStay_Text:"Average Stay:",L_PrintCapacity_Text:"Capacity:",L_PrintDateCompleted_Text:"Date Completed:",L_PrintEstablished_Text:"Established:",L_PrintFloors_Text:"Floors:",L_PrintHeight_Text:"Height:",L_PrintInterests_Text:"Interests:",L_PrintMainSites_Text:"Main Sites: ",L_PrintMedia_Text:"Media:",L_PrintOpened_Text:"Opened:",L_PrintOpen_Text:"Open:",L_PrintRates_Text:"Rates:",L_PrintServiceAreas_Text:"Service Areas:",L_PrintSites_Text:"Sites:",L_PrintSubjects_Text:"Subjects:",L_PrintTeams_Text:"Team(s):",L_PrintElevation_Text:"Elevation:",L_PrintFirstAscender_Text:"First ascender:",L_PrintFirstAscent_Text:"First ascent:",L_PrintLastEruption_Text:"Last eruption:",L_PrintMountainRange_Text:"Mountain range:",L_PrintProminence_Text:"Prominence:",L_PrintCollegesUniversities_Text:"Colleges and universities:",L_PrintNearbyAirport_Text:"Nearby Airport(s):",L_AddToItinerary:"Add to Itinerary",L_SaveTooltip:"Save",L_ShareTooltip:"Share",L_EllipsisTooltip:"More",L_TimeDriveHome_Text:"{0} drive from home",L_TimeDriveWork_Text:"{0} drive from work",L_TimeWalkHome_Text:"{0} walk from home",L_TimeWalkWork_Text:"{0} walk from work",L_TimeDurationLessThan_Text:"< {0} min",AnnotationCloseText:"Close",PaginationNextLabelText:"Next Page",PaginationPreviousLabelText:"Previous Page",InfoboxListAriaLabel:"Click for more details",L_Deal_Text:"DEAL",HotelsFound:"Found ",HotelsNear:" hotels near ",HotelPricesHere:"Hotel prices here are ",HotelCityAverage:" than city average",HotelPricesCheaper:" cheaper ",HotelPricesExpensive:" more expensive ",HotelPricesWithin:"within",HotelWithinCityAverage:" city average",HotelDistanceFromCityCenter:" miles away from city center",HotelThisLocation:"This location is ",HotelNear:"near",HotelCityCenter:" city center",HotelAreaSafety:"Area safety here is ",HotelSafetyExcellent:"Excellent",HotelSafetyGood:"Good",HotelSafetyNeutral:"Neutral"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("LocalSearch",n):window.$MicrosoftMaps8.ResourcesObject=n})();var o=window.$MicrosoftMaps8,a=o.Local=o.Local||{},c=o.Internal=o.Internal||{},pt=c.TaskData=c.TaskData||{},si=o.Directions=o.Directions||{},k=c.AdsScenario,gf=o.ButtonGroupViewModel,yi=c._BaseMapTemplateSelector,tt=c.BaseTask,wt=c.BaseTaskViewModel,uu=o.BirdseyeV2Manager,fu=o.BirdseyeV2Metadata,ne=o.BitmapImageTemplate,eu=o.GlobalConfig.features.calendar,ou=o.CalendarSync,te=c.CanvasDrawingContext,yt=pt.CollectionActions,ie=o.GlobalConfig.features.collections,re=o.CommonControls.CollectionsListDropdownViewModel,w=c._ComponentNames,gt=c.ControlTemplate,f=o.DataHandlerKeys,pi=c._Debug,su=si.DefaultDirectionsFormattedTextProvider,ue=o.DetailsTaskPoiManager,hu=o.GlobalConfig.features.directions,fe=o.CommonControls.DirectionsListDropdownViewModel,ht=pt.DirectionsMode,wi=pt.DistanceUnit,u=c._EntryPoints,ft=c._FeatureNames,st=o.GlobalConfig.features.feedback,cu=o.FiltersBarModuleViewModel,ee=o.FiltersBarViewModel,oe=o.FiltersStatusBarViewModel,lu=o.FiltersBar,bt=o.FiltersBarItem,ct=o.FiltersBarItemData,i=c._Gimme,y=o.GlobalConfig,e=o.GlobalDataEventHandler,lt=o.Heading,r=c._Helper,bi=o.HomeOrWorkEnabledLocalSearchEntity,se=typeof o.Infobox!="undefined"?o.Infobox:undefined,g=c._JSEvent,he=c._LatLonCrs,ki=y.features.layerManager,ce=o.CommonControls.ListDropdownViewModel,n=y.features.localSearch,hi=o.LocalSearchEntity,le=c._LocalStorageCache,di=o.LocationRect,h=c._LoggerConstants,et=c.MapHelper,ae=c.MapInteractionBehavior,b=o.Location,gi=o.MapMath,nr=o.MapTypeId,tr=o.MapView,au=o.MapViewAnimator,ve=o.MicroPoiManager,vu=o.CommonControls.ModalDialogViewModel,it=c._Network,kt=c._ObservableObject,ye=c._ObservableObjectChangedArgs,ni=c._ObservableCollection,pe=c._OverlayEntity,we=o.CommonControls.PopOutButtonViewModel,be=o.CommonControls.PopOutMessageViewModel,ke=o.CommonControls.CollectionPopOutMessageViewModel,de=y.features.parking,ir=o.GlobalConfig.features.print,rr=c.PrintContent,yu=c.PrintManager,rt=c._PerfV2Logger,ur=pt.RecommendationEntity,t=o.ResourceManager.LocalSearch,pu=o.ResultsTaskPoiManager,wu=si.RouteErrorType,bu=si.RouteResultsDataModel,ti=o.SignInState,ci=o.SimplePointPrimitive,ku=c._StreetsidePerfConstants,ut=o.CommonControls.SyndicatedAds,fr=o.CommonControls.ServerSideAds,ge=o.TaskBar,no=o.TaskMapInteractionBehavior,ii=c._TaskDataHandlerHelper,to=y.features.taskFramework,s=o.TaskTypes,io=o.VectorImageTemplate,ro=o.VectorMapLayer,uo=c.TipComponents,ri=pt.Waypoint,fo=o.CommonControls.SelectionListDropdownViewModel,st=o.GlobalConfig.features.feedback,er=o.GlobalConfig.features.streetside,at=o.GlobalConfig.features.travel,ui=o.ZoomLevel,eo=c.TransientLensActions,oo=o.PolygonListingTaskPoiManager,du='<div class="bm_annotationRoot" data-tag="annotationRoot">    <div class="auxillaryButtons">        <a class="annotateButton" data-tag="annotateButton" role="button" aria-expanded="false" event:click="onAnnotateClick" href="#" title="{Binding resources.L_AnnotateToolTip}" aria-expanded="false"><\/a>    <\/div>    <div class="nameContainer">        <TextBlock Text="{Binding CurrentName}" />    <\/div>    <div class="annotateDropdown popOutTop" style:display="{Binding ShowDropdown Converter=boolToDisplay}">        <a class="annotateEntry dropdownEntry" data-tag="annotateEntry" role="button" aria-label="{Binding CurrentName Converter=displayNameChangeMessage}" event:click="onAddNicknameClick" style:display="{Binding IsHomeWork Converter=boolToNotDisplay}" href="#">            <span class="annotateButton annotateIcon"><\/span>            <TextBlock Text="{Binding CurrentName Converter=displayNameChangeMessage}" />        <\/a>        <a class="annotateEntry dropdownEntry" data-tag="annotateEntry" role="button" aria-label="{Binding Description Converter=displayNoteChangeMessage}" event:click="onAddDescriptionClick" href="#">            <span class="annotateButton annotateIcon"><\/span>            <TextBlock Text="{Binding Description Converter=displayNoteChangeMessage}" />        <\/a>        <a class="annotateEntry dropdownEntry" data-tag="annotateEntry" role="button" aria-label="{Binding resources.L_DeleteNickNameOption}" event:click="onDeleteNicknameClick" style:display="{Binding CurrentName Converter=displayDeleteNickName}" href="#">            <span class="deleteButton annotateIcon"><\/span>            <TextBlock Text="{Binding resources.L_DeleteNickNameOption}" />        <\/a>        <a class="annotateEntry dropdownEntry" data-tag="annotateEntry" role="button" aria-label="{Binding resources.L_DeleteNoteOption}" event:click="onDeleteDescriptionClick" style:display="{Binding Description Converter=boolToDisplay}" href="#">            <span class="deleteButton annotateIcon"><\/span>            <TextBlock Text="{Binding resources.L_DeleteNoteOption}" />        <\/a>    <\/div>    <div class="annotatePopOut popOutTop nickNamePopOut" style:display="{Binding ShowNickNameEdit Converter=boolToDisplay}">        <a class="deleteButton annotateClose" data-tag="annotateClose" event:click="onCloseClick" href="#" role="button" aria-label="{Binding resources.AnnotationCloseText}" title="{Binding resources.AnnotationCloseText}"><\/a>        <div id="addNameLabel">            <TextBlock text="{Binding CurrentName Converter=displayNameChangeMessage}" />        <\/div>        <div class="nameInputContainer">            <input type="text" class="nameEditBox" data-tag="nameEditBox" maxlength="100" value="{Binding TempAnnotation Mode=TwoWay}" event:keydown="onKeyPressName" aria-labelledby="addNameLabel"/>            <a href="#" class="annotationAddButton" role="button" data-tag="annotationAddButton" event:click="onSaveNickNameClick">                <TextBlock Text="{Binding CurrentName Converter=showAddEditNameButton}" />            <\/a>        <\/div>    <\/div>    <div class="annotatePopOut popOutTop descriptionPopOut" style:display="{Binding ShowDescriptionEdit Converter=boolToDisplay}">        <a class="deleteButton annotateClose" role="button" data-tag="annotateClose" event:click="onCloseClick" href="#" aria-label="{Binding resources.AnnotationCloseText}" title="{Binding resources.AnnotationCloseText}"><\/a>        <div id="addDescriptionLabel">            <TextBlock text="{Binding Description Converter=displayNoteChangeMessage}" />        <\/div>        <div class="descriptionInputContainer">            <textarea class="descriptionEditBox" data-tag="descriptionEditBox" contenteditable="true" rows="4" maxlength="1000" value="{Binding TempAnnotation Mode=TwoWay}" event:keydown="onKeyPressNote" aria-labelledby="addDescriptionLabel"><\/textarea>            <a href="#" class="annotationAddButton" role="button" data-tag="annotationAddButton" event:click="onSaveDescriptionClick">                <TextBlock Text="{Binding Description Converter=showAddEditNoteButton}" />            <\/a>        <\/div>    <\/div>    <div class="descriptionContainer" style:display="{Binding Description Converter=boolToDisplay}">        <TextBlock Text="{Binding Description}" />    <\/div>    <div class="originalNameContainer" style:display="{Binding CurrentName Converter=displayIfDifferentName}">        <TextBlock Text="{Binding OriginalName}" />    <\/div><\/div>',gu='<ul>    <ItemsControl ItemsSource="{Binding geochainSegments}">        <ItemsControl.ItemTemplate>            <DataTemplate>                <li><TextBlock Text="{Binding displayName}" /><\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl><\/ul>',li='<div class="localEntitiesPrintText" data-tag="localEntitiesPrintText">    <ul class="localEnititiesList" data-tag="localEntitiesList">        <ItemsControl ItemsSource="{Binding printEntities}">            <ItemsControl.ItemTemplate>                <DataTemplate>                    <li>                        <div class="printEntity" data-tag="detailPrintEntity">                            <div class="printEntityTitle" style:display="{Binding Title Converter=nullToDisplayNone}">                                <div class="localSearchPrintTitle" data-tag="localDetailsPrintTitle">                                    <TextBlock Text="{Binding Title}" />                                <\/div>                            <\/div>                            <div class="printEntityTitle" style:display="{Binding originalName Converter=nullToDisplayNone}">                                <div class="localSearchPrintHeader" data-tag="localDetailsPrintOriginalName">                                    <TextBlock Text="{Binding originalName}" />                                <\/div>                            <\/div>                            <div class="isText showText printEntityAddress" style:display="{Binding Address Converter=hideIfMatchedData}">                                <div class="localPrintLabel">                                    <TextBlock Text="{Binding resources.L_PrintEntityAddress_Text}" />                                <\/div>                                <div class="localSearchPrintHeader" data-tag="localDetailsPrintAddress">                                    <TextBlock Text="{Binding Address}" />                                <\/div>                            <\/div>                            <div class="isText showText printEntityPhone" style:display="{Binding Phone Converter=nullToDisplayNone}">                                <div class="localPrintLabel">                                    <TextBlock Text="{Binding resources.L_PrintEntityPhone_Text}" />                                <\/div>                                <div class="localSearchPrintHeader" data-tag="localDetailsPrintPhone">                                    <TextBlock Text="{Binding Phone}" />                                <\/div>                            <\/div>                            <div class="isText showText printEntityWebsite" style:display="{Binding Website Converter=nullToDisplayNone}">                                <div class="localPrintLabel">                                    <TextBlock Text="{Binding resources.L_PrintEntityWebsite_Text}" />                                <\/div>                                <div class="localSearchPrintHeader" data-tag="localDetailsPrintWebsite">                                    <TextBlock Text="{Binding Website}" />                                <\/div>                            <\/div>                        <\/div>                    <\/li>                <\/DataTemplate>            <\/ItemsControl.ItemTemplate>        <\/ItemsControl>    <\/ul>    <div class="isText showText dataPrintFacts">        <ul class="localPrintFactsList" data-tag="localPrintFactsList">            <ItemsControl ItemsSource="{Binding printFacts}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <li>                            <div class="printFact">                                                                <div style:display="{Binding factLabel Converter=nullToDisplayNone}">                                    <div class="localPrintFactLabel">                                        <TextBlock Text="{Binding factLabel}" />                                    <\/div>                                    <div class="localSearchPrintHeader" data-tag="localDetailsPrintDataFact">                                        <div style:display="{Binding factData Converter=nullToDisplayNone}">                                            <TextBlock Text="{Binding factData}" />                                        <\/div>                                        <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                            <div style:display="{Binding extendedFacts.type Converter=nullToDisplayNone}">                                                <span style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                    <img src="{Binding extendedFacts.lengthIcon}" class="richPrintIcons" />                                                    <TextBlock Text="{Binding extendedFacts.length}" />                                                <\/span>                                                <span style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                    <span class="separator" style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                        <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                    <\/span>                                                    <img src="{Binding extendedFacts.elevationIcon}" class="richPrintIcons" />                                                    <TextBlock Text="{Binding extendedFacts.elevation}" />                                                <\/span>                                                <span style:display="{Binding extendedFacts.durationIcon Converter=nullToDisplayNone}">                                                    <span class="separator" style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                        <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                    <\/span>                                                    <img src="{Binding extendedFacts.durationIcon}" class="richPrintIcons" />                                                    <TextBlock Text="{Binding extendedFacts.duration}" />                                                <\/span>                                            <\/div>                                        <\/div>                                        <div style:display="{Binding extendedFacts.type Converter=displayOnCampgrounds}">                                            <span style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                <img src="{Binding extendedFacts.rvIcon}" class="richPrintIcons" />                                                <TextBlock Text="{Binding extendedFacts.rvSites}" />                                            <\/span>                                            <span style:display="{Binding extendedFacts.tentIcon Converter=nullToDisplayNone}">                                                <span class="separator" style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                <\/span>                                                <img src="{Binding extendedFacts.tentIcon}" class="richPrintIcons" />                                                <TextBlock Text="{Binding extendedFacts.tentSites}" />                                            <\/span>                                        <\/div>                                    <\/div>                                <\/div>                                                                <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                    <div style:display="{Binding extendedFacts.type Converter=nullToDisplayNone}">                                        <div class="localPrintFactLabel trailDifficulty">                                            <TextBlock Text="{Binding resources.L_PrintDifficulty_Text}" />                                        <\/div>                                        <span class="{Binding extendedFacts.difficulty}">                                            <TextBlock Text="{Binding extendedFacts.difficulty}" />                                        <\/span>                                    <\/div>                                <\/div>                            <\/div>                        <\/li>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/ul>    <\/div>    <div class="isText showText">        <div class="printHours" data-tag="detailPrintHours" style:display="{Binding listHours Converter=emptyToDisplayNone}">            <div class="localPrintLabel">                <TextBlock Text="{Binding resources.L_HoursLabel_Text}" />            <\/div>            <table>                <ItemsControl ItemsSource="{Binding listHours}" panelTagName="tbody">                    <ItemsControl.ItemTemplate>                        <DataTemplate>                            <tr data-tag="hourListing">                                <td class="dayOfTheWeek" data-tag="dayOfTheWeek"><TextBlock Text="{Binding day}" /><\/td>                                <td class="hoursOfTheDay" data-tag="hoursOfTheDay">                                    <ItemsControl ItemsSource="{Binding hourRanges}">                                        <ItemsControl.ItemTemplate>                                            <DataTemplate>                                                <div class="todaysHours" data-tag="todaysHours">                                                    <TextBlock Text="{Binding start}" />                                                    <TextBlock Text=" - " />                                                    <TextBlock Text="{Binding end}" />                                                <\/div>                                            <\/DataTemplate>                                        <\/ItemsControl.ItemTemplate>                                    <\/ItemsControl>                                <\/td>                            <\/tr>                        <\/DataTemplate>                    <\/ItemsControl.ItemTemplate>                <\/ItemsControl>            <\/table>        <\/div>    <\/div><\/div>',nf='<div class="isText showText localListingListPrintText" data-tag="localListingListPrintText">    <div class="entitiesCol1" data-tag="entitiesCol1">        <ul class="localEnititiesList" data-tag="localEntitiesList">            <ItemsControl ItemsSource="{Binding printEntities}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <li>                            <div class="printEntity" data-tag="listingPrintEntity">                                                                <div class="titleHead">                                    <div class="entityIcon">                                        <img class="printIcon" src="{Binding colorIndex Converter=chooseIconSource}" />                                        <span class="entityIndex" data-tag="entityIndex">                                            <TextBlock Text="{Binding iconText}" />                                        <\/span>                                    <\/div>                                    <div class="localEntityPrintTitle" data-tag="localEntityPrintTitle" style:display="{Binding Title Converter=nullToDisplayNone}">                                        <TextBlock Text="{Binding Title}" />                                    <\/div>                                <\/div>                                <div class="supplementalData">                                    <div class="schoolFact" style:display="{Binding schoolInfo Converter=nullToDisplayNone">                                        <TextBlock Text="{Binding schoolInfo}" />                                    <\/div>                                    <div class="printEntityAddress" style:display="{Binding printEntity Converter=hideMatchedData}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityAddress_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader" data-tag="localDetailsPrintAddress">                                            <TextBlock Text="{Binding Address}" />                                        <\/div>                                    <\/div>                                    <div class="printEntityPhone" style:display="{Binding Phone Converter=nullToDisplayNone}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityPhone_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader" data-tag="localDetailsPrintPhone">                                            <TextBlock Text="{Binding Phone}" />                                        <\/div>                                    <\/div>                                    <div class="printEntityWebsite" style:display="{Binding Website Converter=nullToDisplayNone}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityWebsite_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader listingWebsite" data-tag="localDetailsPrintWebsite">                                            <TextBlock Text="{Binding Website}" />                                        <\/div>                                    <\/div>                                    <div class="isText showText dataPrintFacts">                                        <ul class="localPrintFactsList" data-tag="localPrintFactsList">                                            <ItemsControl ItemsSource="{Binding printFacts}">                                                <ItemsControl.ItemTemplate>                                                    <DataTemplate>                                                        <li>                                                            <div class="printFact">                                                                <div style:display="{Binding factLabel Converter=nullToDisplayNone}">                                                                    <div class="localPrintFactLabel">                                                                        <TextBlock Text="{Binding factLabel}" />                                                                    <\/div>                                                                    <div class="localSearchPrintHeader" data-tag="localDetailsPrintDataFact">                                                                        <div style:display="{Binding extendedFacts.type Converter=notNullToDisplayNone}">                                                                            <TextBlock Text="{Binding factData}" />                                                                        <\/div>                                                                        <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                                                            <span style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                                                <img src="{Binding extendedFacts.lengthIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.length}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.elevationIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.elevation}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.durationIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.durationIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.duration}" />                                                                            <\/span>                                                                        <\/div>                                                                        <div style:display="{Binding extendedFacts.type Converter=displayOnCampgrounds}">                                                                            <span style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                                                <img src="{Binding extendedFacts.rvIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.rvSites}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.tentIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.tentIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.tentSites}" />                                                                            <\/span>                                                                                                                                                    <\/div>                                                                    <\/div>                                                                <\/div>                                                                <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                                                    <div style:display="{Binding extendedFacts.type Converter=nullToDisplayNone}">                                                                        <div class="localPrintFactLabel trailDifficulty">                                                                            <TextBlock Text="{Binding resources.L_PrintDifficulty_Text}" />                                                                        <\/div>                                                                        <span class="{Binding extendedFacts.difficulty}">                                                                            <TextBlock Text="{Binding extendedFacts.difficulty}" />                                                                        <\/span>                                                                    <\/div>                                                                <\/div>                                                            <\/div>                                                        <\/li>                                                    <\/DataTemplate>                                                <\/ItemsControl.ItemTemplate>                                            <\/ItemsControl>                                        <\/ul>                                    <\/div>                                <\/div>                             <\/div>                        <\/li>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/ul>           <\/div>    <div class="entitiesCol2" style:display="{Binding printEntitiesList2 Converter=nullToDisplayNone}" data-tag="entitiesCol2">        <ul class="localEnititiesList" data-tag="localEntitiesList">            <ItemsControl ItemsSource="{Binding printEntitiesList2}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <li>                            <div class="printEntity" data-tag="listingPrintEntity">                                <div class="titleHead">                                    <div class="entityIcon">                                        <img class="printIcon" src="{Binding colorIndex Converter=chooseIconSource}" />                                        <span class="entityIndex" data-tag="entityIndex">                                            <TextBlock Text="{Binding iconText}" />                                        <\/span>                                    <\/div>                                    <div class="localEntityPrintTitle" data-tag="localEntityPrintTitle" style:display="{Binding Title Converter=nullToDisplayNone}">                                        <TextBlock Text="{Binding Title}" />                                    <\/div>                                <\/div>                                <div class="supplementalData">                                    <div class="printEntityAddress" style:display="{Binding printEntity Converter=hideMatchedData}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityAddress_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader" data-tag="localDetailsPrintAddress">                                            <TextBlock Text="{Binding Address}" />                                        <\/div>                                    <\/div>                                    <div class="printEntityPhone" style:display="{Binding Phone Converter=nullToDisplayNone}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityPhone_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader" data-tag="localDetailsPrintPhone">                                            <TextBlock Text="{Binding Phone}" />                                        <\/div>                                    <\/div>                                    <div class="printEntityWebsite" style:display="{Binding Website Converter=nullToDisplayNone}">                                        <div class="localPrintLabel">                                            <TextBlock Text="{Binding resources.L_PrintEntityWebsite_Text}" />                                        <\/div>                                        <div class="localSearchPrintHeader listingWebsite" data-tag="localDetailsPrintWebsite">                                            <TextBlock Text="{Binding Website}" />                                        <\/div>                                    <\/div>                                    <div class="isText showText dataPrintFacts">                                        <ul class="localPrintFactsList" data-tag="localPrintFactsList">                                            <ItemsControl ItemsSource="{Binding printFacts}">                                                <ItemsControl.ItemTemplate>                                                    <DataTemplate>                                                        <li>                                                            <div class="printFact">                                                                <div style:display="{Binding factLabel Converter=nullToDisplayNone}">                                                                    <div class="localPrintFactLabel">                                                                        <TextBlock Text="{Binding factLabel}" />                                                                    <\/div>                                                                    <div class="localSearchPrintHeader" data-tag="localDetailsPrintDataFact">                                                                        <div style:display="{Binding extendedFacts.type Converter=notNullToDisplayNone}">                                                                            <TextBlock Text="{Binding factData}" />                                                                        <\/div>                                                                        <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                                                            <span style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                                                <img src="{Binding extendedFacts.lengthIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.length}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.lengthIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.elevationIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.elevation}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.durationIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.elevationIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.durationIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.duration}" />                                                                            <\/span>                                                                        <\/div>                                                                        <div style:display="{Binding extendedFacts.type Converter=displayOnCampgrounds}">                                                                            <span style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                                                <img src="{Binding extendedFacts.rvIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.rvSites}" />                                                                            <\/span>                                                                            <span style:display="{Binding extendedFacts.tentIcon Converter=nullToDisplayNone}">                                                                                <span class="separator" style:display="{Binding extendedFacts.rvIcon Converter=nullToDisplayNone}">                                                                                    <TextBlock Text="{Binding resources.L_PrintSeparator_Text}" />                                                                                <\/span>                                                                                <img src="{Binding extendedFacts.tentIcon}" class="richPrintIcons" />                                                                                <TextBlock Text="{Binding extendedFacts.tentSites}" />                                                                            <\/span>                                                                        <\/div>                                                                    <\/div>                                                                <\/div>                                                                <div style:display="{Binding extendedFacts.type Converter=displayOnTrails}">                                                                    <div style:display="{Binding extendedFacts.type Converter=nullToDisplayNone}">                                                                        <div class="localPrintFactLabel trailDifficulty">                                                                            <TextBlock Text="{Binding resources.L_PrintDifficulty_Text}" />                                                                        <\/div>                                                                        <span class="{Binding extendedFacts.difficulty}">                                                                            <TextBlock Text="{Binding extendedFacts.difficulty}" />                                                                        <\/span>                                                                    <\/div>                                                                <\/div>                                                            <\/div>                                                        <\/li>                                                    <\/DataTemplate>                                                <\/ItemsControl.ItemTemplate>                                            <\/ItemsControl>                                        <\/ul>                                    <\/div>                                <\/div>                            <\/div>                        <\/li>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/ul>                    <\/div><\/div>',tf='<div class="LocalListingTitlePrint" data-tag="LocalListingTitlePrint">    <div class="printQuery">        <div class="localSearchPrintTitle" data-tag="localSearchPrintTitle">            <TextBlock Text="{Binding query}" />        <\/div>    <\/div><\/div>',or='<div class="localSearchPrintPanel" data-tag="localSearchPrintPanel">    <div class="localSearchPrintText">        <div>            <table>                <tr>                    <td class="textColumn">                        <Tab TabContent="{Binding printTitleViewModel}" TabTemplate="{Binding titlePrintTemplate}" IsDisplayed="true"><\/Tab>                    <\/td>                    <td class="noteColumn">                        <div class="printNotes localPrintNotes" style:display="{Binding isDetails Converter=boolToDisplay}">                            <div class="searchNotesTableData screenNotes">                                <textarea class="searchNotes" contenteditable="true" placeholder="{Binding resources.L_PrintNotes_Watermark}" maxlength="{Binding notesMaxCharSize}" data-tag="printNotes">                                    <TextBlock Text="{Binding PrintNotes}" />                                <\/textarea>                            <\/div>                            <div class="printedNotes">                            <\/div>                        <\/div>                    <\/td>                                    <\/tr>            <\/table>        <\/div>        <div>            <Tab TabContent="{Binding printListingsViewModel}" TabTemplate="{Binding listingsPrintTemplate}" IsDisplayed="true"><\/Tab>        <\/div>    <\/div>    <div class="localSearchMapPrint isMap showMap taskMapPrintPageBreak" data-tag="localSearchMapPrint">        <div class="printArea" data-tag="printArea">            <div class="printMap" data-tag="printMap">            <\/div>        <\/div>    <\/div>    <div class="detailsAttribution" style:display="{Binding isDetails Converter=boolToDisplay}">        <TextBlock Text="{Binding attributionText}"/>    <\/div><\/div>',rf='<div class="report-missing-business-link-content">    <div class="feedbackCardLabel">        <TextBlock Text="{Binding resources.L_AddMissingBusinessMessage}" />    <\/div>    <div class="feedbackCardText">        <a href="#" class="reportProblemLink" role="button" event:click="addMissingEntityLinkClicked">            <TextBlock Text="{Binding resources.L_ReportMissingBusiness_Text}" />        <\/a>    <\/div><\/div>',uf='<div class="bm_svrpagination">    <ul>        <li>            <a href="#" class="bm_leftChevron" aria-label="{Binding resources.PaginationPreviousLabelText}" event:click="leftChevronClicked" style:display="{Binding showLeftChevron Converter=boolToDisplay}"><\/a>        <\/li>        <li>            <a href="#" class="bm_rightChevron" aria-label="{Binding resources.PaginationNextLabelText}" event:click="rightChevronClicked" style:display="{Binding showRightChevron Converter=boolToDisplay}"><\/a>        <\/li>    <\/ul><\/div>',ff='<div class="bm_upcomingEventsRoot" data-tag="upcomingEvents">    <div class="infoIcon" event:mouseover="onInfoHovered" event:mouseout="onInfoExited"><\/div>    <div class="upcomingEventPopUp popOutTop" style:display="{Binding ShowPopUp Converter=boolToDisplay}">        <TextBlock Text="{Binding resources.L_EventInfoMessage}" />    <\/div>    <ItemsControl ItemsSource="{Binding Events}">        <ItemsControl.ItemTemplate>            <DataTemplate>                <div style:display="{Binding eventIndex Converter=initiallyHideOtherFlights}">                    <hr class="collectionSeparator flightSeparator" style:display="{Binding eventIndex Converter=displayAfterFirst}" />                    <div class="hotelEventDetails" style:display="{Binding type Converter=hotelToDisplay}">                        <h2>                            <TextBlock Text="{StaticBinding resources.L_ReservationTitle}" />                        <\/h2>                        <div class="checkInDetails">                            <div class="checkInTitle">                                <TextBlock Text="{StaticBinding resources.L_CheckInText}" />                            <\/div>                            <div class="checkInTime">                                <TextBlock Text="{Binding startDate Converter=getTimeString}" />                            <\/div>                        <\/div>                        <div class="checkOutDetails">                            <div class="checkOutTitle">                                <TextBlock Text="{StaticBinding resources.L_CheckOutText}" />                            <\/div>                            <div class="checkOutTime">                                <TextBlock Text="{Binding endDate Converter=getTimeString}" />                            <\/div>                        <\/div>                        <div class="seeEmailContainer" style:display="{Binding emailLink Converter=nullToDisplayNone}">                            <a class="seeEmailLink" href="{Binding emailLink}" target="_blank">                                <TextBlock Text="{StaticBinding resources.L_SeeEmailLinkText}" />                            <\/a>                        <\/div>                    <\/div>                    <div class="flightEventDetails" style:display="{Binding type Converter=flightToDisplay}">                        <h2 style:display="{Binding eventIndex Converter=hideAfterFirst}">                            <TextBlock Text="{StaticBinding resources.L_FlightTitle}" />                        <\/h2>                        <div class="airlineDetails">                            <TextBlock Text="{Binding $self$ Converter=getAirlineDetails}" />                        <\/div>                        <div class="departureDetails">                            <div class="departureAirport">                                <TextBlock Text="{StaticBinding resources.L_DepartureText}" />                                <a class="airportLink" data-task="{Binding departureAirport.entity Converter=buildEventDataTaskAttribute}" style:display="{Binding departureAirport.entity.businesslistingid Converter=hideIfEntity}" href="#">                                    <TextBlock Text="{Binding departureAirport.entity Converter=getAirportText}" />                                <\/a>                                <div class="airportText" style:display="{Binding departureAirport.entity.businesslistingid Converter=displayIfEntity}">                                    <TextBlock Text="{Binding departureAirport.entity Converter=getAirportText}" />                                <\/div>                            <\/div>                            <div class="departureTime">                                <TextBlock Text="{Binding startDate Converter=getTimeString}" />                            <\/div>                        <\/div>                        <div class="arrivalDetails">                            <div class="arrivalAirport">                                <TextBlock Text="{StaticBinding resources.L_ArrivalText}" />                                <a class="airportLink" data-task="{Binding arrivalAirport.entity Converter=buildEventDataTaskAttribute}" style:display="{Binding arrivalAirport.entity.businesslistingid  Converter=hideIfEntity}" href="#">                                    <TextBlock Text="{Binding arrivalAirport.entity Converter=getAirportText}" />                                <\/a>                                <div class="airportText" style:display="{Binding arrivalAirport.entity.businesslistingid Converter=displayIfEntity}">                                    <TextBlock Text="{Binding arrivalAirport.entity Converter=getAirportText}" />                                <\/div>                            <\/div>                            <div class="arrivalTime">                                <TextBlock Text="{Binding endDate Converter=getTimeString}" />                            <\/div>                        <\/div>                        <div class="seeEmailContainer" style:display="{Binding emailLink Converter=nullToDisplayNone}">                            <a class="seeEmailLink" href="{Binding emailLink}" target="_blank">                                <TextBlock Text="{StaticBinding resources.L_SeeEmailFlightLinkText}" />                            <\/a>                        <\/div>                    <\/div>                <\/div>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="showMoreFlights" style:display="{Binding ShowOtherFlights Converter=showMoreFlightButton}">        <hr class="collectionSeparator flightSeparator" />        <a class="showMoreLink" event:click="onExpandClick" href="#">            <TextBlock Text="{StaticBinding resources.L_SeeMoreFlightsText}" />        <\/a>    <\/div><\/div>',sr='<div>    <div class="bm_filtersBarModule"><\/div>    <ItemsControl ItemsSource="{Binding entities}" PanelTagName="div" class="bm_venueDirectory">        <ItemsControl.ItemTemplate>            <DataTemplate>                <div class="bm_venueEntity" data-task="{Binding taskInfo}" event:click="onBusinessClick" event:mouseover="onBusinessMouseOver" event:mouseout="onBusinessMouseOut">                    <div class="bm_venueEntityWrapper">                        <div class="bm_entityDetails">                            <div class="bm_localName">                                <TextBlock Text="{Binding name}"><\/TextBlock>                            <\/div>                            <div class="bm_phoneNumber">                                <TextBlock Text="{Binding phoneNumber}"><\/TextBlock>                            <\/div>                            <div class="bm_floorName">                                <TextBlock Text="{Binding floorName}"><\/TextBlock>                            <\/div>                        <\/div>                    <\/div>                    <div class="bm_entityDivider"><\/div>                <\/div>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="bm_noEntityMessage">    <\/div><\/div>',hr='<div>    <ItemsControl ItemsSource="{Binding entities}" PanelTagName="div" id="bm_venueDirectory">        <ItemsControl.ItemTemplate>            <DataTemplate>                <div class="card bm_venueEntity" data-task="{Binding taskInfo}" event:click="onBusinessClick" event:mouseover="onBusinessMouseOver" event:mouseout="onBusinessMouseOut">                    <div id="bm_venueEntityWrapper">                        <div class="textContainer" id="bm_entityDetails">                            <div class="title bm_localName">                                <TextBlock Text="{Binding name}"><\/TextBlock>                            <\/div>                            <div class="subtitle" id="bm_phoneNumber">                                <TextBlock Text="{Binding phoneNumber}"><\/TextBlock>                            <\/div>                            <div class="notes" id="bm_floorName">                                <TextBlock Text="{Binding floorName}"><\/TextBlock>                            <\/div>                        <\/div>                    <\/div>                    <div id="bm_entityDivider"><\/div>                <\/div>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="bm_noEntityMessage">    <\/div><\/div>',v=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),cr=function(n){function o(i,r,u,f,e,o){var s=this,h={};return s=n.call(this,h)||this,h.defineProperty("currentName"),h.defineProperty("originalName"),h.defineProperty("description"),h.defineProperty("tempAnnotation"),h.defineProperty("isHomeWork"),h.defineProperty("showDropdown",function(n,t){return s._onShowPopOutChanged(n,t)}),h.defineProperty("showNickNameEdit",function(n,t){return s._onShowPopOutChanged(n,t)}),h.defineProperty("showDescriptionEdit",function(n,t){return s._onShowPopOutChanged(n,t)}),s.controlTemplateFactory=i,s._templateName=du,s.disposables=[],s.annotationChanged=new g,s.setCurrentName(f),s.setIsHomeWork((f==="Home"||f==="Work")&&f!==e),s.setOriginalName(e?e:f),s.setDescription(o),s.setShowDropdown(!1),s.setShowNickNameEdit(!1),s.setTempAnnotation(""),s.resources=t,s._map=r,s._isAddress=u,s._windowClickEventHandler=function(n){var t=s._control,i=t.select(".nickNamePopOut"),r=t.select(".descriptionPopOut");i&&i.has(n.target)||r&&r.has(n.target)||(s._hideDropdown(n),s._hideDescriptionPopOut(n),s._hideNickNamePopOut(n))},s._windowKeyupEventHandler=function(n){var r=n,i,t;if(r.keyCode===9){if(i=document.activeElement,t=i&&i.classList,i&&(t.contains("annotateEntry")||t.contains("nickNamePopOut")||t.contains("descriptionPopOut")||t.contains("nameEditBox")||t.contains("descriptionEditBox")||t.contains("annotationAddButton")||t.contains("annotateClose")))return;s._hideDropdown(n);s._hideDescriptionPopOut(n);s._hideNickNamePopOut(n)}},s}return v(o,n),o.prototype.boolToDisplay=function(n){return n?"":"none"},o.prototype.boolToNotDisplay=function(n){return n?"none":""},o.prototype.displayIfDifferentName=function(n){return n===this.getOriginalName()?"none":""},o.prototype.displayDeleteNickName=function(n){return n===this.getOriginalName()||this.getIsHomeWork()?"none":""},o.prototype.displayNameChangeMessage=function(n){return n===this.getOriginalName()?this.resources.L_AddNickNameOption:this.resources.L_EditNickNameOption},o.prototype.displayNoteChangeMessage=function(n){return n?this.resources.L_EditNoteOption:this.resources.L_AddNoteOption},o.prototype.showAddEditNameButton=function(n){return n===this.getOriginalName()?this.resources.L_AddButton:this.resources.L_EditButton},o.prototype.showAddEditNoteButton=function(n){return n?this.resources.L_EditButton:this.resources.L_AddButton},o.prototype.getControl=function(){if(!this._control){if(!this.controlTemplateFactory)throw"control template factory must be defined.";var n=this.controlTemplateFactory({templateText:this._templateName,staticResources:this});this._control=n.applyDataTemplate(this);this.disposables.push(n)}return this._control},o.prototype.dispose=function(){for(var n=0;n<this.disposables.length;n++)this.disposables[n].dispose();this.disposables=[]},o.prototype.onAnnotateClick=function(n){this.setShowDropdown(!0);Microsoft.Maps.setTimeout(function(){var n=i(".bm_annotationRoot"),t=i(".annotateDropdown ",n[0]);r._setFocusOnFirstMenuItem(t)},100);this._logInstrumentation("Annotate");n.stopPropagation();n.preventDefault()},o.prototype.onAddNicknameClick=function(n){this.setShowDropdown(!1);this.getCurrentName()!==this.getOriginalName()&&this.setTempAnnotation(this.getCurrentName());this.setShowNickNameEdit(!0);var t=i(".nameEditBox",this._control[0]);t&&t.length&&t[0].focus();this._logInstrumentation("EditNickName");n.stopPropagation();n.preventDefault()},o.prototype.onAddDescriptionClick=function(n){var r,t;this.setShowDropdown(!1);r=this.getDescription();r&&this.setTempAnnotation(r);this.setShowDescriptionEdit(!0);t=i(".descriptionEditBox",this._control[0]);t&&t.length&&(t[0].value=this.getTempAnnotation());t&&t.length&&t[0].focus();this._logInstrumentation("EditNotes");n.stopPropagation();n.preventDefault()},o.prototype.onDeleteNicknameClick=function(n){this.setShowDropdown(!1);this.setCurrentName(this.getOriginalName());this.setTempAnnotation("");this.annotationChanged.invoke();this._logInstrumentation("DeleteNickName");n.stopPropagation();n.preventDefault()},o.prototype.onDeleteDescriptionClick=function(n){this.setShowDropdown(!1);this.setDescription(null);this.setTempAnnotation("");var t=i(".descriptionEditBox",this._control[0]);t&&t.length&&(t[0].value="");this.annotationChanged.invoke();this._logInstrumentation("DeleteNotes");n.stopPropagation();n.preventDefault()},o.prototype.onSaveNickNameClick=function(n){this.setShowNickNameEdit(!1);var t=this.getTempAnnotation().trim();t&&(this.setCurrentName(t),this.setTempAnnotation(""),this.annotationChanged.invoke());this._logInstrumentation("SaveNickName");n&&n.stopPropagation();n&&n.preventDefault()},o.prototype.onSaveDescriptionClick=function(n){this.setShowDescriptionEdit(!1);this.setDescription(this.getTempAnnotation());this.setTempAnnotation("");this.annotationChanged.invoke();this._logInstrumentation("SaveNotes");n&&n.stopPropagation();n&&n.preventDefault()},o.prototype.onCloseClick=function(n){this.setShowDescriptionEdit(!1);this.setShowNickNameEdit(!1);this.setTempAnnotation("");var t=i(".descriptionEditBox",this._control[0]);t&&t.length&&(t[0].value="");n.stopPropagation();n.preventDefault()},o.prototype.onKeyPressName=function(n){if(n.keyCode===13)this.onSaveNickNameClick(null)},o.prototype.onKeyPressNote=function(n){if(n.keyCode===13&&!n.shiftKey){var t=i(".descriptionEditBox",this._control[0]);t&&t.length&&t[0].blur();this.onSaveDescriptionClick(null)}},o.prototype.addAuxillaryButton=function(n){var t=this.getControl().select(".auxillaryButtons"),i;t&&t.length>0&&(i=t.select("a"),i&&i.length>0&&t.insertBefore(n,i))},o.prototype._onShowPopOutChanged=function(n,t){var u=this,r=i(window);t?Microsoft.Maps.setTimeout(function(){r.add_event("click,contextmenu",u._windowClickEventHandler);r.add_event("keyup",u._windowKeyupEventHandler)},1):n&&(r.remove_event("click,contextmenu",this._windowClickEventHandler),r.remove_event("keyup",this._windowKeyupEventHandler))},o.prototype._hideDropdown=function(){this.getShowDropdown()?this.setShowDropdown(!1):(i(window).remove_event("click,contextmenu",this._windowClickEventHandler),i(window).remove_event("keyup",this._windowKeyupEventHandler))},o.prototype._hideNickNamePopOut=function(){this.getShowNickNameEdit()?this.setShowNickNameEdit(!1):(i(window).remove_event("click,contextmenu",this._windowClickEventHandler),i(window).remove_event("keyup",this._windowKeyupEventHandler))},o.prototype._hideDescriptionPopOut=function(){this.getShowDescriptionEdit()?this.setShowDescriptionEdit(!1):(i(window).remove_event("click,contextmenu",this._windowClickEventHandler),i(window).remove_event("keyup",this._windowKeyupEventHandler))},o.prototype._logInstrumentation=function(n){var t={AN:n,EP:u.LocalDetails},i={logData:{feature:w.DetailsCard,action:h.Clicked,data:t}};e.invokeHandler(f.instrumentationDataHandlerKey,i)},o}(kt),lr=function(){function n(){}return n}(),ef=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return v(t,n),t}(lr),of=function(){function u(){}return u.RequestDetailPopouts=function(t){if(t&&t[1]&&t[2]){var i=t[1],r=t[2],f=n.locationFilterAjaxEndpoint+i;sj_ajax(f,{callback:function(n,t){if(n&&t!==null&&t.request!==null&&t.request.responseText!==null&&t.request.responseText!==""){var i=JSON.parse(t.request.responseText);i&&u.CreateDetailPopouts(i,r)}}})}},u.CreateDetailPopouts=function(n,u){var e,p,b,c,f,s,w,k,o,l,a,v;if(n!==null&&u!==null){e=[];n.Neighborhoods&&n.Neighborhoods.length>0&&(e=e.concat(n.Neighborhoods));n.PointsOfInterest&&n.PointsOfInterest.length>0&&(e=e.concat(n.PointsOfInterest));n.Transportation&&n.Transportation.length>0&&(e=e.concat(n.Transportation));var h=i("#"+u),d=n.MapUrl,y=h.select("#ftrD_Location .catfOption");if(h&&h.length!==0&&d&&y&&y.length!==0)for(p=h.select("#ftrD_Location"),b=p.getParent().getParent(),c=0;c<e.length;c++)if(f=e[c],f.Location){s=r._createElement("div").add_class("b_htlLocInfo");s.append(r._createElement("img").add_class("b_locMap").set_attr("src",this.getStaticMapUrl(f.Location.Latitude,f.Location.Longitude,n.MapUrl)));w=r._createElement("div").add_class("b_htlLocTitle");k=t.HotelsFound+"<span>"+(f.NearbyHotelCount>100?"100+":f.NearbyHotelCount)+"<\/span>"+t.HotelsNear+f.Name;w.appendHTML(k);s.append(w);o=[];f.PriceTrend===0?o.push(t.HotelPricesHere+"<span class=b_htlGood>"+t.HotelPricesWithin+"<\/span>"+t.HotelWithinCityAverage):f.PriceTrend>1?o.push(t.HotelPricesHere+"<span class=b_htlNeutral>"+Math.round((f.PriceTrend-1)*100)+"%"+t.HotelPricesExpensive+"<\/span>"+t.HotelCityAverage):o.push(t.HotelPricesHere+"<span class=b_htlGood>"+Math.round((1-f.PriceTrend)*100)+"%"+t.HotelPricesCheaper+"<\/span>"+t.HotelCityAverage);f.Distance===0?o.push(t.HotelThisLocation+"<span class=b_htlGood>"+t.HotelNear+"<\/span>"+t.HotelCityCenter):o.push("<span>"+f.Distance+"<\/span>"+t.HotelDistanceFromCityCenter);l="b_htlNeutral";a=t.HotelSafetyNeutral;switch(f.CrimeIndex){case 1:case 2:l="b_htlExcellent";a=t.HotelSafetyExcellent;break;case 3:l="b_htlGood";a=t.HotelSafetyGood}for(o.push(t.HotelAreaSafety+"<span class="+l+">"+a+"<\/span>"),v=0;v<o.length;v++)s.append(r._createElement("div").add_class("b_htlLocData").appendHTML(o[v]));s.append(r._createElement("p").appendText(f.Description));this.attachPopoutEvents(s,y,b,p,f.Id)}}},u.attachPopoutEvents=function(n,t,r,u,f){for(var e=null,o=0;o<t.length;o++)if(t[o].getAttribute("data-filterparam").indexOf(f)>=0){e=i(t[o]);break}e&&(e.add_event("mouseover",function(){var i=window.innerHeight,f=window.innerWidth,t;n.set_style({"z-index":7,left:e[0].offsetLeft+e[0].offsetWidth-150,top:e[0].offsetTop-u[0].scrollTop-32});r.append(n);n[0].getBoundingClientRect().right>f&&(n[0].style.left=(e[0].offsetLeft-n[0].offsetWidth-150).toString()+"px");t=n[0].getBoundingClientRect().bottom-i;t>0&&(n[0].style.top=(e[0].offsetTop-u[0].scrollTop-50-t).toString()+"px")}),e.add_event("mouseout",function(){r.select(".b_htlLocInfo").removeFromParent()}))},u.getStaticMapUrl=function(n,t,i){return i+("&da=ro&ml=Basemap,Landmarks,OsmBuildings&ms=300,150&pushpin="+n+","+t+";176;1")},u}();sj_evt.bind("AttachLocFilterPopouts",of.RequestDetailPopouts);var so=[new bt("RestaurantPrice","bm_Price",t.L_FilterName_Price,2,1).addAllOptions([1,2,3,4].map(function(n){for(var i="",r=0;r<n;r++)i=i.concat(t.L_FiltersBar_Price_Unit);return new ct(n.toString(),i,"RestaurantPrice_RPrice"+(n+1))})),new bt("HotelStarRating","bm_Rating",t.L_FilterName_Rating,1,2,function(n){return r._formatString(t.L_FiltersBar_HotelRating_SelectionLabel,n.getSelectedOptions().map(function(n){return n.value}).join(", "))}).addAllOptions([2,3,4].map(function(n){return new ct(n.toString(),t.L_FiltersBar_HotelRating_OptionSuffix,"UserRating_URating"+(2*n-1)+"Up")})).addOption(new ct("5","","UserRating_URating9Up")),new bt("CuisineCategory","bm_Cuisine",t.L_FilterName_Cuisine,2,0).addAllOptions(["91210","91216","91221","91223","91225","91229","91238"].map(function(n){return new ct(n,t["L_FiltersBar_Cuisine_"+n],"CuisineCategory_"+n)}))],ar=function(n){function t(t,i){var r=this,u={};return r=n.call(this,u,i,gu)||this,u.defineProperty("geochainSegments"),r.setGeochainSegments(t),r}return v(t,n),t}(wt),ai=function(n){function i(i){var r=n.call(this,i.getTitle(),i.getAddress(),i.id,i.getLocation(),i.getRoutableLocation(),i.getMenuUrl(),i.getImageUrl(),i.entitySource,i.getPrimaryCategoryPath(),i.getPrimaryCategoryName(),i.getVdpId(),i.getLocationType(),i.getDateTime())||this;return i.getPhone()&&n.prototype.setPhone.call(r,i.getPhone()),i.getWebsite()&&n.prototype.setWebsite.call(r,i.getWebsite()),r.factData=null,r.factLabel=null,r.colorIndex=null,r.resources=t,r}return v(i,n),i.prototype.hideIfMatchedData=function(n){var t=n;return t===null||this.getTitle()===t?"none":""},i.prototype.nullToDisplayNone=function(n){return n?"":"none"},i}(hi),ho=function(n){function s(i,r,u,f){var e=this,o={};return e=n.call(this,o)||this,o.defineProperty("events"),o.defineProperty("showPopUp"),o.defineProperty("showOtherFlights"),e.controlTemplateFactory=i,e._templateName=ff,e.disposables=[],e.resources=t,e._map=r,e._id=f,e.setEvents(u),e._logEventShownInstrumentation(),e}return v(s,n),s.prototype.boolToDisplay=function(n){return n?"":"none"},s.prototype.boolToNotDisplay=function(n){return n?"none":""},s.prototype.nullToDisplayNone=function(n){return n?"":"none"},s.prototype.hotelToDisplay=function(n){return n==="Events.HotelEvent"?"":"none"},s.prototype.flightToDisplay=function(n){return n==="Events.FlightEvent"?"":"none"},s.prototype.getTimeString=function(n){if(n){var t=r._formatLongDateString(n),i=r._formatTimeString(n);return"{0}, {1}".replace("{0}",t).replace("{1}",i)}return""},s.prototype.getAirportText=function(n){return n?this.resources.L_AirportFormat.replace("{0}",n.city).replace("{1}",n.airportCode):""},s.prototype.getAirlineDetails=function(n){return n?this.resources.L_AirlineFormat.replace("{0}",n.airline).replace("{1}",n.reservationId):""},s.prototype.initiallyHideOtherFlights=function(n){return!this.getShowOtherFlights()&&n>0?"none":""},s.prototype.displayAfterFirst=function(n){return n>0?"":"none"},s.prototype.hideAfterFirst=function(n){return n>0?"none":""},s.prototype.hideIfEntity=function(n){return n===this._id?"none":""},s.prototype.displayIfEntity=function(n){return n===this._id?"":"none"},s.prototype.showMoreFlightButton=function(n){var t=this.getEvents();return!n&&t&&t[0]&&t[0].type==="Events.FlightEvent"&&t.length>1?"":"none"},s.prototype.onExpandClick=function(n){this.setShowOtherFlights(!0);var t=this.getEvents();this.setEvents([]);this.setEvents(t);n.preventDefault();n.stopPropagation()},s.prototype.onInfoHovered=function(){this.setShowPopUp(!0)},s.prototype.onInfoExited=function(){this.setShowPopUp(!1)},s.prototype.buildEventDataTaskAttribute=function(n){var t=o.CloudGraphDataManager.CollectionEntity.buildEntityDataTaskOptions(n);return t.state.taskTitle="",t.activateOptions={},i.Internals.stringify(t)},s.prototype.getControl=function(){if(!this._control){if(!this.controlTemplateFactory)throw"control template factory must be defined.";var n=this.controlTemplateFactory({templateText:this._templateName,staticResources:this});this._control=n.applyDataTemplate(this);this.disposables.push(n)}return this._control},s.prototype.dispose=function(){for(var n=0;n<this.disposables.length;n++)this.disposables[n].dispose();this.disposables=[]},s.prototype._logEventShownInstrumentation=function(){var n={AN:"UE",EP:u.LocalDetails},t={logData:{feature:w.DetailsCard,action:h.Activated,data:n}};e.invokeHandler(f.instrumentationDataHandlerKey,t)},s}(kt),nt;(function(n){n[n.ID=0]="ID";n[n.SB=1]="SB"})(nt||(nt={})),function(n){n[n.STP=0]="STP";n[n.LLT=1]="LLT";n[n.LDT=2]="LDT";n[n.LDA=3]="LDA";n[n.LLR=4]="LLR";n[n.LSR=5]="LSR";n[n.RAP=6]="RAP";n[n.MBR=7]="MBR";n[n.FLBK=8]="FLBK"}(p||(p={}));var vr=function(){function n(n){this._perfLogger=n}return n.prototype.perfStart=function(n){if(nt[n]){var t=ft.Search+"_"+nt[n];return this._perfLogger.start(t)}return null},n.prototype.log=function(n,t,i){var r={impressionGuid:i,logData:{feature:ft.Search,action:p[n],data:t}};e.invokeHandler(f.instrumentationDataHandlerKey,r)},n.prototype.getMarketFromBingPlacesUrl=function(n){var r=n&&n.select("div.wpc_sfl")[0],u=r&&r.lastElementChild,f=u&&u.href,t=f&&f.split("market="),i=t&&t.length>1?t[1].split("&"):null;return i&&i.length>0?i[0]:""},n}(),yr=function(){function u(n,t,i,r,u,f,e){var s=this,h,o;this.map=n;this.panelRoot=t;this._logHelper=i;this._selector=r;this._attributeName=u;this._pushpins=[];this._entities=[];this._eventHandlers=[];this._transientLensViewModel=f;this._transientLensViewModel&&this._transientLensViewModel.initializeCollections();this.landMarkFilterRule=null;h=y.features.taskFramework;this.changed=new g;this.titleChanged=new g;this.catIdPopulated=new g;this.catIdPopulated.add(function(){return s._assignEntitySearchCategory()});e&&e.selectedCategoryId&&(o=e.selectedCategoryId);this.populateCardCategoryId(o)}return u.getSuggestionIconColor=function(){return r._isHighContrastMode()?u._highContrastSuggestionIconColor:u._suggestionIconColor},u.prototype.selectorReady=function(){var n=this;return this._baseMapTemplateSelector?this._baseMapTemplateSelector.selectorReady():this.map.getTemplateSelector().then(function(t){return n._baseMapTemplateSelector=t,n._baseMapTemplateSelector.selectorReady()})},u.prototype.dispose=function(){this.clear();this._transientLensViewModel.dispose()},u.prototype.setResponseContent=function(t,u){var e,o,f,s;t&&(this.clear(),this.panelRoot&&(this.panelRoot.clear(),this.parseEntitiesFromResponse(t,u),this._parseLandMarkMetaData(t),this._parseCategoryData(t),e=!0,n.showContentFirstForPermalinks&&(o=i(".cardPrimer"),f=i(".cardPrimer .contentRoot"),f&&f.length>0&&f[0].children.length>0&&(u.isFallbackRequery||(this.panelRoot.append(i(f[0].children[0])),e=!1)),o&&o.removeFromParent()),e&&(s=t.length>0&&t[0].innerHTML,s?this.panelRoot.appendHTML(s):this.panelRoot.append(t)),this._forceImageRedrawForEdge()),u&&(u.originIG=u.originIG||l.getImpressionGuid(this.panelRoot),u.localFilters=r._decodeHTML(t.select("div.bm_filterBar").get_attr("fp"))))},u.prototype.getResponseContainer=function(){return this.panelRoot},u.prototype.getCardCategoryId=function(){return this._cardCategoryId},u.prototype.getPushpinPrimitives=function(){return this._pushpins},u.prototype.clearPushpinPrimitives=function(){this._pushpins=[]},u.prototype.UpdatePrimitiveState=function(n,t){for(var u,r=!1,i=0,f=this._pushpins.length;i<f;i++)if(this._pushpins[i].entity.id===n){if(u=this._pushpins[i].entity,u&&u.isApproximateLocation)return r;this._pushpins[i].viewState=t;this._pushpins[i].revision=(this._pushpins[i].revision||0)+1;r=!0;break}return r},u.prototype.getEntities=function(){return this._entities},u.prototype.parseEntitiesFromResponse=function(n,t){var r=this,u=n.select(this._selector);return u.for_each(function(u){var f=u.getAttribute(r._attributeName),e;f&&(e=i.Internals.parseJSON(f),r.processEntity(e,n,t,!1))}),this._entities},u.prototype.processEntity=function(n,t,i,r){var u,v,h,s,c;if(!n)return null;if(u=n.entity,!u&&i&&(u={title:i.query}),u&&!u.title&&i&&(u.title=i.query),u&&u.title){var l=n.geometry,a=n.routablePoint,e=null,o=null;if(l&&(e=new b(l.y,l.x)),a&&(o=new b(a.latitude,a.longitude)),e||(e=o),o||(o=e),e&&o){var p=i&&i.directionsTaskId!=null,y=p?1:0,w=new ti,f=w.getIsSignedIn()?new bi(u.title,u.address,u.id,e,o,u.menuUrl,u.imageUrl,y,u.primaryCategoryPath,u.primaryCategoryName,u.vdpId,u.locationType,u.startDateTime,u.endDateTime,u.utcOffset,u.isAllDayEvent,u.segmentTypes):new hi(u.title,u.address,u.id,e,o,u.menuUrl,u.imageUrl,y,u.primaryCategoryPath,u.primaryCategoryName,u.vdpId,u.locationType,u.startDateTime,u.endDateTime,u.utcOffset,u.isAllDayEvent,u.segmentTypes);return(u.phone&&f.setPhone(u.phone),u.website&&f.setWebsite(u.website),u.subtitle&&(f.subtitle=u.subtitle),u.iconText&&(f.iconText=u.iconText),u.isUpHierarchy&&(f.isUpHierarchy=!0),u.isApproximateLocation&&(f.isApproximateLocation=!0),u.usePricePoi&&(f.usePricePoi=!0),u.badgeType&&(f.badgeType=u.badgeType),u.infoboxHtml&&(f.infoboxHtml=u.infoboxHtml),u.disablePoiLabel&&(f.disablePoiLabel=!0),v=u.chainId,v&&f.setChainId(v),t&&this._updateEntityState(t,f),h=null,f.subtitle&&f.subtitle.indexOf("useastitle:")>-1&&(f.subtitle=f.subtitle.replace("useastitle:",""),f.subtitle&&f.subtitle.length>0&&(h=f.clone(),h.setTitle(f.subtitle),h.subtitle=null)),s=new ci(e,h!==null?h:f),s.entity.poiType=1,f.isApproximateLocation&&(s.viewState=3),u.isPermanentlyClosed&&(f.isPermanentlyClosed=!0),r&&(c=this._findPushpin(f.id),c>0))?(this._pushpins[c]=s,this._entities[c]=f,s):(this._pushpins.push(s),this._entities.push(f),s)}}return null},u.prototype._findPushpin=function(n){for(var t=0;t<this._pushpins.length;t++)if(this._pushpins[t].entity&&this._pushpins[t].entity.id===n)return t;return-1},u.prototype.updateAdvertising=function(){},u.prototype.processDirectionsData=function(){},u.prototype.processCollectionsData=function(){},u.prototype.processTravelData=function(){},u.prototype.boolToDisplay=function(n){return n?"":"none"},u.prototype.nullToDisplayNone=function(n){return n?"":"none"},u.prototype.hideIfMatchedData=function(n){return n===null||this.getEntities()[0].getTitle()===n?"none":""},u.prototype.emptyToDisplayNone=function(n){return n&&n.length?"":"none"},u.prototype._updateEntityState=function(){},u.prototype._addEventsToEventList=function(n,t,i){this._eventHandlers.push({item:n,eventName:t,handler:i})},u.prototype.clear=function(){this._pushpins=[];this._entities=[];this._eventHandlers.forEach(function(n){n.item.remove_event(n.eventName,n.handler)});this._eventHandlers=[]},u.prototype._parseLandMarkMetaData=function(n){var r=n.select("div[data-landmark]"),u,t;if(r.length==1&&(u=r[0],t=u.getAttribute("data-landmark"),t)){var f=i.Internals.parseJSON(t),s=f.type,e=[],o=[];f.value.forEach(function(n){e.push(n.CategoryID);o.push(n.Percentage)});this.landMarkFilterRule={field:s,value:e,distribution:o}}},u.prototype.parseSuggestionMetaData=function(){var r=this.panelRoot.select("div[data-suggestions]"),u,n,f,t;return r.length!=1?null:(u=r[0],n=u.getAttribute("data-suggestions"),!n)?null:(f=i.Internals.parseJSON(n),t=[],f.forEach(function(n){var i=[];n.viewport&&n.viewport.length>1&&!isNaN(n.viewport[0].latitude)&&!isNaN(n.viewport[0].longitude)&&!isNaN(n.viewport[1].latitude)&&!isNaN(n.viewport[1].longitude)&&(i.push(new b(n.viewport[0].latitude,n.viewport[0].longitude)),i.push(new b(n.viewport[1].latitude,n.viewport[1].longitude)));t.push({Name:n.name,Id:n.categoryId,viewport:i})}),t)},u.prototype._drawCategoryItem=function(n,t,i,u,f){var o;f===void 0&&(f=!1);var s=t.Name,c=t.Id,h=r._createElement("li"),e=r._createElement("a");return e.set_attr("class","searchNearbySuggestionLinkIcon"),o=r._createElement("div"),o.set_attr("class","suggestionIconBound"),e.add_event("click",u),this._addEventsToEventList(e,"click",u),e.set_attr("data-tag",i+"."+s),e.set_attr("title",s),e.set_attr("href","#"),e.append(o),h.append(e),n.getCategoryIconTemplate(function(n){var r=n&&n.icon,i;r&&(i=r.renderIcon(),i.set_attr("title",s),i.set_attr("alt",s),o.append(i),f&&o.appendText(t.Name))},c,null,25,25),h},u.prototype._parseCategoryData=function(){},u.prototype.populateCardCategoryId=function(n){var t=this;n===""?(this.categoryFound=!1,this.catIdPopulated.invoke()):n?this.map.getTemplateSelector().then(function(){var i=yi.extractCategoryId(n,!1);i&&(t._cardCategoryId=i,t.changed.invoke());t.categoryFound=typeof t._cardCategoryId!="undefined";t.catIdPopulated.invoke()}):this.catIdPopulated.invoke()},u.prototype.addReportLinkToNoResultCard=function(n,i,u){var w=this,a,s,f,h,v,e,y,p,o,c,b,l,k;n.select("div[data-answerinfo]").length>0&&(a=n.select("div[data-answerinfo]"),a.get_attr("data-answerinfo")==="0"&&(s=r._createElement("p"),f=r._createElement("a"),f.set_text(t.L_Menu_ReportProblem_Link_Text),f.set_attr("href","#"),f.set_attr("data-tag","reportProblemLink"),f.set_attr("class","reportProblemLink"),h=r._createElement("div"),h.set_attr("class","reportProblemLinkWrapper"),h.append(f),s.append(h),v=a.select(".query"),e=v.length>0?v[0].textContent:"",e=e||u&&u.query,y=this.getUserFacts(),st&&st.showAddMissingBusinessLink&&!this._houseIntentFound(u)&&(p=r._createElement("span"),p.set_attr("class","reportProblemLinkSeparator"),s.append(p),o=r._createElement("a"),o.set_text(t.L_ReportMissingBusiness_Text),o.set_attr("href","#"),o.set_attr("class","reportProblemLink"),c=r._createElement("div"),c.set_attr("class","reportProblemLinkWrapper"),c.append(o),s.append(c),b=function(n){return w.onAddMissingBusinessLinkClicked(n,i,e,e,y,1)},o.add_event("click",b)),l=this.panelRoot.select(".errmsg"),l.append(r._createElement("br")),l.append(s),l.append(r._createElement("br")),k=function(n){return w._onReportProblemLinkClick(n,i,e,e,y)},f.add_event("click",k)))},u.prototype.onAddMissingBusinessLinkClicked=function(n,i,r,u,o,h){if(n.preventDefault(),st&&st.showAddMissingBusinessLink){var c={AN:"RapEntryPoints#"+h.toString()};this._logHelper&&this._logHelper.log(p.MBR,c);e.invokeHandler(f.taskDataHandlerKey,{type:s.feedbackTask,state:{entryPoint:3,feedbackTaskType:6,title:t.L_AddMissingBusinessCardTitle,activeTaskId:i,options:{dataFacts:{parentId:i},reportType:1,noFoundType:2,userFacts:o,rapEntryPoint:h}}})}},u.prototype._houseIntentFound=function(n){if(n){if(n.searchQueryCategory&&r._isHouseCategory(n.searchQueryCategory))return!0;if(n.categoryLayers&&n.categoryLayers.length)for(var t=0;t<n.categoryLayers.length;t++)if(n.categoryLayers[t]&&r._isHouseCategory(n.categoryLayers[t]))return!0}return!1},u.prototype._onReportProblemLinkClick=function(n,t,i,r,u){n.preventDefault();this._logHelper&&this._logHelper.log(p.RAP,{AN:"RapEntryPoints#2"});e.invokeHandler(f.taskDataHandlerKey,{type:s.feedbackTask,activateOptions:{parentId:t},state:{entryPoint:3,feedbackTaskType:3,title:i,activeTaskId:t,options:{query:r,reportType:1,userFacts:u,rapEntryPoint:2}}})},u.prototype._forceImageRedrawForEdge=function(){var n=this;i.Browser.is_edge&&Microsoft.Maps.setTimeout(function(){for(var u=n.panelRoot.select(".irpserp img, .cico img"),t=0,o=u.length;t<o;t++){var r=u[t],f=r,e=function(n){i([n.srcElement]).set_style({outline:"0px solid white"});n.srcElement.removeEventListener("load",e)};f&&!f.complete?r.addEventListener("load",e):i([r]).set_style({outline:"0px solid white"})}},0)},u.prototype._assignEntitySearchCategory=function(){var t=this.getCardCategoryId(),n=this.getEntities();t&&n&&n.length&&n.forEach(function(n){return n.setSearchCategory(t)})},u.prototype.getUserFacts=function(){var n=null,t=this.panelRoot.select("div[data-ufacts]").get_attr("data-ufacts");if(t)try{n=JSON.parse(t)}catch(i){}return n},u._suggestionIconColor="rgb(96,96,96)",u._highContrastSuggestionIconColor="rgb(255,255,0)",u}(),fi=function(c){function a(r,u,f,e,o,s,h,l,v,p){var w=c.call(this,r,u,e,"div.overlay-taskpane","data-entity",o,l)||this,b,k,d,g;if(w._preProcessLinks=function(n){var t,i,r;try{if(sj_evt.unbind("accordionAjaxResponse",w._preProcessLinks),n&&n.length>1)for(t=n[1],i=0;i<t.length;i++)r=t[i],r&&r.tagName==="DIV"&&w._handleExternalLinks(r)}finally{sj_evt.fire("accordionProcessed",t)}},w._handleExternalLinks=function(n){for(var i,r,u=n.getElementsByTagName("a"),t=0;t<u.length;t++)i=u[t],r=i.href,r.indexOf(a._externalLinkAttrNameWithHash)>-1&&w._processExternalLink(r,i)},w._processHotelsAndRestaurantsSeoLinks=function(n,t){var u,f,r;return n&&(f=n.indexOf("#data-process="),n=n.substring(f+14),n=n.replace(/\?form=[a-zA-Z]*[0-9]*/i,""),t.setAttribute("data-process",n),t.setAttribute("href","#")),u=i.Internals.parseJSON(n),r=u&&u.requestState,r&&r.query&&r.seoHotelsAndRestaurantsUrl&&t.setAttribute("href",r.seoHotelsAndRestaurantsUrl),u},w._buttonGroupViewModel=s,w._moduleClickEventInitialized=!1,w._controlTemplateFactory=v,w._taskId=f,w._state=l,l&&l.savedEntityId&&(w.savedEntityId=l.savedEntityId),l&&l.collectionId&&(w.collectionId=l.collectionId),l&&l.itineraryTaskId&&(w.itineraryTaskId=l.itineraryTaskId),l&&l.id&&(w.itineraryEntityId=l.id),w.printNotes="",w._taskBar=h,w.iconClass="srcTsk",w.resources=t,w.printTitleViewModel=null,w._primitivesInteracted=p,b=n.searchNearbyDefaultSuggestions,w._searchNearbyDefaultCategories=[],b){for(k=0;k<b.length;k++)if(d=b[k].split(":"),d.length==2){var it=d[0],rt=d[1],nt=t[it],tt=t[rt];nt&&tt&&w._searchNearbyDefaultCategories.push({Name:nt,Id:tt})}g=y.features;g&&g.transit&&g.transit.isEnabled&&(w._searchNearbyDefaultCategories[w._searchNearbyDefaultCategories.length-1]={Name:t.L_SearchNearbyTerm_7,Id:t.L_SearchNearbyCategoryId_7})}return w}return v(a,c),a.prototype.dispose=function(){c.prototype.dispose.call(this);this._buttonGroupViewModel.dispose();this.annotationControl&&this.annotationControl.dispose();this.upcomingEventsControl&&this.upcomingEventsControl.dispose()},a.prototype.getIsDetails=function(){return!0},a.prototype.getPrintNotes=function(){return this.printNotes},a.prototype.getAttributionText=function(){return this._getAttribution()},a.prototype.updatePoiTitle=function(n){this._pushpins&&this._pushpins.length>0&&this._pushpins[0].entity.setTitle(n)},a.prototype.resetPrimitives=function(n){n.setPrimitives(this._pushpins)},a.prototype.registerLocatedAtSearchEvents=function(){sj_evt.unbind("SearchLocatedAt",this._searchLocatedAtHandler);sj_evt.bind("SearchLocatedAt",this._searchLocatedAtHandler,0)},a.prototype.registerModuleClickEvents=function(){sj_evt.unbind("TPModHdrClick",this._moduleHeaderClickHander);sj_evt.bind("TPModHdrClick",this._moduleHeaderClickHander,0)},a.prototype.registerVenueMapEvents=function(){var t=this,n=this.panelRoot.select("div[class=bm_venueMapButton]");n&&n[0]&&n.is_element_inView()&&n.add_event("click",function(){t.handleVenueMapClick()})},a.prototype.registerGeochainEvents=function(){for(var n,t,o,e=this.panelRoot.select(".geochainModule a"),r=0;r<e.length;r++)n=e[r],t={},n.hasAttribute("data-sid")?t.id="sid:"+n.getAttribute("data-sid"):n.hasAttribute("data-vdpid")?t.id="vdpid:"+n.getAttribute("data-vdpid"):t.query=n.innerText,t.entryPoint=u.Geochain,o={type:s.localSearchTask,requestState:t},n.setAttribute(f.taskProcessDataHandlerKey,i.Internals.stringify(o))},a.prototype.registerCalendarEvents=function(){var c=this,n=this.panelRoot.select("#cal_tm1"),t=this.panelRoot.select("#cal_tm2"),l,r,o,s,a;if(n&&n.length&&t&&t.length){l=this.panelRoot.select("*[data-cal-loc]");r=null;try{r=i.Internals.parseJSON(l.get_attr("data-cal-loc"))}catch(v){}o=this.map.getContainer();o&&(o.instanceAsync("Calendar",function(i){i.init(c.panelRoot,n,t,r)}),s=this._getReservertionForm(n),s&&(a=s.select("input[type='submit']"),a.add_event("click",function(){var n=c._buildLogData(h.Clicked,{AN:"Reservation",EP:u.LocalDetails});e.invokeHandler(f.instrumentationDataHandlerKey,n)})))}},a.prototype.registerActionButtonEvents=function(t){var s=this,tt=this.panelRoot.select("div[data-entity]"),o=tt&&i(tt[0]),f,it,p,r,y,w,rt,b,k,l,d,g,a,ut,nt;if(o&&this._taskId){f=o.select("a[class=directionsAction]");f&&f.length!==0||(f=this._initializeAlternateDirectionsButton(o));var c=this.getEntities()[0],e=c&&c.getLocation(),v=c&&c.getRoutableLocation();v=v?v:e;f&&f.length===1&&(it=this._buildLogData(h.Clicked,{AN:"Directions",CP:e,EP:u.LocalDetails}),p=function(n){return s._buttonGroupViewModel.directionButtonClicked(n,v,it,u.LocalDetails)},f.add_event("click",p),this._addEventsToEventList(f,"click",p));r=o.select("a[class=scheduleContactBtn], a#scheduleContactBtn");r&&r.length===1&&(y=r.get_attr("href"),w=y&&y!="#"?i.Internals.parseJSON(y):null,r.set_attr("href","#"),w&&r.length&&r.length>0&&(rt=this._buildLogData(h.Clicked,{AN:"ScheduleTourOrContactAgent",CP:e,EP:u.LocalDetails}),b=function(n){return s._buttonGroupViewModel.scheduleContactTourButtonClicked(n,w,rt,u.LocalDetails)},r.add_event("click",b),this._addEventsToEventList(r,"click",b)));k=new ti;l=o.select("a[class=saveAction], a#newCollectAction");l&&l.length===1&&(d=this._buildLogData(h.Clicked,{AN:"CollectionsMenu",CP:e,EP:u.LocalDetails}),g=function(n){!k.getIsSignedIn()&&at.isEditable?s._buttonGroupViewModel.saveWithTravelButtonClicked(n,e,d,u.LocalDetails):s._collectionClick(n,e,d,u.LocalDetails,k.getIsSignedIn())},l.add_event("click",g),this._addEventsToEventList(l,"click",g));a=o.select("a[class=shareAction], a#shareAction");a&&a.length===1&&(ut=this._buildLogData(h.Clicked,{AN:"ShareActionButton",CP:e,EP:u.LocalDetails}),nt=function(n){return s._shareButtonClicked(n,ut,t)},a.add_event("click",nt),this._addEventsToEventList(a,"click",nt));n.listingQuicksaveEnabled||this._populateAddToContainer();this._buttonGroupViewModel.setEntityData(c,{requestorType:"LocalDetailsTask",requestorId:this._taskId},this.panelRoot);this._addSuggestionsToNearbyModule(e)}},a.prototype.registerActionsModuleEvents=function(){var s=this,n=this.panelRoot.select("div[class=actionAnswer]"),t,o,i,r;if(n&&n.length)for(t=0;t<n.length;t++)if(o=n[t].getAttribute("data-actiontype"),i=n[t].getElementsByTagName("a"),i&&i.length&&o)for(r=0;r<i.length;r++)i[r].addEventListener("click",function(){var n=s._buildLogData(h.Clicked,{AN:"ActionModule",EP:u.LocalDetails,DT:o});e.invokeHandler(f.instrumentationDataHandlerKey,n)})},a.prototype.processDirectionsData=function(t){var r=this.getEntities(),i=r&&r[0],h=i.getAddress(),f,e,o,s;i&&i.id&&i.id.indexOf("event")>-1&&(e=n.eventPreArrivalTime,f=i.getDateTime&&i.getDateTime()?i.getDateTime()+i.getUtcOffset()*6e4-e*6e4:null);o=i.entitySource===1;s=ii.getDirectionTaskOptions(h,i.getRoutableLocation(),u.LocalDetails,i.getTitle(),i.id,null,o,f);t&&t.inData&&t.inData.requestorState&&(t.inData.requestorState.entryPoint===u.LocalDetails?this._buttonGroupViewModel.processDirectionsData(t,s):this._transientLensViewModel.processDirectionsData(t))},a.prototype.processTravelData=function(n){if(n&&n.inData&&n.inData.requestorState)n.inData.requestorState.entryPoint===u.LocalDetails?this._buttonGroupViewModel.processSaveWithTravelData(n):this._transientLensViewModel.processTravelData(n);else if(n&&n.outData&&n.outData.length){var t=n.outData[n.outData.length-1];this.itineraryTaskInfo=t;this._populateAddToContainer()}},a.prototype._populateAddToContainer=function(){var a=this,c=this.panelRoot.select("div[data-entity]"),f=c&&i(c[0]),n,e,o,u,s,l,h;f&&f.length!==0&&(n=f.select("div[class=bm_addToContainer]"),this.itineraryTaskInfo&&!n.length&&(e=f.select("div[class=b_subModule]"),o=e.length&&e[0],o&&(n=r._createElement("div"),n.add_class("bm_addToContainer bm_addToFirstModule"),o.appendChild(n[0]))),this.itineraryTaskInfo&&n.length?(n.clear(),n.add_class("bm_addToItineraryContainer"),u=r._createElement("a"),u.set_attr("href","#"),u.set_attr("class","addToAction addToItinerary"),s=r._createElement("span"),s.set_attr("class","addToItineraryIcon"),u.append(s),u.appendText(t.L_AddToItinerary),l=this.itineraryTaskInfo.processorId,h=function(n){return a._addAttractionButtonClicked(n,l)},u.add_event("click",h),this._addEventsToEventList(u,"click",h),n.append(u),n.set_style({display:"block"})):n.length&&(n.set_style({display:"none"}),n.remove_class("bm_addToItineraryContainer")))},a.prototype.processCollectionsData=function(n){var r=this.getEntities(),i=r&&r.length===1&&r[0],f=ii.getMyPlacesTaskOptions(i.getTitle(),i.getLocation(),i.getDescription()),t,e;f.activateOptions={parentId:this._taskId};f.state.data.id=i.id;t=n.inData.requestState;(t.action===yt.AddEntity||t.action===yt.AddFavorite||t.action===yt.AddToTemporaryCollection)&&(e=n.outData.length&&n.outData[0].data&&n.outData[0].data.entityId,e&&(this.savedEntityId=e),t.collectionId&&(this.collectionId=t.collectionId),t.action===yt.AddToTemporaryCollection&&(this.collectionId="TEMP"));n&&n.inData&&n.inData.requestorState&&(n.inData.requestorState.entryPoint===u.LocalDetails?this._buttonGroupViewModel.processCollectionsData(n,f):this._transientLensViewModel.processCollectionsData(n))},a.prototype.setResponseContent=function(t,r){var f=this,o,v,s,l;if(t){this._delayLoadRecommendationModuleImages(t);c.prototype.setResponseContent.call(this,t,r);window.AccordionControl&&AccordionControl&&AccordionControl.accordion&&(o=AccordionControl.accordion.length,o>0&&(v=AccordionControl.accordion[o-1],v.isResponsePreprocessingRequired=!0,sj_evt.bind("accordionAjaxResponse",this._preProcessLinks)));n.enableJavaScriptLoadingInResponse&&Microsoft.Maps.setTimeout(function(){f._loadJavaScriptInResponse(t)},10);s=this.panelRoot.select(".overlay-container");s.length>0&&(l=s[0].getAttribute("data-answerinfo"),l!=null&&n.pushpinIconScenarios!=null&&n.pushpinIconScenarios.indexOf(l)!==-1&&(this.iconClass="addrTsk"));var e={},y={},p=this.panelRoot.select("a[href]");p.for_each(function(n){var o=n.getAttribute("href"),t,r,c,b,l,p,d,w,g,nt;if(o)if(t=o.toLowerCase(),t.indexOf("http")===0||t.indexOf("/search")===0||t.indexOf("/images/search")===0)n.setAttribute("target","_blank");else if(t.indexOf("/local/reportproblem")===0)f._shouldEnableSuggestAnEdit()&&f._setLocalFeedbackTaskOptions(n);else if(t.indexOf(a._externalLinkAttrNameWithHash)>-1)f._processExternalLink(o,n);else if(t.indexOf("data-process")===0||t.indexOf("/maps")===0&&t.indexOf("#data-process")!==-1){r=null;try{t.indexOf("data-process")===0?(o=o.replace(/data-process=/i,""),o=o.replace(/\?form=[a-zA-Z]*[0-9]*/i,""),n.setAttribute("data-process",o),n.setAttribute("href","#"),r=i.Internals.parseJSON(o)):r=f._processHotelsAndRestaurantsSeoLinks(o,n)}catch(it){b=f._buildLogData(h.Clicked,{AN:"SEARCHERROR",EP:u.LocalDetails,DT:"BadDataProcess"});n.setAttribute("data-instrumentation",i.Internals.stringify(b));n.setAttribute("data-process","")}if(r&&r.moduleName&&(c=r.moduleName,c in e?e[c]+=1:e[c]=1,b=f._buildLogData(h.Clicked,{AN:c,EP:u.LocalDetails}),n.setAttribute("data-instrumentation",i.Internals.stringify(b))),r&&r.requestState&&r.requestState.passThruParam&&r.requestState.passThruParam.indexOf("lemodule=")!==-1&&(l=r.requestState.passThruParam.split("="),l&&l.length>1)){var s="lemoduleSeeAll."+l[1],tt="MapsModule."+l[1],k,v=f.panelRoot.select("div[data-entitymetadata]");if(v&&v.length)for(p=0;p<v.length;p++)if(v[p].getAttribute("data-moduletag")===tt){k=v[p];break}d=f._buildLogData(h.Clicked,{AN:s,EP:u.LocalDetails});k&&(w=k.getAttribute("data-entitymetadata"),w&&w.length&&(y[s]=w,d=f._buildLogData(h.Clicked,{AN:s,EP:u.LocalDetails,DAT:w})));n.setAttribute("data-instrumentation",i.Internals.stringify(d));s in e?e[s]+=1:e[s]=1}}else t.indexOf("javascript:void(0)")===0&&(g=n.getAttribute("id"),g!=null&&(nt=g.toLowerCase(),nt=="raflink"&&f._shouldEnableSuggestAnEdit()&&f._setLocalCrowdSourcingTaskOptions(n)))});this._addOutingsInstrumentation();this._addModulesInstrumentation(e,y);c.prototype.addReportLinkToNoResultCard.call(this,t,this._taskId,r)}},a.prototype.loadDelayedRecommendationModuleImages=function(){var n=this.panelRoot.select("div.EntityCollectionModuleContainer");!n||n.length<1||n.for_each(function(n){var f=n.getElementsByClassName("b_slideexp"),t,r,e,u,i,o;if(f&&f.length&&(t=f[0].getElementsByClassName("slide"),t&&t.length))for(r=0;r<t.length;r++)for(e=t[r].getElementsByTagName("img"),u=0;u<e.length;u++)i=e[u],i&&(o=i.getAttribute("data-delayedsrc"),o&&(i.setAttribute("src",o),i.setAttribute("data-delayedsrc","")))})},a.prototype._delayLoadRecommendationModuleImages=function(n){var t=0,r=n.select("div[data-mapcardwidth]"),f=r&&r.length&&r[0].getAttribute("data-mapcardwidth"),u,i;if(f)if(u=parseInt(f),u===384)t=2;else if(u===650)t=4;else return;(i=n.select("div.EntityCollectionModuleContainer"),!i||i.length<1)||i.for_each(function(n){var e=n.getElementsByClassName("b_slideexp"),i,u,o,f,r,s;if(e&&e.length&&(i=e[0].getElementsByClassName("slide"),i&&i.length>t))for(u=t;u<i.length;u++)for(o=i[u].getElementsByTagName("img"),f=0;f<o.length;f++)r=o[f],r&&(s=r.getAttribute("src"),s&&(r.setAttribute("data-delayedsrc",s),r.setAttribute("src","")))})},a.prototype._processExternalLink=function(n,t){var r,i;try{r=n.indexOf(a._externalLinkAttrNameWithHash);n=n.substr(r+a._externalLinkAttrNameWithHash.length+1);n=n.replace(/\?form=[a-zA-Z]*[0-9]*/i,"");i=a._externalLinkAttrNameWithHash.substr(1);t[i]=n;t.setAttribute(i,n);t.setAttribute("href","#");t.setAttribute("target","_blank");t.addEventListener("click",function(){t.setAttribute("href",t.getAttribute(i))});t.addEventListener("mouseover",function(){t.setAttribute("href",t.getAttribute(i))});t.addEventListener("focus",function(){t.setAttribute("href",t.getAttribute(i))})}catch(f){this._buildLogData(h.Clicked,{AN:"SEARCHERROR",EP:u.LocalDetails,DT:"BadDataProcess"})}},a.prototype._initializeAlternateDirectionsButton=function(n){var u=n.select("a#DirBtn"),f=!1,e,i,t,s,c,l;if(u&&u.length>0)if(e=this.panelRoot.select(".directionsPopOut"),e&&e.length!==0)f=!0;else if(i=u.get_ancestor(3),i&&i.length>0&&i.has_class("b_subModule"))try{t=null;this._state&&(r._isHouseCategory(this._state.listingCategoryPath)||r._isHouseCategory(this._state.selectedCategoryId)||r._isHouseCategory(this._state.category)||r._isHouseCategory(this._state.searchQueryCategory))&&(t=i.select(">.b_subscomp"),t&&t.length!==0||(t=i.select(">.b_lBottom.b_snippet")));t&&t.length!==0||(t=i.select(".infoCardIcons"));t&&t.length!==0||(t=i.select(".b_vList"));t&&t.length>0&&(s=document.createElement("div"),s.className="bm_popout directionsPopOut",i.insertBefore(s,t),f=!0)}catch(a){c=o.logger;c&&(l={feature:w.MapControl,action:h.Warning,data:{errorMessage:"_initializeAlternateDirectionsButton exception: "+a.toString()}},c.logObject(l))}return f||(this._processDirectionsButtonClick(),u=null),u},a.prototype._processDirectionsButtonClick=function(){if(this.panelRoot){var n=this.getEntities()[0],t=this.panelRoot.select("#DirBtn")[0];n&&t&&t.addEventListener("click",function(t){t.preventDefault();var i=new ri(n.getAddress(),n.getRoutableLocation(),n.getTitle(),!1,null,n.id,null,null,null,2,1,null),r={entryPoint:3,waypoints:[i]};e.invokeHandler(f.taskDataHandlerKey,{type:s.directionsTask,state:r})})}},a.prototype.parseEntitiesFromResponse=function(t,r){var e=this,u=c.prototype.parseEntitiesFromResponse.call(this,t,r),o,s,f;return this.boundingBox=this._parseBoundingBox(t),this.boundingBox&&(u=this.getEntities(),u&&u.length===1&&u[0].setBoundingBox(this.boundingBox)),n.enableLEPoiHover&&(o=t.select("div.EntityCollectionModuleContainer"),o.for_each(function(n){var l=n.getAttribute("data-entitylist"),r,f,c,o,s,t,h,u;if(l&&(r=i.Internals.parseJSON(l),r&&r.length>0))for(c=n.getAttribute("data-moduletag"),c&&(o=c.split("."),o&&o.length===2&&(f=o[1])),s=0;s<r.length;++s)t=r[s],e._pushpins&&t&&t.location&&t.location.length===2&&t.title&&t.id&&(h=new ur(t.id,t.title),f&&(h.setSearchCategory(f),h.setSelectedCategoryForIcon(f)),u=new ci(new b(t.location[0],t.location[1]),h),u.alwaysShowOnMap=!1,u.viewState=3,u.entity.poiType=1,e._pushpins.push(u))})),at&&at.newItineraryEnabled&&(s=t.select("div.overlay-taskpane").get_attr("data-facts"),f=l.parseDataFact(s),f&&u&&u.length===1&&(u[0].addressFields=f.addressFields)),r&&r.dateTime&&u[0]&&u[0].setDateTime(r.dateTime),r&&r.imgUrls&&r.imgUrls.length&&u[0]&&!u[0].getImageUrl()&&u[0].setImageUrl(r.imgUrls[0]),u},a.prototype.processPhotostripData=function(){var n,t=this.panelRoot.select("div[data-photostripconfig]").get_attr("data-photostripconfig");t&&(n=i.Internals.parseJSON(t));n&&(this._setPhotoStripWidth(n),this._registerPhotostripEvents())},a.prototype.createCalendarSync=function(){var t=this,i=this.getEntities()&&this.getEntities()[0];this.calendarSync=[];this.panelRoot.select(".calendarSyncControlContainer").for_each(function(r){var f=r.getAttributeNode("id"),u=f?f.nodeValue.split("_")[0]:"";t.calendarSync.push(new ou(t.map,t.panelRoot.select(u?"#"+u+"_calendarSyncControlContainer":".calendarSyncControlContainer"),t.panelRoot.select(u?"#"+u+"calendarSyncLabel":".calendarSyncLabel"),t.panelRoot.select(".calendarSyncMessage"),t._taskId,i,n))})},a.prototype.addCollectionsDescription=function(n){var e,t,i,u,f;if(n&&n.descriptionList&&n.descriptionList.length>0&&(e=n.descriptionList,t=this.panelRoot.select("ul[id=userDescriptionList]"),t&&t.length===1)){for(i=0;i<e.length;i++)u=r._createElement("li"),u.set_attr("data-tag","MapActionModule.UserDescription.Item"),u.set_text(e[i]),t.append(u);f=this.panelRoot.select("div[id=userDescription]");f&&f.length==1&&f.set_style({display:"block"})}},a.prototype.addAnnotationControl=function(n){var l=this,v=this.getEntities(),i=v&&v.length&&v[0],o=this.panelRoot.select(".local-variant"),s,c,y,p,w,b,r,u,f,e,a;o&&o.length!==0||this._state.selectedCategoryId!=="House"&&(i?i.getPrimaryCategoryPath()!=="House":!0)||(o=this.panelRoot.select(".overlay-taskpane"));o&&o.length&&(s=o.select(".b_entityTitle"),c=s.parent(),c&&c.length&&s&&s.length&&(y=document.createElement("div"),y.className="b_annotate annotate",c.insertBefore(y,s),p=document.createElement("div"),p.className="collectionsPopOut",c.insertBefore(p,s)));var h=this.panelRoot.select(".annotate"),k=this.panelRoot.select(".geocoderInfoModule"),d=this.panelRoot.select(".mapsCustomInfoCard .b_entityTitle");if(h&&h.length){var g=n.originalName?n.originalName:i?i.getTitle():"",tt=n.taskTitle||g,nt=null;n.descriptionList&&(nt=n.descriptionList[n.descriptionList.length-1]);w=i&&i.getLocationType();b=w==="StreetAddress"||w==="Other"&&(!i.id||i.id===i.getTitle());i.isPermanentlyClosed||this._state.selectedCategoryId==="House"||(i?i.getPrimaryCategoryPath()==="House":!1)?h.removeFromParent():(r=new cr(this._controlTemplateFactory,this.map,b,tt,g,nt),this.annotationControl=r,r.annotationChanged.add(function(){var t=r.getDescription(),n=r.getCurrentName();l._sendUpdateEntityProcessCall(n,t);l._state.descriptionList=[t];l._state.taskTitle=n;l.titleChanged.invoke(n)}),h.append(r.getControl()),h.set_style({display:"block"}),b&&h.add_class("address"),k&&k.set_style({display:"none"}),d&&d.set_style({display:"none"}));u=this.panelRoot.select(".mapActionsModule li");u&&u.length!==0||(u=this.panelRoot.select(".local-variant .b_entityTitle ~ .b_hList li"));u&&u.length>3&&(f=this.panelRoot.select(".shareAction, #shareAction"),f&&f.length>0&&(a=f.parent(),r.addAuxillaryButton(f),a.removeFromParent(),f.add_class("show"),f.set_attr("title",t.L_ShareTooltip)),u.length>4&&(e=this.panelRoot.select(".newCollectAction, #newCollectAction"),e&&e.length>0&&(a=e.parent(),r.addAuxillaryButton(e),a.removeFromParent(),e.add_class("show"),e.set_attr("title",t.L_SaveTooltip))));this.panelRoot.select("#shareAction").add_class("show");this.panelRoot.select("#newCollectAction").add_class("show")}},a.prototype.removeUpcomingEventContainer=function(){var t=this.panelRoot.select(".upcomingEvents"),n;t&&t.length&&(n=t.getParent(),n&&n.has_class("wpc_module")&&n.removeFromParent())},a.prototype.expandDetailsCard=function(){var r=this,n,t;y.isMobile&&(n=this.panelRoot.select("a[id*='expitem_']"),n&&n.length&&(n.get_attr("data-exp").length>0?n.for_each(function(n){var t=i(n);t.get_attr("data-exp").indexOf("tp_mobileexp")>=0&&r._toggleExpansion(t,!0)}):n.for_each(function(n){n.click()}),t=this.panelRoot.select("div[id='tp_mobileexp']"),t.removeFromParent()))},a.prototype._updateEntityState=function(t,i){this._isHomeOrWorkScenario(t)&&n.homeOrWorkDistanceEnabled&&i&&this._processHomeAndWork(i)},a.prototype._parseCategoryData=function(){var t,n=this.getEntities();n&&n.length===1&&(t=n[0].getPrimaryCategoryPath(!0));this.populateCardCategoryId(t)},a.prototype.processAdvertising=function(t,i){var u=null,v,f,c,y,d,p,e,l,s,o,r,rt,h,g,nt,w,b,a;try{if(v=this.getEntities(),i&&ut.isEnabled())if(v&&v.length===1)if(f=v[0],n.adsFromWorkflow)if(c=this.panelRoot.select("div.overlay-container"),c&&c.length)if(n.isRenderAdsAtServer){var r=this.GetDetailsScenario(t,f),l=this.panelRoot.select("div.mapsTextAds"),it=fr.setShownAds(r,l,tt.getImpressionGuid(this.panelRoot));n.logServerRenderedAdData&&(y=0,d=c[0].getAttribute("data-ads"),d&&(y=parseInt(d)),it!==y&&ut.logError("Expected "+y+" ads, got "+it+", q="+t.taskTitle,k[r]))}else p=c[0].getAttribute("data-ads"),u=p===null?93:p?this.showAdsFromWorkflow(t,i,f,p):92;else u=94;else if(u=98,l=this.panelRoot&&this.panelRoot.select("div.adsContainer"),s=l&&l.length&&l.getParent(),s&&s.length)t&&(t.query?o=t.query:t.entryPoint==="BasemapPrimitive"&&t.scenarioKey==="MA_PNTY"&&t.id.indexOf("vdpid:")===0&&t.taskTitle&&(o=t.taskTitle),o&&(e=n.detailsMaxAdCount,e&&(i.setScenario(k.PD),u=k.PD,i.requestAds(this._placeAdsQuery(o),f.getLocation().clone(),e,this._taskId),s.getParent().insertBefore(i.getControl(),s)))),s.removeFromParent();else{if(rt=f.getPrimaryCategoryName(),(t.scenarioKey==="HS"||rt==="Hotel")&&(e=n.hotelsMaxAdCount,e&&(r=k.HO)),e=n.detailsMaxAdCount,!r&&e){if(h=f.getPrimaryCategoryPath(),g=f.getLocationType(),(g==="City"||g==="Country")&&(o=this._placeAdsQuery(f.getTitle()),r=k.PL),!r&&h&&h.length&&(nt=h.split("."),nt&&(w=n.catsForAdsTest,w)))for(b=0;b<w.length;b++)if(nt.indexOf(w[b])>=0){r=k.CT;break}r||t.scenarioKey!=="LS"&&t.scenarioKey!=="LLS"||h&&h.length||(r=k.LS)}r&&(o||(o=f.getTitle()))&&(a=this.panelRoot&&this.panelRoot.select("div.tp_tasks"),!a.length&&n.localOverlayAds&&(a=this.panelRoot.select("div.b_entityTP"),r=k.OD),a.length?(i.setScenario(r),u=r,i.requestAds(o,f.getLocation().clone(),e,this._taskId),a.append(i.getControl())):u=96)}else u=95;else u=99}catch(ft){ut.logError(ft);u=97}t.adsLog=u},a.prototype.showAdsFromWorkflow=function(n,t,i,r){var u,s=t.getControl(),o=this.panelRoot&&this.panelRoot.select("div.adsContainer"),f=o&&o.length&&o.getParent(),e;return f&&f.length?(u=k.PD,t.setScenario(u),t.setAds(r),f.getParent().insertBefore(s,f),f.removeFromParent()):(e=this.panelRoot&&this.panelRoot.select("div.tp_tasks"),e&&e.length?(u=this.GetDetailsScenario(n,i),t.setScenario(u),t.setAds(r),e.append(s)):u=96),u},a._getLocationForEntity=function(n){var t=n&&n.entity&&n.entity.getGeometry();return t?new b(t.y,t.x):null},a._getWorkHomeResourceString=function(n){var r=n.isHome,i=n.requestOptions.mode;return r?i===ht.walking?t.L_TimeWalkHome_Text:t.L_TimeDriveHome_Text:i===ht.walking?t.L_TimeWalkWork_Text:t.L_TimeDriveWork_Text},a.prototype._isHomeOrWorkScenario=function(t){var i=t.select(".overlay-container").get_attr("data-answerInfo"),r=i&&parseInt(i);return r&&n.homeWorkAnswerScenarios&&n.homeWorkAnswerScenarios.indexOf(r)!==-1},a.prototype._processHomeAndWork=function(n){var r=new ti,i,t;r.getIsSignedIn()&&(i=this.map,t=this.map&&this.map.getContainer(),t&&t.instanceAsync("ItineraryDataManager",function(t){t&&t.syncFavorites(function(r){if(r===0){var u=a._getLocationForEntity(t.home),f=a._getLocationForEntity(t.work);(u||f)&&a._updateEntityWithHomeOrWorkDistance(t,n,i)}})}))},a._getWaypoints=function(n,t,i,r){var u=[],e=i?n.home:n.work,f=e.entity;return u.push(new ri(f.getAddress(),t,f.getName(),!1,null,f.id,null,null,null,1,6,null)),u.push(new ri(r.getAddress(),r.getRoutableLocation()?r.getRoutableLocation():r.getLocation(),r.getTitle(),!1,null,r.id,null,null,null,2,1,null)),u},a._updateEntityWithHomeOrWorkDistance=function(i,u,o){var c=a._getLocationForEntity(i.home),l=a._getLocationForEntity(i.work),b=u.getRoutableLocation(),k=b?b:u.getLocation(),v=c&&gi.greatCircleDistance(k,c),y=l&&gi.greatCircleDistance(k,l),s,h,p;if(v&&y?(s=v<=y,h=s?v:y,p=s?c:l):v?(s=!0,h=v,p=c):y&&(s=!1,h=y,p=l),h&&h<n.maxHomeOrWorkDistanceMeters&&h>n.minHomeOrWorkDistanceMeters){var d=a._getWaypoints(i,s?c:l,s,u),g={waypoints:d,options:{unit:hu.unit===1?wi.miles:wi.km,maxRoutes:1},mode:h<n.maxWalkingDistance?ht.walking:ht.driving},nt={isSummaryOnly:!0,requestOptions:g,isHome:s,entity:u};bu.downloadRoutes(nt,function(i,s,h){var c,l,v;if(h.errorCode===wu.Success&&s&&(c=s.resourceSets.length>0&&s.resourceSets[0]&&s.resourceSets[0].resources&&s.resourceSets[0].resources[0],c)){var y=new su,p=a._getWorkHomeResourceString(i),b=c.travelDurationTraffic<=n.minTimeThreshold*60?r._formatString(t.L_TimeDurationLessThan_Text,n.minTimeThreshold):y.getDurationString(c.travelDurationTraffic);u.subtitle=p.replace("{0}",b);u instanceof bi&&u.setRouteRequestState(i);l=o&&o.getFrameManager();l&&l.hackHackSetFrame();v={logData:{feature:w.DetailsCard,action:"HWSHOW",data:{HW:i.isHome?"H":"W"}}};e.invokeHandler(f.instrumentationDataHandlerKey,v)}})}},a.prototype.GetDetailsScenario=function(t,i){var e,r,o,u,f;if(t.scenarioKey==="HS"||i.getPrimaryCategoryName()==="Hotel")return k.HO;if(e=i.getLocationType(),e==="City"||e==="Country")return k.PL;if(r=i.getPrimaryCategoryPath(),r&&r.length&&(o=r.split("."),o&&(u=n.catsForAdsTest,u)))for(f=0;f<u.length;f++)if(o.indexOf(u[f])>=0)return k.CT;return(t.scenarioKey==="LS"||t.scenarioKey==="LLS")&&!(r&&r.length)?k.LS:k.DE},a.prototype.getDetailsHtmlContentForPrint=function(n){var t=this,f=this.annotationControl&&this.annotationControl.getOriginalName(),e=this.annotationControl&&this.annotationControl.getDescription(),i,u,r;return this.printTitleViewModel=new nu(this.map,this._controlTemplateFactory,this.getEntities(),n,f),this.notesMaxCharSize=ir.notesMaxChars,i={boolToDisplay:function(n){return t.boolToDisplay(n)},nullToDisplayNone:function(n){return t.nullToDisplayNone(n)},hideIfMatchedData:function(n){return t.hideIfMatchedData(n)},emptyToDisplayNone:function(n){return t.emptyToDisplayNone(n)}},this.titlePrintTemplate=new gt(li,i),u=this._controlTemplateFactory({templateText:or,staticResources:i}),this.printNotes=e||"",r=u.applyDataTemplate(this),r.length>0?r[0].outerHTML:""},a.prototype.hideIfMatchedData=function(n){var t=this.getEntities()&&this.getEntities()[0]&&this.getEntities()[0].getSegmentTypes()?this.getEntities()[0].getSegmentTypes()[0].toLowerCase():"";return n===null||this.getEntities()[0].getTitle()===n||t==="house"?"none":""},a.prototype.prepareMenuModule=function(){var t=this.panelRoot.select("div[data-tabcontrolid]").get_attr("data-tabcontrolid"),n;t&&(n=this.panelRoot.select("#"+t+"_menu"),n&&n.length&&(this._prepareTabs(n[0],t),Microsoft.Maps.setTimeout(function(){sj_evt.fire("tab_init",tabcontrol)},10)))},a.prototype.prepareReviewsAccordionModule=function(n){var i=this.panelRoot.select("div[class=revacc]"),t,r;i&&i.length&&(t=i.select("div[class=acc-header]"),t&&t.length&&t[0].children&&t[0].children.length&&sj_evt.bind("accordion_item_click",n,1),r=i.select("a[id*='expitem_']"),r&&r.length&&r.for_each(function(t){t.addEventListener("click",function(){n&&n()})}),Microsoft.Maps.setTimeout(function(){sj_evt.fire("accordion_init",AccordionControl)},10))},a.prototype.addRecommendationModuleHover=function(t){var r=this,f,u;n.enableLEPoiHover&&(f=this.panelRoot.select("div.EntityCollectionModuleContainer"),u=1,f.for_each(function(f){var y=f.getAttribute("data-entitylist"),s,a,o,l;if(y&&(s=i.Internals.parseJSON(y),s&&s.length>0)){for(var h=u,c=u+s.length-1,e=f.parentElement,p=0,v=!1;e&&p<5;){if(v=e&&e.className&&e.className.indexOf("wpc_module")>-1?!0:!1,v)break;++p;e=e.parentElement}v?(a=e.getElementsByClassName("b_secondaryText"),n.enableLEPoiHover2&&a&&a.length&&(o=document.createElement("input"),o.type="checkbox",o.className="seeAllCheckBox",o.checked=!1,o.addEventListener("change",function(){r._onRecommendationModuleHover(t,h,c,o.checked)}),a[0].appendChild(o)),e.addEventListener("mouseenter",function(){r._onRecommendationModuleHover(t,h,c,!0,o)}),e.addEventListener("mouseleave",function(){r._onRecommendationModuleHover(t,h,c,!1,o)})):(f.addEventListener("mouseenter",function(){r._onRecommendationModuleHover(t,h,c,!0)}),f.addEventListener("mouseleave",function(){r._onRecommendationModuleHover(t,h,c,!1)}));l=i(f).select("li");l&&l.length&&l.length==s.length?l.for_each(function(n){var i=u++;n.addEventListener("mouseenter",function(){r._onRecommendationModuleItemHover(t,i,!0)});n.addEventListener("mouseleave",function(){r._onRecommendationModuleItemHover(t,i,!1)})}):u+=s.length}}))},a.prototype.edgeRecoModuleFix=function(){var n=this.panelRoot.select("div.wpc_module.sb_meta");n&&n.length&&n.for_each(function(n){n.setAttribute("style","outline: 1px solid transparent")})},a.prototype.handleVenueMapClick=function(){var n={};n.type=s.venueMapDirectoryTask;n.action="activate";n.activateOptions={};n.activateOptions.activationState=1;var i={},r=this.panelRoot.select("div.overlay-taskpane.local-taskpane"),u=r.get_attr("data-venues"),t=JSON.parse(u);t.venueMapInfo&&t.venueMapInfo[0]&&t.venueMapInfo[0].id&&(i.venueMapId=t.venueMapInfo[0].id,i.venueMapType=t.venueMapInfo[0].mapType,i.title=this._state.taskTitle||"",n.state=i,e.invokeHandler(f.taskDataHandlerKey,n))},a.prototype._onRecommendationModuleItemHover=function(n,t,i){if(n&&this._pushpins&&this._pushpins.length&&t<this._pushpins.length){var r=this._pushpins[t];r.viewState=i?1:0;r.zIndex=i?2:0;n.setPrimitives(this._pushpins,!0)}},a.prototype._onRecommendationModuleHover=function(n,t,i,r,u){var e=u&&u.checked?!0:!1,f;if(n&&this._pushpins&&this._pushpins.length&&t<this._pushpins.length&&i<this._pushpins.length){for(f=t;f<=i;++f)this._pushpins[f].viewState=r||e?0:3,!r&&!e&&n._primitives&&n._primitives.length&&f<n._primitives.length&&n._primitives[f].bucket&&delete n._primitives[f].bucket;n.disableComputingMapViewForFirstTimeLoad=!0;r||e?n.setPrimitives(this._pushpins,!0):n.setPrimitives([this._pushpins[0]],!0)}},a.prototype._addOutingsInstrumentation=function(){var n=this.panelRoot.select(".articleList a.articleCard"),i,t,r;n&&n.length!==0||(n=this.panelRoot.select(".bm_outingsModule a"));n&&n.length>0&&(i=this._buildLogData(h.Clicked,{AN:"MapsModule.OutingsLink",EP:u.LocalDetails}),n.for_each(function(n){n.addEventListener("click",function(){e.invokeHandler(f.instrumentationDataHandlerKey,i)})}));t=this.panelRoot.select(".articleList .b_module_expansion .b_expand");t&&t.length>0&&(r=this._buildLogData(h.Clicked,{AN:"MapsModule.OutingsExpansion",EP:u.LocalDetails}),t[0].addEventListener("click",function(){e.invokeHandler(f.instrumentationDataHandlerKey,r)}))},a.prototype._addModulesInstrumentation=function(n,t){var tt=this,k=this.panelRoot.select("div[data-suppressed]"),y,p,w,b,v,l,s,a,o,c,it,d,rt,r,g,ut,nt;if(k&&k.length&&(y=k[0].getAttribute("data-suppressed"),y&&y.length&&(l=this._buildLogData(h.Removed,{AN:"Suppressed",EP:u.LocalDetails,DAT:y}),l.impressionGuid=this._state.impressionGuid,e.invokeHandler(f.instrumentationDataHandlerKey,l))),p=this.panelRoot.select("div[data-umodules]"),p&&p.length&&(w=p[0].getAttribute("data-umodules"),w&&w.length&&this._state&&(b={moduleKeys:w,query:this._state.query,id:"",title:""},v=this.getEntities&&this.getEntities(),v&&v.length&&(b.id=v[0].id,b.title=v[0].getTitle()),l=this._buildLogData("UM",{AN:"UnrecognizedModules",EP:u.LocalDetails,DAT:i.Internals.stringify(b)}),l.impressionGuid=this._state.impressionGuid,e.invokeHandler(f.instrumentationDataHandlerKey,l))),s=this.panelRoot.select("div[data-moduletag]"),s&&s.length)for(a=0;a<s.length;a++)o=s[a].getAttribute("data-moduletag"),o&&(c=s[a].getAttribute("data-entitymetadata"),c&&c.length&&(t[o]=c),it=i(s[a]),d=it.select("a[href]"),d&&d.for_each(function(t){var e="",s="",l,f,r,a;try{l=t.getAttribute("data-process");l&&(f=JSON.parse(l),f&&f.requestState&&(r=f.requestState,r.title&&(s=r.title),r.entityId&&(e=r.entityId)))}catch(v){}a=c&&c.length?tt._buildLogData(h.Clicked,{AN:o,EP:u.LocalDetails,ID:e,Name:s,DAT:c}):tt._buildLogData(h.Clicked,{AN:o,EP:u.LocalDetails,ID:e,Name:s});t.setAttribute("data-instrumentation",i.Internals.stringify(a));o in n?n[o]+=1:n[o]=1}));rt=["MapsModule.PointsOfInterest","MapsModule.PeopleAlsoSearchedFor","MapsModule.FoundAtThisAddress","MapsModule.FoundNearThisAddress","MapsModule.EatAndDrink","MapsModule.ThingsToDo","MapsModule.WhereToStay","MapsModule.PlaceNearby","MapsModule.PlaceToGo","MapsModule.Events","MapsModule.EventsAtVenue"];for(r in n)n.hasOwnProperty(r)&&n[r]&&(g=rt.indexOf(r)>-1?Math.floor(n[r]/2):n[r],nt=t[r],ut=nt?this._buildLogData(h.Impression,{AN:r,EP:u.LocalDetails,CNT:g,DAT:nt}):this._buildLogData(h.Impression,{AN:r,EP:u.LocalDetails,CNT:g}),e.invokeHandler(f.instrumentationDataHandlerKey,ut))},a.prototype._prepareTabs=function(n,t){for(var r,i,u,f,h,e,o=this,s=0;s<n.children.length;s++)r=n.children[s],i=r.getAttribute("data-content"),i&&(u=this.panelRoot.select("#"+i),u&&u.length&&(r.setAttribute("data-content",i+"_"+t),u[0].id=i+"_"+t)),r.addEventListener("click",function(){o._menuModuleClicked("TabClick")});f=this.panelRoot.select("div[data-tabcontrolid]");f&&(h=["_navl","_navr"],h.forEach(function(n){var i=f.select("#"+t+n);i&&i.length&&i[0].addEventListener("click",function(){o._menuModuleClicked("NavClick")})}),e=f.select("a[class=b_moreLink]"),e&&e.length&&e[0].addEventListener("click",function(){o._menuModuleClicked("MenuLinkClick")}))},a.prototype._menuModuleClicked=function(n){var t=this._buildLogData(h.Clicked,{AN:"RestaurantMenu",EP:u.LocalDetails,DT:n});e.invokeHandler(f.instrumentationDataHandlerKey,t)},a.prototype._shareButtonClicked=function(n,t,i){n&&n.preventDefault();e.invokeHandler(f.shareDataHandlerKey,{action:"shareTasks",taskIds:[i],entryPoint:u.LocalDetails});e.invokeHandler(f.instrumentationDataHandlerKey,t)},a.prototype._addAttractionButtonClicked=function(n,t){n&&n.preventDefault();var i=this.getEntities()[0],r=ii.getItineraryAddItemOptions(i.getTitle(),i.getLocation(),i.id,i.getImageUrl(),t,i.getSelectedCategoryForIcon(),i.interests,i.stayDuration);e.invokeHandler(f.taskProcessDataHandlerKey,r)},a.prototype._setPhotoStripWidth=function(n){var i,t,r,u;if(n.PhotostripItems&&n.PhotostripItems.length){for(this._photostripTotalWidth=0,i=n.PhotostripItems.length,t=0;t<i;t++)r=n.PhotostripItems[t],this._photostripTotalWidth+=r.IsPano?a._photoWidth*2:a._photoWidth;u=this.panelRoot.select("ul.photostrip");u.set_style({width:this._photostripTotalWidth+"px"})}},a.prototype._slidePhotstripLeft=function(n,t,i){if(t<0){var r=i*++t;n.set_style({left:r+"px"})}return t},a.prototype._slidePhotstripRight=function(n,t,i){var r,u,f;return t<=0&&(r=i*(t-1),this._photostripTotalWidth>Math.abs(r)&&(u=Math.floor(a._photostripVisibleWidth/a._photoWidth),f=(this._photostripTotalWidth-Math.abs(r))/a._photoWidth,f>u?n.set_style({left:r+"px"}):(r=r+(a._photostripVisibleWidth-(this._photostripTotalWidth-Math.abs(r))),n.set_style({left:r+"px"})),--t)),t},a.prototype._showImageInModalDialog=function(n){if(n){var t=a._imgModalDialogContentTemplate.replace("{imgSrc}",n.imgsrc).replace("{imgAttrb}",n.imgattrb).replace("{providerLink}",n.providerlink).replace("{providerLinkText}",n.providerlinktext),i=new vu(t,"bigImgDialog");i.OpenDialog()}},a.prototype._registerPhotostripEvents=function(){var n=this,r=this.panelRoot.select("ul.photostrip"),e=a._photoWidth*3,t=0,o=this.panelRoot.select("div.mapsPhotostrip .psnav.prev"),s=function(i){t=n._slidePhotstripLeft(r,t,e);i.preventDefault()},u,f,h;o.add_event("click",s);this._addEventsToEventList(o,"click",s);u=this.panelRoot.select("div.mapsPhotostrip .psnav.next");f=function(i){t=n._slidePhotstripRight(r,t,e);i.preventDefault()};u.add_event("click",f);this._addEventsToEventList(u,"click",f);h=r.select("a.thumb[data-imgsrc]");h.for_each(function(t){var r=i(t),f=i.Internals.parseJSON(r.get_attr("data-imgsrc")),u=function(t){n._showImageInModalDialog(f);t.preventDefault()};r.add_event("click",u);n._addEventsToEventList(r,"click",u)})},a.prototype._parseBoundingBox=function(n){var f=n.select("div[data-boundingbox]").get_attr("data-boundingbox"),r=f&&i.Internals.parseJSON(f),u,t;return r&&r.boundingBox&&r.boundingBox.length>1?(u=[],t=r.boundingBox[0],u.push(new b(t.latitude,t.longitude)),t=r.boundingBox[1],u.push(new b(t.latitude,t.longitude)),u):null},a.prototype._buildLogData=function(n,t){return{logData:{feature:w.DetailsCard,action:n,data:t}}},a.prototype._logAction=function(n){var t={AN:n};this._logHelper&&this._logHelper.log(p.LDA,t)},a.prototype._loadJavaScriptInResponse=function(n){n.select("div[data-answerinfo]").length>0&&n.select("script").for_each(function(n){var i=n.textContent,t;a._detailsPageScripts[i]||(t=document.createElement("script"),t.type="text/javascript",t.textContent=i,document.head.appendChild(t),a._detailsPageScripts[i]=t)})},a.prototype._moduleHeaderClickHander=function(n){var t,i;n&&n[1]&&n[2]&&(t=n[1].nextElementSibling,t&&(i=_w.getComputedStyle(t,null).display==="none",t.style.display=i?"block":"none",Log.Log(i?"Show":"Hide","TaskPane",n[2],!1)))},a.prototype._searchLocatedAtHandler=function(n){if(n&&n[1]){var t={query:n[1],fullQuery:n[1],entryPoint:u.LocalDetails};n[2]&&(t.filterUrlParam='local_ypid:"'+n[2]+'"');e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:t,type:s.localSearchTask})}},a.prototype._toggleExpansion=function(n,t){var o=t?"id":"data-expe",i=n.get_attr(o),u,f,e,r;if(i.indexOf("txt")==0)i=i.substr(3);else if(i.lastIndexOf("_hit")==i.length-4)i=i.substr(0,i.length-4);else return;u=this.panelRoot.select("[data-exp=H;"+i+";;;;]");u&&(t?u.remove_class("b_hide"):u.add_class("b_hide"));f=this.panelRoot.select("[id=txt"+i+"]");f&&(t?f.add_class("b_hide"):f.remove_class("b_hide"));e=this.panelRoot.select("[id="+i+"_hit]");e&&(t?e.add_class("b_hide"):e.remove_class("b_hide"));r=this.panelRoot.select("[data-expid="+i+"]");r&&r.has_class("tp_collapsed")&&(t?r.remove_class("tp_collapsed"):r.add_class("tp_collapsed"))},a.prototype._getReservertionForm=function(n){for(var t=n.parent(),i=null,r=0;r<5;r++){if(t&&t[0]&&t[0].tagName=="FORM"){i=t;break}t=t.parent()}return i},a.prototype._addSuggestionsToNearbyModule=function(t){var o=this,p=this.getEntities(),b=p&&p[0],l=!0,i=c.prototype.parseSuggestionMetaData.call(this),s,v,r;i||(l=!1,i=this._searchNearbyDefaultCategories);s=[];i.forEach(function(n){s.push(n.Name)});var k=y.features,a=n.detailCardNearbyLabels,u=this.panelRoot.select("a[class=searchNearbySearchLink]");u&&u.length===1&&(v=function(n){return o._nearbySearchLinkClickHandler(n,t,s,i&&i.length?i[0].viewport:null)},u.add_event("click",v),this._addEventsToEventList(u,"click",v),u.add_class("xsrIcon"));r=this.panelRoot.select("ul[class=searchNearbyModule]");this.selectorReady().then(function(n){var c,u,v;r&&r.length===1&&(c=a?"searchNearbyModuleIcon searchNearbyWithLabels":"searchNearbyModuleIcon",r.set_attr("class",c),i.forEach(function(i){var u=o._drawCategoryItem(n,i,"SearchNearbySuggestionLink",function(n){return o._nearbySuggestionClickHandler(n,t,l,b,i.viewport)},a);u&&r.append(u)}),u=o.panelRoot.select("li.searchNearbySearchButton"),a&&u&&u.length===1&&(u.removeFromParent(),r.append(u)),v={logData:{feature:w.NearbySearch,action:h.Activated,data:{CAT:s.join(","),DY:l}}},e&&e.invokeHandler(f.instrumentationDataHandlerKey,v))})},a.prototype._nearbySearchLinkClickHandler=function(i,r,o,s){var l=this._getMapBounds(s),a=this._buildLogData(h.Clicked,{AN:"SearchNearby",CP:r,EP:u.LocalDetails,DT:"SearchLink"});i&&i.preventDefault();e.invokeHandler(f.instrumentationDataHandlerKey,a);l||et.setMapCenter(this.map,r,n.searchNearbyDefaultZoomLevel);var c=this.getEntities()[0],v=c&&c.getTitle()||"",y=t.L_SearchNearbyGhostTextFormat.replace("{query}",v);this._taskBar&&this._taskBar.setSearchBoxGhostText(y);this._taskBar&&this._taskBar.setNearbyLocationTitle(c.getTitle());o&&this._taskBar.updateSearchBoxAutosuggestDefault(o,l)},a.prototype._nearbySuggestionClickHandler=function(i,r,o,c,l){var g=c&&c.getAddress(),nt=c&&c.getTitle()||g,a,v,b,k,p,w,d;if(i&&i.target){for(a=i.target;a.parentNode;){if(a.nodeName.toLowerCase()==="a")break;a=a.parentNode}if((i.stopPropagation(),i.preventDefault(),a)&&(v=a.title,v)){if(b=o?"SuggestionLinkDynamic.":"SuggestionLink.",k=this._buildLogData(h.Clicked,{AN:"SearchNearby",CP:r,EP:u.LocalDetails,DT:b+v}),e.invokeHandler(f.instrumentationDataHandlerKey,k),(!l||l.length<2)&&et.setMapCenter(this.map,r,n.searchNearbyDefaultZoomLevel),p={},p.entryPoint=u.LocalDetails,p.query=v,p.mapBounds=this._getMapBounds(l),w=y.features,v===t.L_SearchNearbyTerm_7&&w&&w.transit&&w.transit.isEnabled){d={location:r,title:nt,entryPoint:1};e.invokeHandler(f.taskDataHandlerKey,{state:d,type:s.nearbyTransitTask});return}e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:p,type:s.localSearchTask})}}},a.prototype._getMapBounds=function(n){if(n&&n.length>1&&!isNaN(n[0].latitude)&&!isNaN(n[0].longitude)&&!isNaN(n[1].latitude)&&!isNaN(n[1].longitude)){var t=[];return t.push(Math.max(n[0].latitude,n[1].latitude)),t.push(Math.min(n[0].longitude,n[1].longitude)),t.push(Math.min(n[0].latitude,n[1].latitude)),t.push(Math.max(n[0].longitude,n[1].longitude)),t}return null},a.prototype._setLocalCrowdSourcingTaskOptions=function(n){var f=this,e=this.getEntities(),i=e&&e[0],t={},h;t.entityName=i.getTitle();t.entityYpid=i.id;var r=null,u=null,o=this.panelRoot.select("div.overlay-taskpane").get_attr("data-facts"),s=this.panelRoot.select("div.overlay-taskpane").get_attr("data-ufacts");if(o){try{r=JSON.parse(o)}catch(c){}r&&(t.dataFacts=r)}if(s){try{u=JSON.parse(s)}catch(c){}u&&(t.userFacts=u)}t.query=i.getTitle();t.reportType=4;h=function(n){f._onLocalCrowdSourcingLinkClick(n,f._taskId,i.getTitle(),t)};n.href="#";n.onclick=h},a.prototype._onLocalCrowdSourcingLinkClick=function(n,i,r,u){n.preventDefault();e.invokeHandler(f.taskDataHandlerKey,{type:s.feedbackTask,activateOptions:{parentId:i},state:{entryPoint:3,feedbackTaskType:7,title:t.L_RichAttributeFeedbackTitle,activeTaskId:i,options:u}})},a.prototype._setLocalFeedbackTaskOptions=function(n){var e=this,o=this.getEntities(),r=o&&o[0],i,c;if(r){i={};i.entityName=r.getTitle();i.entityYpid=r.id;var u=null,f=null,s=this.panelRoot.select("div.overlay-taskpane").get_attr("data-facts"),h=this.panelRoot.select("div.overlay-taskpane").get_attr("data-ufacts");if(s){try{u=JSON.parse(s)}catch(l){}u&&(i.dataFacts=u)}if(h){try{f=JSON.parse(h)}catch(l){}f&&(i.userFacts=f)}i.query=r.getTitle();i.reportType=4;c=function(n){e._onSuggestAnEditLinkClick(n,e._taskId,r.getTitle(),i)};n.text=t.L_Menu_SuggestAnEdit_Link_Text;n.href="#";n.onclick=c}},a.prototype._onSuggestAnEditLinkClick=function(n,i,r,u){n.preventDefault();e.invokeHandler(f.taskDataHandlerKey,{type:s.feedbackTask,activateOptions:{parentId:i},state:{entryPoint:3,feedbackTaskType:4,title:t.L_Menu_SuggestAnEdit_Link_Text+" - "+r,activeTaskId:i,options:u}})},a.prototype._shouldEnableSuggestAnEdit=function(){var n=null,t=null,i=this.panelRoot.select("div.overlay-taskpane").get_attr("data-facts"),r,u;if(i)try{n=JSON.parse(i)}catch(f){}return(n&&n.languageCultureName&&(t=n.languageCultureName),r=st.ftwMarkets,u=new RegExp(t,"i"),r.search(u)>=0)?!0:!1},a.prototype._placeAdsQuery=function(n){var i=2,t=-1;do t=n.indexOf(",",t+1);while(t>=0&&--i);return!i&&t>0&&(n=n.substring(0,t)),n},a.prototype._getAttribution=function(){var n=this.panelRoot.select("div[class*='b_footnote']");return n&&n.length>0?n[0].innerText:""},a.prototype._sendUpdateEntityProcessCall=function(n,t){var r,u,i;(this.savedEntityId||this.collectionId)&&(r={action:yt.UpdateEntity,data:{description:t,title:n},entityId:this.savedEntityId,collectionId:this.collectionId},i={type:s.collectionsTask,requestorType:"LocalDetailsTask",requestorId:this._taskId,requestState:r},e.invokeHandler(f.taskProcessDataHandlerKey,i));this.itineraryTaskId&&(u={action:4,itineraryItemChanged:{Description:t,Name:n,Id:this.itineraryEntityId}},i={type:s.itineraryDetailsTask,requestorType:"LocalDetailsTask",requestorId:this._taskId,requestState:u,taskId:this.itineraryTaskId},e.invokeHandler(f.taskProcessDataHandlerKey,i))},a.prototype._collectionClick=function(n,t,i,r,u){this.annotationControl&&(this._buttonGroupViewModel.entityDescription=this.annotationControl.getDescription(),this.annotationControl.getCurrentName()!==this.annotationControl.getOriginalName()&&(this._buttonGroupViewModel.entityNickName=this.annotationControl.getCurrentName(),this._buttonGroupViewModel.entityOriginalName=this.annotationControl.getOriginalName()));u?at.isEditable?this._buttonGroupViewModel.saveWithTravelButtonClicked(n,t,i,r,!0):this._buttonGroupViewModel.collectionMenuButtonClicked(n,t,i,r):this._buttonGroupViewModel.collectionButtonClicked(n,t,i,r)},a._detailsPageScripts={},a._photostripVisibleWidth=310,a._photoWidth=82,a._imgModalDialogContentTemplate='<div class="bigImg"><p>{imgAttrb}<\/p><div><img src="{imgSrc}" /><\/div><p><a href="{providerLink}">{providerLinkText}<\/a><\/p><\/div>',a._externalLinkAttrNameWithHash="#data-extlink",a}(yr),ei=function(o){function c(i,r,u,f,e,s,h){var l=this;return r&&r.add_class("bm_listings-container"),l=o.call(this,i,r,f,"a.listings-item","data-entity",s)||this,l._poiManager=e,l._taskId=u,l._controlTemplateFactory=h,l.resources=t,l.printTitleViewModel=null,l.printListingsViewModel=null,l._paginationImageDelayLoaded=!1,l.loadInfobox=new g,l._paginationItemsPerPage=c._evenColumnListItemsPerPage,l._paginationCurrentPage=0,c._entityCardHoverTimeout=n.hoverThreshold,l}return v(c,o),c.prototype.getIsDetails=function(){return!1},c.prototype.getQuery=function(){return this._query},c.prototype.setQuery=function(n){this._query=n},c.prototype.setResponseContent=function(t,i){if(t){var r=t.select(".bm_3col");r&&r.length?(this._paginationItemsPerPage=c._threeColumnListItemsPerPage,i&&(i.isThreeColumns=!0)):this._paginationItemsPerPage=c._evenColumnListItemsPerPage;this._delayLoadListingImagesInPagination(t);o.prototype.setResponseContent.call(this,t,i);this.setQuery(i.query);o.prototype.addReportLinkToNoResultCard.call(this,t,this._taskId,i);this._dataCategory!="House"&&this._addReportMissingEntityLinkToLocalListing(t,this._taskId,i);n.enableCopyCss&&this._copyCssToShell();this._logModulesImpressions()}},c.prototype._addReportMissingEntityLinkToLocalListing=function(n,t,i){var u=this,o;if(st&&st.showAddMissingBusinessLink){var f=this.panelRoot.select(".report-missing-business-link-container"),s=n.select("div[data-answerinfo]"),e=s.select(".query"),r=e.length>0?e[0].textContent:"";if(r=r||i&&i.query,o=this.getUserFacts(),f){var h={addMissingEntityLinkClicked:function(n){u.onAddMissingBusinessLinkClicked(n,u._taskId,r,r,o,4)}},c=this._controlTemplateFactory({templateText:rf,staticResources:h}),l=c.applyDataTemplate(this);f.append(l)}}},c.prototype.dispose=function(){o.prototype.dispose.call(this);this._hoverPoi=null;var n=this._taskId.replace(/\$/g,"");i("."+n).removeFromParent()},c.prototype.registerListItemEvents=function(){var t=this,r=this.panelRoot.select("a[data-entity]"),n=this.getPushpinPrimitives();r.for_each(function(r){var h=r.getAttribute("data-entity"),f=i.Internals.parseJSON(h),e=f.entity,o,s,u;if(e){for(s=n.length,u=0;u<s;u++)if(n[u].entity.id===e.id){o=n[u];break}t.registerListItemEvent(f,o,r)}})},c.prototype.registerListItemEvent=function(n,t,r){var f=this,u=i(r),e=function(i){return f._processMouseOver(n.id,t,i)},o=function(){return f._processMouseOut(t)};u.add_event("mouseenter",e).add_event("mouseleave",o);this._addEventsToEventList(u,"mouseenter",e);this._addEventsToEventList(u,"mouseleave",o)},c.prototype.InsertListItemCarousel=function(n,t){var i=this.processEntity(n,null,null,!0);i&&n.entity&&this.registerListItemEvent(n.entity,i,t)},c.prototype.processDirectionsData=function(n){n&&n.inData&&n.inData.requestorState&&this._transientLensViewModel.processDirectionsData(n)},c.prototype.processCollectionsData=function(n){this._transientLensViewModel.processCollectionsData(n)},c.prototype.processTravelData=function(n){n&&n.inData&&n.inData.requestorState&&n.inData.requestorState.entryPoint===u.LocalListing?this._transientLensViewModel.getButtonGroupViewModel().processSaveWithTravelData(n):this._transientLensViewModel.processTravelData(n)},c.prototype.getListingsHtmlContentForPrint=function(n){var t=this,i,u,r;return this.printTitleViewModel=this,this.printListingsViewModel=new tu(this.map,this._controlTemplateFactory,this.getPushpinPrimitives(),n,this.panelRoot),i={boolToDisplay:function(n){return t.boolToDisplay(n)},nullToDisplayNone:function(n){return t.nullToDisplayNone(n)},hideMatchedData:function(n){return t.hideIfMatchedData(n)},chooseIconSource:function(n){return t.chooseIconSource(n)}},this.titlePrintTemplate=new gt(tf,i),this.listingsPrintTemplate=new gt(nf,i),u=this._controlTemplateFactory({templateText:or,staticResources:i}),r=u.applyDataTemplate(this),r.length>0?r[0].outerHTML:""},c.prototype.chooseIconSource=function(n){var t="";return n&&(n===1&&(t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAXCAMAAAAm/38fAAAAQlBMVEVHcEyqKY+qKY+qKY+qKY+qKY+qKY+qKY+qKY+qKY+qKY////+qKY+wOJfKebncptHBZK7v1+r68vj05PHoxeHVlMftKC+aAAAAC3RSTlMAeN9JrzDvxRRgj9SxIBcAAAC1SURBVCjPfZHtEoUQFEV9lWQfJN7/Va+kJszc9XOvHNqHscbCldaKL6xHCjSE/MSbAsj5lLwjQG1vroEcbSVmQD9Ggw77chD0nfMur4bXQSu87fBYr2EGZAcIpgg1HriOqCIEjlEkiCIAOwH8F3HMzyo00nzH9Ys73Cgc9qtv4JwmLXdVoRehlVU6cf2gtdVrgPC+LAbUQh5DuV50Zvrk5QFlVaAQSgrdr92oe+XKsIlFys/HP2FZEe+D6e0PAAAAAElFTkSuQmCC"),n===2&&(t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAMAAADX9CSSAAAARVBMVEVHcEwAqrAAqrAAqrAAqrAAqrAAqrAAqrAAqrAAqrAAqrAAqrD///8UsbZiy88wur+/6uuA1dhDwMXX8vOv5Obv+vqf3+G0rBkKAAAAC3RSTlMAz6cnXOSPEIBAvytHJ6oAAAC3SURBVCjPdZHZDoQgDEVRdi+7Ov//qVPFUZDMeSE5N2lpy1hFC7UsixKategZP+YmERKIOaWUIyDFrckmV0mUXIEFgnsIgD1ry04fgTx6GPi987uHIS/xcT0fSMY4vHvjwekzZfCFvmSQB5+pwX8fBh/IW8TBR5pMA+tLrwANNg+FAua6ntTpdC1IwbeVVg9VjzLBb7fePKbrNBSg1GQruPW5UyKWeDymPTBX8ryuVJy90Nbap8IXq9AS1imhErwAAAAASUVORK5CYII="),n===3&&(t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAXCAMAAAAm/38fAAAAS1BMVEVHcEwAggAAggAAggAAggAAggAAggAAggAAggAAggAAggAAggD///8AggASixJgsWDP6M/v9+/f79+PyI+AwYCn1KdAoUC/4L9QqVBjJUhMAAAADHRSTlMAz4dJMK8QYL/oIHAyg2hSAAAAuUlEQVQoz32RWxKEIAwEFYyAMkEU1PufdBEfJVi1/TktESZNc9EJ0ppE15RIgwsjX3FPALu4bdExQP2Tt0DwNuMD0N5Ggyf7MDH0mY9Fns2YBxkstmCBOYYpsK1gqCSoPnAcoSQMplpsMEkA9gPwX/g6n7PQiLWI+YkCrhYO4ugbmD+TurOqtRTrVdZgymEOZjhbVMD+3MzvyIXchkP+0Rz4lacLpFWB1zWlaMu1KzpXTqr50En5+vgHNJ4TbfTHZhoAAAAASUVORK5CYII=")),t},c.prototype._parseCategoryData=function(n){var i,t=n.select("div[data-category]");t&&t.length===1&&(i=t.get_attr("data-category"));this.populateCardCategoryId(i)},c.prototype._logEntityCardHoverIfNecessary=function(n){if(n&&this._entityCardHoverStartTime&&Date.now()-this._entityCardHoverStartTime>=c._entityCardHoverTimeout){var t=this.getQuery()||"",i={logData:{feature:w.ListingCard,action:h.Hovered,data:{ID:n.id,Q:t,EP:u.LocalListing}}};e.invokeHandler(f.instrumentationDataHandlerKey,i);this._entityCardHoverStartTime=null}},c.prototype._logModulesImpressions=function(){var r,o,s,n,t;if(this.panelRoot&&(r=this.panelRoot.select("div[data-implog]"),r&&r.length))for(o=0;o<r.length;o++)if(s=r[o].getAttribute("data-implog"),s)try{if(n=i.Internals.parseJSON(s),n&&n.length)for(t=0;t<n.length;t++)n[t].AN&&n[t].CNT&&e.invokeHandler(f.instrumentationDataHandlerKey,{logData:{feature:ft.Search,action:h.Impression,data:{AN:n[t].AN,CNT:n[t].CNT,EP:u.LocalListing}}})}catch(c){}},c.prototype._processMouseOver=function(t,i){var r,u;n.enableInfoBox&&(r=i,r&&(r.viewState!==1&&r.viewState!==3&&(this.loadDelayedListingImagesInPagination(),r.viewState=1,r.zIndex=2,this._hoverPoi=r,r.entity.changed&&r.entity.changed.invoke({sender:r.entity}),sj_evt&&sj_evt.fire("pushpinhoverstarted",i),this._entityCardHoverStartTime=Date.now()),u=ot.mapsInfobox,u&&u.getOptions()&&u.getOptions().visible!==!1||r.viewState!==1||this.loadInfobox.invoke(i)))},c.prototype._processMouseOut=function(n){var i=n?n.viewState:null,t=this._hoverPoi;n&&t&&(n===t&&sj_evt&&sj_evt.fire("pushpinhoverstopped",n),i!==3&&(t.viewState=0,t.zIndex=this._paginationCurrentPage>0?1:0,t.entity.changed&&t.entity.changed.invoke({sender:t.entity}),this._hoverPoi=null,this._logEntityCardHoverIfNecessary(n.entity)));ot.mapsInfobox&&ot.mapsInfobox.setOptions({visible:!1})},c.prototype._buildLogData=function(n,t){return{logData:{feature:w.ListingCard,action:n,data:t}}},c.prototype.processSearchMapviewButtons=function(){var s=this,n=this.panelRoot.select("div[class=searchSuggestionModule]"),u,t,i;n&&n.length==1&&(u=o.prototype.parseSuggestionMetaData.call(this),u&&u.length!==0)&&(n[0].style.display="block",t=r._createElement("ul"),t.set_attr("class","searchSuggestionModule"),n.append(t),this.selectorReady().then(function(n){var i,r;t.set_attr("class","searchSuggestionModuleIcon");i=[];u.forEach(function(r){var u=s._drawCategoryItem(n,r,"searchSuggestionLink",function(n){return s._mapviewSuggestionClickHandler(n)});i.push(r.Name);u&&t.append(u)});r={logData:{feature:w.RecommendedSearch,action:h.Activated,data:{CAT:i.join(",")}}};e&&e.invokeHandler(f.instrumentationDataHandlerKey,r)}),n.removeFromParent(),i=this.panelRoot.select("div.recommendedSearchContainer"),i&&(i.getParent().insertBefore(n,i),i.removeFromParent()))},c.prototype._mapviewSuggestionClickHandler=function(n){var t,i,o,r;if(n&&n.target){for(t=n.target;t.parentNode;){if(t.nodeName.toLowerCase()==="a")break;t=t.parentNode}(n&&n.preventDefault(),t)&&(i=t.title,i)&&(o=this._buildLogData(h.Clicked,{AN:"SearchSuggestion",EP:u.LocalListing,DT:"SuggestionLinkDynamic."+i}),e.invokeHandler(f.instrumentationDataHandlerKey,o),r={},r.entryPoint=u.LocalListing,r.query=i,e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:r,type:s.localSearchTask}))}},c.prototype.updateAdvertising=function(t,i){var c,f,e,l,u,o,s,h;if(ut.isEnabled())try{var y=this.panelRoot.select("div.tna_ads_container"),a=n.suppressTxtAdsOnTnaAds&&y.length,v=n.listingMaxAdCount,r;v&&(n.isRenderAdsAtServer?(r=this.panelRoot.select("div.mapsTextAds"),c=fr.setShownAds(k.LI,r,tt.getImpressionGuid(this.panelRoot)),n.logServerRenderedAdData&&(f=0,e=this.panelRoot.select("div.overlay-container"),e&&e.length&&(l=e[0].getAttribute("data-ads"),l&&(f=parseInt(l))),c!==f&&ut.logError("Expected "+f+" ads, got "+c+", q="+i.query,"LI"))):(u=this.panelRoot&&this.panelRoot.select("div.adsContainer"),u&&u.length&&this.map&&(o=this.getEntities(),o&&o.length&&(n.adsFromWorkflow?(s=this.panelRoot.select("div.overlay-container"),s&&s.length&&(h=s[0].getAttribute("data-ads"),h&&h.length&&(this._ads||(this._ads=new ut(this._controlTemplateFactory,k.LI)),this._ads.setAds(h)))):this._ads||a||(this._ads=new ut(this._controlTemplateFactory,k.LI),this._ads.requestAds(i.query,o[0].getLocation().clone(),v,this._taskId)),this._ads&&(r=this._ads.getControl(),u.getParent().insertBefore(r,u),u.removeFromParent(),this._ads.adsPresent()||(r=null))))));a&&r&&r.length?r.set_style({display:"none"}):n.suppressTxtAdsOnTnaAds&&r&&r.length&&r.set_style({display:""})}catch(p){ut.logError(p)}},c.prototype.processPoiPagination=function(n,t){var y=this,e=this.panelRoot.select("div.entity-listing-container ul"),f,i,u,s;if(e&&e.length===1&&(f=e.select("li"),this._shouldPaginate(f))){var h=this._isPricePoiPagination(),o=Math.floor(f.length/this._paginationItemsPerPage)+(f.length%this._paginationItemsPerPage>0?1:0),l=r._createElement("div"),a=r._createElement("ul"),v=[];for(this._paginationCurrentPage=1,l.set_attr("class","bm_paginationModule"),i=0;i<=o+1;i++)u=r._createElement("a"),v.push(u),u.set_attr("href","#"),u.set_attr("data-pageNumber",i.toString()),i===0?u.set_attr("class",c._noDisplayClassName):i===o+1?u.set_attr("class","bm_rightArrow"):u.set_text(i.toString()),i===1&&u.set_attr("class","bm_active"),u.add_event("click",function(n){y._paginationHandler(n,v,o,f,t,h)}),s=r._createElement("li"),s.append(u),i>c._paginationVisiblePageButtons&&i<o+1&&s.set_attr("class",c._noDisplayClassName),a.append(s);l.append(a);e.getParent().append(l);this._paginationSetDisplayForItems(f,1,!0,t,h);n.disableListingRefresh=h?!1:!0;this._paginationListingItems=f}},c.prototype.setIconOnlyLimitBySegmentTypeOrCategoryId=function(){var e,t,r,i,u,f;if(n&&n.iconOnlyLimitBySegmentTypeOrCategoryId){if(e=this._getDataCategory(),!e)return;if(t=e.split("."),r=Object.keys(n.iconOnlyLimitBySegmentTypeOrCategoryId),r&&r.length&&t&&t.length)for(i=0;i<t.length;i++)if(u=t[i]&&t[i].toLowerCase(),u&&r.indexOf(u)>-1&&(f=n.iconOnlyLimitBySegmentTypeOrCategoryId[u],f&&!isNaN(parseFloat(f)))){this._poiManager.iconOnlyLimit=parseFloat(f);break}}},c.prototype.enableServerPagination=function(t,i,r){var h=n.categoriesWithServerPagination,y,e,c,u,o,l,s;if(!h||h.length<1)return!1;var a=!1,v=this._getDataCategory(),f=v&&v.split(".");if(f&&f.length)for(y=f.length,e=0;e<y;++e)if(c=f[e].toLowerCase(),c&&h.indexOf(c)>-1){a=!0;break}return a?(u=this.panelRoot.select("div.entity-listing-container ul"),!u||u.length!==1)?!1:this._serverPaginationControl&&!(i&&i.mapPannedOrZooomed)?(u.getParent().append(this._serverPaginationControl),!0):(o=u.select("li"),!o||!this._pushpins||o.length<this._paginationItemsPerPage||o.length!==this._pushpins.length)?!1:(l=new iu(this._controlTemplateFactory,this._paginationItemsPerPage,t,r),s=l&&l.getControl(),!s)?!1:(this._serverPaginationControl=s,u.getParent().append(s),!0):!1},c.prototype.resetServerPagination=function(){this._serverPaginationControl=null},c.prototype._getDataCategory=function(){if(!this._dataCategory&&this.panelRoot){var n=this.panelRoot.select("div[data-category]");n&&n.length&&(this._dataCategory=n.get_attr("data-category"))}return this._dataCategory},c.prototype._isPricePoiPagination=function(){var r,e,s,t,f;if(n.poiCountOverrideByCategoryId){for(r=!1,e=this._pushpins.length,t=0;t<e;++t)if(this._pushpins[t]&&this._pushpins[t].entity&&this._pushpins[t].entity.usePricePoi){r=!0;break}if(r){var o=this._getDataCategory(),i=o&&o.split("."),u=Object.keys(n.poiCountOverrideByCategoryId);if(u&&u.length&&i&&i.length)for(s=i.length,t=0;t<s;++t)if(f=i[t]&&i[t].toLowerCase(),f&&u.indexOf(f)>-1)return!0}}return!1},c.prototype._delayLoadListingImagesInPagination=function(n){var e=n.select("div.entity-listing-container ul"),t,r,i,u,f,o;if(e&&e.length===1&&(t=e.select("li"),t&&!(t.length<=this._paginationItemsPerPage))){for(r=this._paginationItemsPerPage;r<t.length;r++)if(i=t[r].getElementsByTagName("img"),i&&i.length)for(u=0;u<i.length;u++)f=i[u],o=f.getAttribute("src"),o&&(f.setAttribute("data-delayedsrc",o),f.setAttribute("src",""));this._paginationImageDelayLoaded=!0}},c.prototype.loadDelayedListingImagesInPagination=function(){var n=this._paginationListingItems,i,t,r,u,f;if(this._paginationImageDelayLoaded&&n&&n.length&&n.length>this._paginationItemsPerPage)for(this._paginationImageDelayLoaded=!1,i=this._paginationItemsPerPage;i<n.length;i++)if(t=n[i].getElementsByTagName("img"),t&&t.length)for(r=0;r<t.length;r++)u=t[r],f=u.getAttribute("data-delayedsrc"),f&&(u.setAttribute("src",f),u.setAttribute("data-delayedsrc",""))},c.prototype._paginationSetDisplayForItems=function(n,t,i,r,u){var f,e;if(n&&this._pushpins&&!(n.length<=this._paginationItemsPerPage)&&n.length===this._pushpins.length){if(i&&t===1)for(f=0;f<n.length;f++)f>=this._paginationItemsPerPage&&(n[f].style.display="none"),u?this._pushpins[f].zIndex=f<this._paginationItemsPerPage?1:0:f>=this._paginationItemsPerPage?(this._pushpins[f].entity.isPaginationReducedPoi=!0,this._pushpins[f].zIndex=0):this._pushpins[f].zIndex=1;else for(this.loadDelayedListingImagesInPagination(),f=0;f<n.length;f++)e=Math.floor(f/this._paginationItemsPerPage)+1===t,n[f].style.display=e?"list-item":"none",u||(this._pushpins[f].entity.isPaginationReducedPoi=!e),this._pushpins[f].zIndex=e?1:0;this._poiManager.setPrimitives(this._pushpins,!1);r&&r()}},c.prototype._paginationHandler=function(n,t,i,r,u,f){var s,e,o;if(n&&n.preventDefault(),!(t.length<i+2)){if(n&&n.target&&(s=n.target.getAttribute("data-pageNumber"),s)){if(e=parseFloat(s),isNaN(e))return;if(e<1){if(this._paginationCurrentPage<=1)return;this._paginationCurrentPage-=1}else if(e>i){if(this._paginationCurrentPage>=i)return;this._paginationCurrentPage+=1}else{if(this._paginationCurrentPage===e)return;this._paginationCurrentPage=e}for(this._paginationSetDisplayForItems(r,this._paginationCurrentPage,!1,u,f),o=1;o<=i;o++)o<t.length&&t[o].set_attr("class",o===this._paginationCurrentPage?"bm_active":"");this._paginationCurrentPage<=1?t[0].set_attr("class",c._noDisplayClassName):t[0].set_attr("class","bm_leftArrow");this._paginationCurrentPage>=i?t[t.length-1].set_attr("class",c._noDisplayClassName):t[t.length-1].set_attr("class","bm_rightArrow");i>c._paginationVisiblePageButtons&&(this._paginationCurrentPage-1>0&&t[this._paginationCurrentPage-1].getParent().get_attr("class").indexOf(c._noDisplayClassName)>-1?(t[this._paginationCurrentPage-1].getParent().set_attr("class",""),this._paginationCurrentPage+c._paginationVisiblePageButtons-2<t.length&&t[this._paginationCurrentPage+c._paginationVisiblePageButtons-1].getParent().set_attr("class",c._noDisplayClassName)):this._paginationCurrentPage+2<t.length&&t[this._paginationCurrentPage+1].getParent().get_attr("class").indexOf(c._noDisplayClassName)>-1&&(t[this._paginationCurrentPage+1].getParent().set_attr("class",""),this._paginationCurrentPage-c._paginationVisiblePageButtons+1>0&&t[this._paginationCurrentPage-c._paginationVisiblePageButtons+1].getParent().set_attr("class",c._noDisplayClassName)))}u&&u()}},c.prototype._shouldPaginate=function(n){return!n||!this._pushpins||n.length<=this._paginationItemsPerPage||n.length!==this._pushpins.length?!1:!0},c.prototype._copyCssToShell=function(){var t=i("#container .MicrosoftMap"),o,u;if(t&&t.length===0&&(r._isLocalOrRealEstateScenarioOverlayShownOnSerp()||r._isLocalOverlayShownOnSerp())&&(t=i(".v8OverlayMap.mapOverlayOnSerp .MicrosoftMap")),t&&t.length>0){var f=this.panelRoot.length>0&&this.panelRoot.select("style"),e=this._taskId.replace(/\$/g,""),n=t.select(".bm_ListingsCssContainer");n&&n.length!==0||(n=r._createElement("div"),n.add_class("bm_ListingsCssContainer"),n.appendTo(t));o=n.select("."+e);f&&f.length>0&&o.length===0&&n.length>0&&(u=r._createElement("div"),u.add_class(e),u.appendTo(n),f.appendTo(u))}},c._evenColumnListItemsPerPage=20,c._threeColumnListItemsPerPage=21,c._paginationVisiblePageButtons=9,c._noDisplayClassName="bm_noDisplay",c}(yr),l=function(o){function c(t,i,r,u,f){var e=o.call(this,i)||this,s;return e.map=t,e._trafficLayer=f,e._count=20,e._offset=0,e.pageProcessor=r,e.type="LocalSearch",e._taskUrlParams.push({param:"q",paramGetter:function(){return e._getQueryParam()}}),e._taskUrlParams.push({param:"segment",paramGetter:function(){return e._getSegmentParam()}}),e._taskUrlParams.push({param:"lf",paramGetter:function(){return e._getFiltersParam()}}),e.scrollLane=new g,e.laneScrolled=new g,e.mapsInfoboxOptions={showCloseButton:!1,zIndex:1006,showPointer:!1,visible:!0,htmlContent:null,location:null,autoAlignment:!0},c._poiHoverLoggingThresholdForEventLogging=n.hoverThreshold,e._logHelper=new vr(e.perfLog),e.setPercentLoaded(0),u&&(e._transientLensViewModel=u,e.disposables.push(e._transientLensViewModel.invalidateLayer.add(function(){return e.concatOverlayPrimitive()}))),c._overlayCloseBtnListenerAdded||(s=Microsoft.Maps.Internal._Gimme&&Microsoft.Maps.Internal._Gimme(".overlayCloseBtn")[0],s&&s.addEventListener&&(c._overlayCloseBtnListenerAdded=!0,s.addEventListener("click",function(){c._useBfpr=!1}))),e}return v(c,o),c.prototype.activate=function(n,t){o.prototype.activate.call(this,n,t);this.poiManager&&(this.poiManager.disableComputingMapViewForFirstTimeLoad=t.disableComputingMapViewForLoadingOnly);this._taskState=t;this._transientLensViewModel.setOptions({requestorId:this.id,requestorType:this.type});this._taskState&&this._taskState.content&&this.processResponse(this._taskState.content);this.getTitle()&&(this._initialTitle=this.getTitle(),t.directionsTaskId&&this._updateTitle())},c.prototype.deactivate=function(){if(c.mapsInfobox&&(c.mapsInfobox.setOptions({visible:!1}),c.mapsInfobox.preventAutoClose=!1),this.isSearchAlongRouteEnabled())this.disableSearchAlongRoute(!0,!1);this.viewModel&&this.viewModel.landMarkFilterRule&&this.map.getLandmarksManager().then(function(n){n.resetDataSource()});o.prototype.deactivate.call(this);this.viewModel.dispose()},c.prototype.setDisplayState=function(n){var t=this;o.prototype.setDisplayState.call(this,n);n.activationState&1&&this.viewModel&&this.viewModel.landMarkFilterRule&&this.map.getLandmarksManager().then(function(n){n.applyFilterOnDataSource(t.viewModel.landMarkFilterRule)});n.activationState&1&&n.prominence&1&&c._removeCardPrimer(this.map)},c.prototype.process=function(t,i){var u=t&&t.requestState,o,s,l;if(u){if(c._useBfpr&&(u.useBfpr=!0,this._taskState&&!this._taskState.useBfpr&&(this._taskState.useBfpr=!0)),u.action==0){this._taskState&&(this._taskState.keyRoutePoints=u.keyRoutePoints,this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>=2&&this._updateRoutePoints(this._getPointsString(this._taskState.keyRoutePoints)),(this.displayState&&this.displayState.activationState!==3||u&&u.cause!==1)&&this.poiManager.suppressViewChangeOnRefreshOnce(),this._refreshWithDelay({appliedFilterOption:new ct(u.directionsTaskId,"",null,!0)}));return}if(u.action==1){o=!1;this._updateRoutePoints(null);this.disableSearchAlongRoute(o);this._refreshWithDelay();return}if(u.searchEntitiesRequested)this.viewModel&&i&&i({processorId:this.id,data:this.viewModel.getEntities()});else if(u.trackingDataRequested)this.viewModel&&i&&i({processorId:this.id,data:{ImpressionGuid:this._getImpressionGuid(),TraceId:this._getTraceId()}});else if(this._taskState=u,this._taskState.query&&(this._taskState.query=this._taskState.query.trim()),!this._taskState.query&&this._taskState.category&&(this._taskState.query=""),this._taskState.query||this._taskState.id||this._taskState.category){s=this._taskState.id?nt.ID:nt.SB;this._searchPerfState=this._logHelper.perfStart(s);var e=this._createUrl(),f=this._taskState.passThruParam,h=n.formCodeMonitr;(!r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&h&&f&&f.toUpperCase().indexOf(h)===-1||f&&f.toLowerCase().indexOf("lemodule")>-1)&&(e+=f.indexOf("&")!==0?"&"+f:f);this._sendSearchRequest(e,t,i);l={Q:this._taskState.query?this._taskState.query:"",URL:e};this._logHelper&&this._logHelper.log(p.LSR,l,y.dynamicProperties.mapsIG)}}},c.prototype.processCallback=function(n){var i,u,f,t,r;n&&n.inData&&n.processorType&&n.outData&&(n.processorType===s.directionsTask?this.viewModel.processDirectionsData(n):n.processorType===s.collectionsTask?(i=n.inData.requestState,i&&i.action===yt.UpdateEntity&&i.data&&i.data.title&&this.type!==s.localListingTask&&(u=i.data.title,this.setTitle(u),f=this.viewModel,f.updatePoiTitle(u),f.resetPrimitives(this.poiManager),f.annotationControl.setCurrentName(u)),this.viewModel.processCollectionsData(n)):n.processorType===s.itineraryDetailsTask?this.viewModel.processTravelData(n):n.processorType===s.localSearchTask&&n.outData.length&&n.outData[0].data&&n.outData[0].data.content&&(t=n.outData[0].data.content,r=d.parseCategory(t),this._taskState=n.inData.requestState||this._taskState,this._resetMicropois(),this._taskState&&r&&!this._taskState.isFallbackRequery&&(this._isOutingsFallback(r,t)||this._isHotelsFallback(r,t)||this._isRestaurantsFallback(r,t)||this._fallbackIfNoResultsFoundInResponse(t))?(this._taskState.disableTaskActivate=!1,this._requestFallback(t)):(this.processResponse(t),this.scrollLane&&this.scrollLane.invoke&&this.scrollLane.invoke(this.panelRoot),this._logInstrumentationForLocalTopicsClick())))},c.prototype.serialize=function(n){var i,t;if(this._taskState&&(this._taskState.content=null,this._taskState.taskTitle||(this._taskState.taskTitle=this.getTitle()),this._taskState.primerPois=null,this._taskState.primerRequestUrl=null,this._taskState.primerParseSelector=null),n&&(this._reduceLatLonPrecisions(),this._taskState.shareDescription=this.getShareDescription(),this._taskState.fromSharing=!0,this.displayState.prominence===1))return this._buildTaskStateWithPrimerPois();if(this._taskState&&this._taskState.originalResponse){i={};for(t in this._taskState)t&&t.indexOf("originalResponse")<0&&this._taskState.hasOwnProperty(t)&&(i[t]=this._taskState[t]);return i}return this._taskState},c.prototype.getShareDescription=function(){return""},c.prototype.getCardIconInfo=function(){return{iconClass:"srcTsk",iconElements:this.getCardIcons(this.viewModel.getCardCategoryId())}},c.prototype._refreshWithDelay=function(n){var t=this;it.abortRequest(this._outstandingRefreshReqId);window.clearTimeout(this._resultsReqTimeoutHandler);this._resultsReqTimeoutHandler=Microsoft.Maps.setTimeout(function(){t._refresh(n)},pu.refreshTimeout)},c.prototype._refresh=function(n){var t=this,i,u,f,e;this._taskState.mapBounds=this._getLocalMapViewBounds();this._taskState.primerPois=null;this._taskState.cacheId=null;i=this._createUrl(n);i&&(this.setPercentLoaded(0),u=this._taskState&&this._taskState.id?nt.ID:nt.SB,n||(n={}),n.perfState=this._logHelper.perfStart(u),f=function(i){var u,f,e,o;t._showOrHideWaitLayer(!1);u=!0;try{n.perfState.end("NT");f=t._convertToResponseObject(i);e=d.getEntitiesFromResponse(f,t._taskState);u=t._shouldProcessResponseOnRefresh(e,n);u&&(t.processResponse(f,n),o=n.forceLogAsLocalListingTask?p.LLT:p.LLR,t._logActivated(o,n.forceLoggingEntryPoint),t._logInstrumentationForRequery(),t.displayState&&t.displayState.prominence===1&&r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&sj_evt&&sj_evt.fire("SearchResponseReceived",{IG:tt.getImpressionGuid(t.viewModel.panelRoot),primitives:t.viewModel.getPushpinPrimitives()}))}finally{u&&t._postRefresh()}},this._showOrHideWaitLayer(!0),e=function(){t._showOrHideWaitLayer(!1)},this._outstandingRefreshReqId=it.downloadGeneric(i,"srchrefresh",f,null,e,null,0))},c.prototype.getIconColorAndClassName=function(n){var t=this,i,r;if(this._taskState.cardBackgroundData){n(this._taskState.cardBackgroundData.cardBackgroundColor,this._taskState.cardBackgroundData.cardClassName);return}i=this._taskState&&this._taskState.listingCategoryPath?!0:this.viewModel.categoryFound;typeof i=="undefined"?n(null,null):i?(r=function(i){t._buildCardIcon(null,i,function(r){t._taskState.cardBackgroundData={cardBackgroundColor:r,cardClassName:"catid_"+i};n(t._taskState.cardBackgroundData.cardBackgroundColor,t._taskState.cardBackgroundData.cardClassName)})},this._taskState.listingCategoryPath?this.map.getTemplateSelector().then(function(){var n=yi.extractCategoryId(t._taskState.listingCategoryPath,!1);r(n)}):r(this.viewModel.getCardCategoryId())):n("#F7630C","catid_noCategory")},c.prototype.activateInfobox=function(t,r,u,f){var e=this,o=t.entity;u&&i.Browser.is_ie&&i.Browser.ie_version<12||f?c.mouseoverTimeout=0:u||c.mouseoverTimeout!==0||(c.mouseoverTimeout=500);window.clearTimeout(c.mouseoverDelayHandle);c.mouseoverDelayHandle=window.setTimeout(function(){var s,h,l,f,i;if((!c.mapsInfobox||!c.mapsInfobox.preventAutoClose)&&o&&(o.infoboxHtml&&o.infoboxHtml.length>0||r&&r.length>0)){if(s=new Microsoft.Maps.Location(t.geometry.y,t.geometry.x),e.mapsInfoboxOptions.htmlContent=r?r:o.infoboxHtml,e.mapsInfoboxOptions.location=s,h=u?new Microsoft.Maps.Point(4,4):new Microsoft.Maps.Point(10,10),e._taskState.scenarioKey){for(f=Object.keys(n.scenarioKeys),i=0;i<f.length;i++)if(n.scenarioKeys[f[i]]===e._taskState.scenarioKey){l=f[i];break}l&&n.singleEntityScenarios.indexOf(l)>=0&&(h=new Microsoft.Maps.Point(10,14))}e.mapsInfoboxOptions.offset=h;c.mapsInfobox?c.mapsInfobox.setOptions(e.mapsInfoboxOptions):(c.mapsInfobox=new Microsoft.Maps.MapsInfobox(s,e.mapsInfoboxOptions),c.mapsInfobox.setMap(e.map))}},c.mouseoverTimeout)},c.prototype._showOrHideWaitLayer=function(n){var t=this;n?this.displayState&&this.displayState.prominence===1&&this.displayState.activationState===1&&(this._waitlayerId=Microsoft.Maps.setTimeout(function(){t._showOrHideWaitLayer(!1)},3e3),i(".MicrosoftMap .bm_waitlayer").set_style({display:"block"})):(clearTimeout(this._waitlayerId),i(".MicrosoftMap .bm_waitlayer").set_style({display:"none"}))},c.prototype._shouldProcessResponseOnRefresh=function(n){return n&&n.length>0},c.prototype._shouldSuppressMapViewChangeOnRefresh=function(n){return n?n.mapPannedOrZooomed||n.isPaginated:!1},c.prototype._onPrimitivesChanged=function(n){var t=this._currentRefreshContext?this._shouldSuppressMapViewChangeOnRefresh(this._currentRefreshContext):!1;this._currentRefreshContext=undefined;this.poiManager&&this.poiManager.setPrimitives(n,t)},c.prototype._postRefresh=function(){},c.prototype._getTaskState=function(){return this._taskState},c.prototype._resetMicropois=function(){},c.prototype._logInstrumentationEventForEntityClick=function(){var r=n.sendMoreInstrumentationForOverlay||this._taskState.sendInstrumentationEventOnEntityClick,i=y.dynamicProperties.serpIG,t;r&&i&&(t=Microsoft.Maps.logger,t&&t.logObject({T:"CI.OverlayEntClick",feature:"LocalOverlay",action:"CI.OverlayEntClick",data:{}},i,!1))},c.prototype._logPoiHoverIfNecessary=function(n,t,i){var r=n.primitive.entity;r&&(n.newValue===1?this._poiHoverStartTimeStamp=Date.now():(this._poiHoverStartTimeStamp&&Date.now()-this._poiHoverStartTimeStamp>=c._poiHoverLoggingThresholdForEventLogging&&this._logPoiHover(r,t,i),this._poiHoverStartTimeStamp=null))},c.prototype._logPoiHover=function(n,t,i){if(this._getTaskState()){var u=this._getTaskState().query||"",r={logData:{feature:w.POI,action:h.Hovered,data:{ID:n.id,Q:u,EP:t,MP:!!i}}};this.isSearchAlongRouteEnabled()&&(r.logData.data.AL=!0);e.invokeHandler(f.instrumentationDataHandlerKey,r)}},c.prototype._logInstrumentationForRequery=function(){var i=y.dynamicProperties.serpIG,t;n.sendMoreInstrumentationForOverlay&&i&&(t=Microsoft.Maps.logger,t&&t.logObject({T:"CI.OverlayRequery",feature:"LocalOverlay",action:"CI.OverlayRequery",data:{}},i,!1))},c.prototype._logInstrumentationForScroll=function(){var t=y.dynamicProperties.serpIG;n.sendMoreInstrumentationForOverlay&&t&&(c._scrollTimeoutHandle&&window.clearTimeout(c._scrollTimeoutHandle),c._scrollTimeoutHandle=window.setTimeout(function(){var n=Microsoft.Maps.logger;n&&n.logObject({T:"CI.OverlayListingScroll",feature:"LocalOverlay",action:"CI.OverlayListingScroll",data:{}},t,!1)},500))},c.prototype._logInstrumentationForLocalTopicsClick=function(){var n,t;this._taskState&&this._taskState.disableTaskActivate===!0&&this._taskState.entryPoint==="LocalListing"&&(n=this._taskState.originIG,n&&(t={EP:"LocalTopics",Q:this._taskState.query?this._taskState.query:"",SNRO:this._taskState.scenarioKey,SIG:n,MIG:this._getMasterImpressionGuid(),TRACE:this._getTraceId(),CT:this._getListingContentType()},this._logHelper&&this._logHelper.log(p.LLT,t,n)))},c.prototype.processResponse=function(n,t){var i,r,u;this._taskState.impressionGuid=this._getImpressionGuid();this.viewModel.setResponseContent(n,this._getTaskState());i=this.viewModel.panelRoot.select("div[data-mapcardwidth]");r=i&&i.length&&i[0].getAttribute("data-mapcardwidth");r&&(u=parseInt(r),this.setRecommendedWidth(u),this.setCurrentWidth(u));this.setTaskComplete(t)},c.prototype.setTaskComplete=function(n){this.setPercentLoaded(1);this._taskState.mapBounds=this._getLocalMapViewBounds();this.serializableObjectChanged.invoke({magnitude:0});var t=this.viewModel.getPushpinPrimitives();t&&(this._currentRefreshContext=n,this.setMapPrimitives(t));c._removePoiPrimerLayer(this.map)},c.prototype._logActivated=function(n,t){var w=this._taskState.fullQuery||this._taskState.query,e=w||this._taskState.id,o,y,i,f,r,s,h,c,l,u,a,v;e||(e="");o=n===p.LLR?"":this._taskState.entryPoint||"";t&&(o=t);y=this._taskState.scenarioKey||"";i={EP:o,Q:e,BB:this._tryGetBounds(),SNRO:y,SIG:this._getImpressionGuid(),MIG:this._getMasterImpressionGuid(),TRACE:this._getTraceId()};i&&i.SNRO&&i.SNRO.indexOf("ERR")!==-1&&(i.AAP=this._getAnswerPicked());n===p.LDT&&(f=this.viewModel&&this.viewModel.getEntities&&this.viewModel.getEntities(),r=f&&f.length&&f[0],i.LT=r&&r.getLocationType?r.getLocationType():"",i.SGMT=r&&r.getSegmentTypes?r.getSegmentTypes():null,s=r.getPrimaryCategoryPath&&r.getPrimaryCategoryPath(),s&&(i.CAT=s),h=this._taskState.adsLog,h&&(i.AD=h),c=r.getTitle&&r.getTitle(),c&&(i.RE=c),this._logEntityIdType(i,r),l=r.getVdpId&&r.getVdpId(),l&&(i.VDPID=l));u=this._taskState.keyRoutePoints;u&&u.length>=2&&(a=u[0],v=u[u.length-1],i.AL=!0,i.ST=[a.latitude,a.longitude],i.EN=[v.latitude,v.longitude]);n===p.LLT&&(i.CT=this._getListingContentType());this._logHelper.log(n,i,i.SIG)},c.prototype._logEntityIdType=function(n,t){var i=t.id;i&&(i.indexOf("sid:")===0?n.SID=i.substr(i.indexOf(":")+1):i.indexOf("ypid:")===0?n.YPID=i.substr(i.indexOf(":")+1):i.indexOf("eventId:")===0?n.EID=i.substr(i.indexOf(":")+1):i.indexOf("geoId:")===0&&(n.GID=i.substr(i.indexOf(":")+1)))},c.prototype._getLocalMapViewBounds=function(){var t=et.getMapBounds(this.map,!0),n=[];return n.push(t.getNorth()),n.push(t.getWest()),n.push(t.getSouth()),n.push(t.getEast()),n},c.prototype._getListingContentType=function(){var t=this.panelRoot.select("div.overlay-listings").get_attr("data-listingMetadata"),n;if(t)try{if(n=JSON.parse(t),n)return n.ContentType}catch(i){}return""},c.prototype._getTotalResultCount=function(n){var t,i,r;if(!n)return 0;if(t=n.select("div.overlay-listings").get_attr("data-listingMetadata"),t)try{if(i=JSON.parse(t),i)return r=i.TotalCount,parseInt(r)}catch(u){}return 0},c.prototype._getImpressionGuid=function(){return tt.getImpressionGuid(this.panelRoot)},c.prototype._getMasterImpressionGuid=function(){return tt.getMasterImpressionGuid()},c.prototype._getTraceId=function(){var n=this.panelRoot.select("div[data-traceid]"),t;return n&&n.length===1&&(t=n[0].getAttribute("data-traceid"),t)?t:""},c.prototype._contextMenuInvoked=function(n){n?(this._contextMenuPrimitive=n.primitive,this._contextMenuPrimitive&&(this._contextMenuPrimitive.viewState=0),this._contextMenuPrimitiveBucket=n.primitive.bucket,this._contextMenuPrimitiveViewState=this._contextMenuPrimitive.viewState,this.poiManager.suppressViewChangeOnRefreshOnce(),this._transientLensViewModel.show(n)):(this.poiManager.suppressViewChangeOnRefreshOnce(),this._transientLensViewModel.hide())},c.prototype._onPoiViewStateChanged=function(){},c.prototype.registerViewModelEvents=function(){var n=this;this.disposables.push(this.viewModel.changed.add(function(){var t=n.viewModel.getCardCategoryId();t&&(n.map.getTemplateSelector().then(function(i){i&&i.getCategoryIconTemplate(function(t){var i=t&&t.iconColor;i&&n.poiManager&&n.poiManager.setIconColorFromCard&&n.poiManager.setIconColorFromCard(i)},t)}),n.changed.invoke({name:"iconClass"}))}));this.disposables.push(this.viewModel.catIdPopulated.add(function(){n.changed.invoke({name:"catId"})}))},c.prototype.updateMapBounds=function(n){var t=this;this.disposables.push(this.map.getFrameManager().frameRendered.addOne(function(){tr.areEqual(t.map.getView(),n)&&(t._taskState.mapBounds=t._getLocalMapViewBounds(),t.serializableObjectChanged.invoke({magnitude:0}))}))},c.prototype.concatOverlayPrimitive=function(){var n=this._transientLensViewModel.getPrimitive();n?this.showOverlayPrimitive(n):this.hideOverlayPrimitive()},c.prototype.showOverlayPrimitive=function(n){this._contextMenuPrimitive.bucket&&delete this._contextMenuPrimitive.bucket;this._contextMenuPrimitive.viewState=3;this._contextMenuPrimitive.entity.changed&&this._contextMenuPrimitive.entity.changed.invoke();n.viewState=3;var t=this.viewModel.getPushpinPrimitives();this.setMapPrimitives(t.concat(n))},c.prototype.hideOverlayPrimitive=function(){this._contextMenuPrimitive&&(this._contextMenuPrimitiveBucket&&(this._contextMenuPrimitive.bucket=this._contextMenuPrimitiveBucket),this._contextMenuPrimitive.viewState=this._contextMenuPrimitiveViewState,this._contextMenuPrimitive.entity.changed&&this._contextMenuPrimitive.entity.changed.invoke(),this._onPoiViewStateChanged({primitive:this._contextMenuPrimitive,oldValue:3,newValue:this._contextMenuPrimitiveViewState}));var n=this.viewModel.getPushpinPrimitives();this.setMapPrimitives(n)},c.prototype._tryGetBounds=function(){try{return et.getMapBounds(this.map).bounds}catch(n){return[]}},c.prototype._createUrl=function(t,i,f){var e,ht,a,o,h,s,w,g,b,v,nt,tt,it,ct,rt,lt,at,vt,k,l,ft,yt,pt,p,ot,d,st;return this._taskState&&(e=this._getRequestUrlFormat().replace("{mkt}",y.dynamicProperties.market).replace("{appid}",y.dynamicProperties.appId),a=this._getLocationInfo(),r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&(this._taskState.fullQuery=this._taskState.fullQuery||this._taskState.query),o=this._taskState.id,s="",this._taskState.localFilters&&(ht=!0),r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&this._taskState.localFilters||(this._taskState.filterUrlParam?s=this._taskState.filterUrlParam+"%20":o&&o.indexOf("ypid:")===0?(h=n.localFilterFormat,s=encodeURIComponent(h.replace("{ypid}",o.substring(5))+" ")):o&&o.indexOf("sid:")===0?(h=n.entityFilterFormat,s=encodeURIComponent(h.replace("{sid}",o.substring(4))+" ")):o&&o.indexOf("eventId:")===0?(h=n.eventFilterFormat,b=o.indexOf("eventParentId:"),b!==-1?(w=o.substring(8,b-1),g=o.substring(b+14)):(w=o.substring(8),g=w),s=encodeURIComponent(h.replace("{eventId}",w).replace("{eventParentId}",g).replace("{latlong}",this._taskState.latLongForEventRequery).replace("{city}",this._taskState.locationForEventRequery)+" ")):o&&o.indexOf("vdpid:")===0&&(h=n.vdpIdFilterFormat,s=encodeURIComponent(h.replace("{vdpid}",o.substring(6))+" "))),v=i!==undefined?i.toString():this._offset.toString(),s?(it=f!==undefined?f.toString():this._taskState.poiCount&&!isNaN(parseFloat(this._taskState.poiCount))?this._taskState.poiCount:this._count.toString(),e+="&count="+it+"&ecount="+it+"&first="+v+"&efirst="+(parseInt(v)+1).toString(),e+=a):(nt=f!==undefined?f.toString():this._taskState.entryPoint===u.DirectionsWaypointSearch?n.directionsSearchCount.toString():this._taskState.poiCount&&!isNaN(parseFloat(this._taskState.poiCount))?this._taskState.poiCount:this._count.toString(),e+="&count="+nt+"&ecount="+nt+"&first="+v+"&efirst="+(parseInt(v)+1).toString()+a,this._taskState.localFilters&&(s+=encodeURIComponent(this._taskState.localFilters+" ")),tt=this._taskState.scenarioKey,(ht||t&&t.mapPannedOrZooomed)&&n.disableOSearchScenarioKeys&&tt&&n.disableOSearchScenarioKeys.indexOf(tt)>-1&&(e+=c._disableOSearchParameter)),this._taskState.chainId&&(e+="&chain="+this._taskState.chainId,n.sendCarouselRead&&(s+=encodeURIComponent('carouselread:"true" '))),ct=this._taskState.taskTitle||"",rt=this._taskState.query||this._taskState.taskTitle||s||this._taskState.category,r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&!a&&(rt=this._taskState.fullQuery),lt=encodeURIComponent(rt.trim()),typeof Base64Encoder!="undefined"&&(this._taskState.asName&&(at=Base64Encoder.stringToBase64(this._taskState.asName),s+=encodeURIComponent('een:"'+at+'" ')),this._taskState.asFormattedAddress&&(vt=Base64Encoder.stringToBase64(this._taskState.asFormattedAddress),s+=encodeURIComponent('eea:"'+vt+'" '))),this._taskState.extraFuiAugmentations&&(s+=encodeURIComponent(this._taskState.extraFuiAugmentations+" ")),n.sendSatrFui&&this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>=2&&(s+=encodeURIComponent('satr:"true" ')),s+=this._getCacheId(),e=e.replace("{title}",encodeURIComponent(ct)),e=e.replace(new RegExp("{query}","gi"),lt).replace("{filter}",s),e=e.replace("{tid}",c._tabID),k=this._taskState.keyRoutePoints,k&&k.length>=2&&(e+="&routePoints={points}",e=e.replace("{points}",this._getPointsString(k)),e.indexOf("overlaybfpr")>-1&&e.indexOf(c._disableOSearchParameter)===-1&&(e+=c._disableOSearchParameter)),l="",this._taskState.primerPois&&this._taskState.primerPois.length>0&&(this._taskState.primerPois.forEach(function(n){l+=n.entity.id+","}),l=l.substr(0,l.length-1),l&&(e+="&localypids="+l)),this._taskState.startDate&&this._taskState.endDate&&(e+="&ckin="+this._taskState.startDate+"&ckout="+this._taskState.endDate),ft=this._taskState.filterUrlParam&&this._taskState.filterUrlParam.indexOf("sid:")>-1,yt=ft&&(this._taskState.filterUrlParam.indexOf('disp:"itr"')>-1||this._taskState.filterUrlParam.indexOf('disp:"itrlist"')>-1),e.indexOf("overlaybfpr")>-1&&!yt&&(this._taskState.id&&this._taskState.id.indexOf("sid:")===0||ft)&&(e=e.replace("[AplusAnswer",'[AplusAnswer RequeryPage="Default"')),pt=r._getUrlParam(window.location,"overrideBfprAnswerPicker"),pt=="true"&&(e+="&overrideBfprAnswerPicker=true"),a&&e.indexOf("localMapView")<0&&(e+=a)),p=n.formCodeMonitr,p&&window.location.href.toUpperCase().indexOf(p)>-1&&e.toUpperCase().indexOf(p)===-1&&(e+="&FORM="+p),this._updateTitle(),!n.adsFromWorkflow||!ut.isEnabled()||t&&t.mapPannedOrZooomed||(ot=this._taskState.entryPoint,ot===u.DirectionsWaypointSearch||this._taskState.supressAds||(e+="&ads=1",d=et.getMapCenter(this.map),d&&(e+="&cp="+d.latitude+"~"+d.longitude),ut.logWorkflowQueryEvent(ot))),e=e.replace("{originIG}",this._taskState.originIG?this._taskState.originIG:""),st=Logger.getOverlayType(),st&&(e+="&OVRLY="+st),this._taskState&&this._taskState.isFallbackRequery&&this._taskState.fallbackScenario&&(e+="&isFallbackQuery=true"),r._getIsSlideCardEnabled()&&this._taskState.disableWideCard&&(e+="&widecard=false"),this._isThreeColumnsOk(t)&&(e+="&3colok=true"),e},c.prototype._isThreeColumnsOk=function(t){return _w&&_w.innerWidth&&n&&n.threeColumnMinBrowserWidth&&_w.innerWidth>=n.threeColumnMinBrowserWidth&&(!t||!t.isPaginated&&!t.appliedFilterOption&&!t.filterValueChanged&&!t.mapPannedOrZooomed)||this._taskState&&this._taskState.isThreeColumns?!0:!1},c.prototype.enableSearchAlongRoute=function(n){this._taskState&&n&&(this._taskState.directionsTaskId=n,this._invokeListenersAction(2,n))},c.prototype.disableSearchAlongRoute=function(n,t){t===void 0&&(t=!0);this._taskState&&(this._taskState.directionsTaskId&&n&&this._invokeListenersAction(3,this._taskState.directionsTaskId),this._taskState.keyRoutePoints=[],this._taskState.directionsTaskId=null,t&&this._refreshWithDelay())},c.prototype.isSearchAlongRouteEnabled=function(){return this._taskState&&this._taskState.directionsTaskId!=null},c.prototype._getAnswerPicked=function(){var n=this.panelRoot.select("div[data-answerpicked]"),t;return n&&n.length===1&&(t=n[0].getAttribute("data-answerpicked"),t)?t:""},c.prototype.microPoiRequestForLocalOverlayIsAllowed=function(){return this._taskState&&this._taskState.entryPoint&&r._isLocalOverlayShownOnSerp()&&(this._taskState.isFallbackRequery||this._taskState.entryPoint.lastIndexOf(u.Permalink)>-1)&&this._peekForLocalOverlayCategoryId(this.panelRoot)?!0:!1},c.prototype.sendPaginationRequest=function(n,t,i){var f=this,e,o,s;this._taskState.mapBounds=this._getLocalMapViewBounds();this._taskState.primerPois=null;this._taskState.entryPoint=u.ServerPagination;e=this._createUrl({isPaginated:!0},n,t);e&&(this.setPercentLoaded(0),o=function(n){f._showOrHideWaitLayer(!1);var u=f._convertToResponseObject(n),t=d.getEntitiesFromResponse(u,f._taskState);t&&t.length?(i.updateChevrons(t.length),f.processResponse(u,{isPaginated:!0}),f.displayState&&f.displayState.prominence===1&&r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&sj_evt&&sj_evt.fire("SearchResponseReceived",{IG:tt.getImpressionGuid(f.viewModel.panelRoot),primitives:f.viewModel.getPushpinPrimitives()}),f.scrollLane.invoke(f.panelRoot),sj_evt.fire("OnCardRefresh",f.panelRoot,f.stackId)):i.updateChevrons(0)},this._showOrHideWaitLayer(!0),s=function(){f._showOrHideWaitLayer(!1);i.updateChevrons(0)},it.downloadGeneric(e,"pagination",o,null,s,null,0))},c.prototype._getCacheId=function(){var n="";return this._taskState.cacheId&&(n=encodeURIComponent('cacheid:"'+this._taskState.cacheId+'" ')),n},c.prototype._invokeListenersAction=function(n,t){var i={action:n,listenerId:this.id};e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:i,type:s.directionsTask,taskId:t})},c.prototype._updateTitle=function(){this._initialTitle&&(this._taskState&&this._taskState.directionsTaskId&&this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>0?this.setTitle(r._formatString(t.L_LocalSearch_SearchAlongYourRouteTitle,this._initialTitle)):this.setTitle(this._initialTitle))},c.prototype._getPointsString=function(n){var t=n.map(function(n){return n.latitude+","+n.longitude});return t.join(",")},c.prototype._sendSearchRequest=function(t,u,f){var a=this,s=!0,o=i(".cardPrimer"),e,h,l;if(!c._cardPrimerConsumed&&!this._taskState.isFallbackRequery&&this.map.getConfig().enablePoiPrimer&&o&&o.length>0&&(e=o.select(".contentRoot"),e&&e.length>0&&e[0].children.length>0))if(c._cardPrimerConsumed=!0,this._parseResponse(e[0].innerHTML,u,f),n.sendRequestForContentFirst)s=!1;else return;t&&(h=this._taskState&&this._taskState.id?nt.ID:nt.SB,l=this._logHelper.perfStart(h),sj_evt.fire("v8SearchRequestStarted"),it.downloadGeneric(t,"search",function(n){(l.end("NT"),sj_evt.fire("v8SearchResponseReceived"),(!r._isSmallMapShownOnSerp()||y.dynamicProperties.prefetchingResultsOnSerp||y.dynamicProperties.prefetchingDetailsOnSerp)&&s)&&(a._parseResponse(n,u,f),sj_evt.fire("v8SearchResponseParsed"))},null,null,null,0))},c.prototype._addImgUrlsToTaskState=function(n){var f,t,e,r,u,o;for(this._taskState.imgUrls=[],f=n.select(".mapsCustomInfoCard, .iclc, .iaplanner, [data-ovl], .entity-listing-container"),t=0;t<f.length&&this._taskState.imgUrls.length<4;t++)for(e=i(f[t]).select("img"),r=0;r<e.length&&this._taskState.imgUrls.length<4;r++)u=e[r].getAttribute("src"),o=u&&u.match("/th/?"),o&&o.length>-1&&this._taskState.imgUrls.push(u)},c.prototype._isInLocalOverlayCategoryIdList=function(t){var i,r;if(t&&n&&n.localOverlayOnSerpCategoryIDs&&(i=t.split("."),i&&i.length))for(r=0;r<i.length;++r)if(i[r]&&n.localOverlayOnSerpCategoryIDs.indexOf(i[r])>-1)return!0;return!1},c.prototype._isHotelListingRequeryOnOverlay=function(){var t=this._taskState.selectedCategoryId||this._taskState.category;return r._isLocalOverlayShownOnSerp()&&this._taskState.isFallbackRequery&&this._taskState.fallbackScenario&&n.multiEntityScenarios.indexOf(this._taskState.fallbackScenario)>-1&&this._isInHotelCategoryIdList(t)?!0:!1},c.prototype._isInHotelCategoryIdList=function(t){var i,u,r;if(t&&n&&n.poiCountOverrideByCategoryId&&(i=t.split("."),u=Object.keys(n.poiCountOverrideByCategoryId),u&&u.length&&i&&i.length))for(r=0;r<i.length;++r)if(i[r]&&u.indexOf(i[r])>-1)return!0;return!1},c.prototype._getPoiCountOverrideIfAny=function(t){var i,f,r,u;if(t&&n&&n.poiCountOverrideByCategoryId&&(i=t.split("."),f=Object.keys(n.poiCountOverrideByCategoryId),f&&f.length&&i&&i.length))for(r=0;r<i.length;++r)if(u=i[r]&&i[r].toLowerCase(),u&&f.indexOf(u)>-1&&n.poiCountOverrideByCategoryId[u])return n.poiCountOverrideByCategoryId[u];return null},c.prototype._getRequestUrlFormat=function(){return r._isTravelOverlayShownOnSerp()?n.fallbackRequestUrlFormatForTravelOverlayOnSerp&&n.fallbackRequestUrlFormatForTravelOverlayOnSerp.length>10&&this._taskState&&this._taskState.isFallbackRequery?n.fallbackRequestUrlFormatForTravelOverlayOnSerp:(c._useBfpr=!0,this._taskState&&(this._taskState.useBfpr=!0),n.requestUrlFormatForTravelOverlayOnSerp):this._taskState.isFallbackRequery&&this._taskState.fallbackCategory&&this._taskState.fallbackCategory.toLowerCase().indexOf("attraction")>-1?this._taskState&&this._taskState.useBfpr?n.useBfprRequestUrlFormat:n.requestUrlFormat:n.fallbackRequestUrlFormat&&n.fallbackRequestUrlFormat.length>10&&this._taskState&&this._taskState.entryPoint&&this._taskState.isFallbackRequery?n.fallbackRequestUrlFormat:n.requestUrlFormatForEventDetailCard&&n.requestUrlFormatForEventDetailCard.length>10&&this._taskState&&(this._taskState.filterUrlParam&&this._taskState.filterUrlParam.indexOf("eventId")!==-1||this._taskState.id&&this._taskState.id.indexOf("eventId")!==-1)?n.requestUrlFormatForEventDetailCard:(this._taskState&&this._taskState.useBfpr&&(c._useBfpr=!0),n.fallbackBySegmentRequestUrlFormat&&n.fallbackBySegmentRequestUrlFormat.length>10&&this._taskState&&this._taskState.isFallbackRequery&&this._taskState.useBfpr)?n.fallbackBySegmentRequestUrlFormat:c._useBfpr?n.useBfprRequestUrlFormat:this._taskState&&this._taskState.useBmfp?n.useBmfpRequestUrlFormat:n.requestUrlFormat},c.prototype._peekForLocalOverlayCategoryId=function(t){if(t&&n&&n.localOverlayOnSerpCategoryIDs){var i=d.parseCategory(t);return i&&(this._taskState.category=i),this._isInLocalOverlayCategoryIdList(i)}return!1},c.prototype._peekForNoResult=function(n){var t,i;return n&&(t=n.select("div[data-answerinfo]"),t&&t.length)?(i=t.get_attr("data-answerinfo"),i==="0"):!1},c.prototype._useBfprFallbackBySegmentFound=function(t,r){var f=n.useBfprFallbackSegments,u,e,c,l,s,h,a,o;if(f&&f.length&&this._taskState&&this._taskState.useBfpr&&!this._taskState.useBmfp&&n.fallbackBySegmentRequestUrlFormat&&n.fallbackBySegmentRequestUrlFormat.length>10){if(t){if(u=t.split("."),u&&u.length)for(e=0;e<u.length;++e)if(u[e]&&f.indexOf(u[e])>-1)return!1}else if(r){if(c=r.select("[data-answerinfo]").get_attr("data-answerinfo"),c&&f.indexOf(c)>-1)return!1;for(l=r.select("div.overlay-taskpane"),s=0;s<l.length;s++)if(h=l[s].getAttribute("data-entity"),h&&h.length&&(a=i.Internals.parseJSON(h),o=a&&a.entity,o&&o.segmentTypes&&o.segmentTypes.length>0&&o.segmentTypes.filter(function(n){return f.indexOf(n)>-1}).length>0))return!1}return!0}return!1},c.prototype._isHotelsFallback=function(t,i){return r._isHotelsCategory(t)&&n.enableCustomHotelsExperience?(this._taskState.category=t,this._taskState.pivotEntity=i&&i.select("div[data-pivot]").get_attr("data-pivot"),!0):!1},c.prototype._isRestaurantsFallback=function(t,i){return r._isRestaurantCategory(t)&&n.enableCustomRestaurantsExperience?(this._taskState.category=t,this._taskState.pivotEntity=i&&i.select("div[data-pivot]").get_attr("data-pivot"),!0):!1},c.prototype._isRealEstateFallback=function(n,t){return r._isHouseCategory(t)&&d.parseAnswerInfo(n,this._taskState).intentKey==="multiEntity"?(this._taskState.originalResponse=n,!0):!1},c.prototype._isOutingsFallback=function(n){var t=n&&n.toLowerCase(),i=t&&(t.indexOf("attraction")>-1||t.indexOf("protectedsite")>-1),r=[u.SearchBox,u.SearchButton,u.Permalink];return this._taskState&&i&&!this._taskState.poiCount&&r.indexOf(this._taskState.entryPoint)>-1?(this._taskState.poiCount="50",!0):!1},c.prototype._fallbackIfNoResultsFoundInResponse=function(t){return!(this._taskState&&this._taskState.useBmfp)&&n.fallbackRequestUrlFormat&&n.fallbackRequestUrlFormat.length>10&&this._peekForNoResult(t)},c.prototype._parseResponse=function(t,i,o){var h=this._convertToResponseObject(t),a;this._taskState||(this._taskState=i.requestState);this._taskState.isFallbackRequery&&r._isHouseCategory(this._taskState.category||this._taskState.searchQueryCategory)&&this._taskState.originalResponse&&this._peekForNoResult(h)&&(h=this._taskState.originalResponse,this._taskState.originalResponse=null);this._addImgUrlsToTaskState(h);this._taskState.searchPerfState=this._searchPerfState;var v=this._taskState.entryPoint,y=v===u.TaskBar&&this._checkDirectionsIntent(h.select("[data-answerinfo]").get_attr("data-answerinfo")),c=d.parseCategory(h),l=this._useBfprFallbackBySegmentFound(c,h);if(this._taskState.disableTaskActivate&&!y){if(a=this._peekForNoResult(h),!this._taskState.isFallbackRequery&&(a||l)&&(n.fallbackRequestUrlFormat&&n.fallbackRequestUrlFormat.length>10||l||n.fallbackRequestUrlFormatForTravelOverlayOnSerp&&n.fallbackRequestUrlFormatForTravelOverlayOnSerp.length>10&&r._isTravelOverlayShownOnSerp())){this._taskState.originalProcessInputData=i;i.requestorId||(this._taskState.originalProcessInputData.requestorId=this.id);this._requestFallback(h,l);a&&o&&(this._taskState.originalCallback=o);return}this._taskState.isFallbackRequery&&this._taskState.originalCallback?this._taskState.originalCallback({originalProcessInputData:this._taskState.originalProcessInputData,data:{content:h,entities:d.getEntitiesFromResponse(h,this._taskState)}}):o&&o({originalProcessInputData:this._taskState.isFallbackRequery?this._taskState.originalProcessInputData:null,data:{content:h,entities:d.getEntitiesFromResponse(h,this._taskState)}})}else!this._taskState.isFallbackRequery&&(this._isOutingsFallback(c,h)||this._isHotelsFallback(c,h)||this._isRestaurantsFallback(c,h)||this._fallbackIfNoResultsFoundInResponse(h)||l)?this._requestFallback(h,l):!this._taskState.isFallbackRequery&&n.fallbackRequestUrlFormatForTravelOverlayOnSerp&&n.fallbackRequestUrlFormatForTravelOverlayOnSerp.length>10&&r._isTravelOverlayShownOnSerp()&&this._peekForNoResult(h)?this._requestFallback(h):r._isFeatureEnabled("verticalZipcode")&&r._isZipCodeCategory(this._taskState.category||c)?(this._taskState.category||(this._taskState.category=c),this._shouldRequeryForZipCode(h,this._taskState)?(this._taskState.originalResponse=h,e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:this._taskState,type:s.polygonListingTask})):(this._taskState.originalResponse&&(this._mergeResponses(h,this._taskState.originalResponse),delete this._taskState.originalResponse),d.parseResponse(h,this._taskState,this._trafficLayer,this.map))):d.parseResponse(h,this._taskState,this._trafficLayer,this.map)},c.prototype._requestFallback=function(t,i){var h,r,o,u,l,c,a;i===void 0&&(i=!1);h="";r="";t&&(o=t.select("div[data-answerinfo]"),o&&o.length&&(r=o.get_attr("data-answerinfo"),r&&(h=n.scenarioKeys[r])));this._taskState.isFallbackRequery=!0;this._taskState.fallbackScenario=r;this._taskState.fallbackCategory=d.parseCategory(t);u={Q:this._taskState.query?this._taskState.query:this._taskState.fullQuery?this._taskState.fullQuery:"",EP:this._taskState.entryPoint,SNRO:h};u.SIG=tt.getImpressionGuid(t);u.MIG=tt.getMasterImpressionGuid();this._logHelper&&this._logHelper.log(p.FLBK,u,u.SIG);l=this._peekForNoResult(t)?!1:!0;l&&!i?(c=d.parseAnswerInfo(t,this._taskState),a=c.intentKey==="multiEntity"?s.localListingTask:c.intentKey==="singleEntity"?s.localDetailsTask:s.localSearchTask,d.invokeTask(a,t,this._taskState,!1)):e.invokeHandler(f.taskProcessDataHandlerKey,{requestState:this._taskState,type:s.localSearchTask})},c.prototype._checkDirectionsIntent=function(t){return n.directionsIntentDrivingScenarios.indexOf(t)>=0?!0:n.directionsIntentTransitScenarios.indexOf(t)>=0||n.directionsIntentWalkingScenarios.indexOf(t)>=0?!0:void 0},c.prototype._shouldRequeryForZipCode=function(n,t){var e=!1,i,f,u;return r._isZipCodeCategory(t.category)&&(i=this._getItemCountsFromResponse(n),i&&(f=i[1]+i[2],u=t.originalResponse&&this._getItemCountsFromResponse(t.originalResponse),u&&(f+=u[1]+u[2]),e=f<i[0])),e},c.prototype._getItemCountsFromResponse=function(n){var t=n.select("div.overlay-listings").get_attr("data-listingMetadata");if(t.length>0){var i=JSON.parse(t),r=parseInt(i.TotalCount),u=parseInt(i.BlockedCount),f=n.select(".listings-item").length;return[r,u,f]}return null},c.prototype._mergeResponses=function(n,t){var r=this._getItemCountsFromResponse(n),u=this._getItemCountsFromResponse(t);if(r&&u){var f="data-listingMetadata",e=n.select("div.overlay-listings"),h=e.get_attr(f),o=JSON.parse(h);o.BlockedCount=(r[1]+u[1]).toString();e.set_attr(f,JSON.stringify(o));var s=".listings-item",c=n.select(s).getParent(),l=t.select(s),a=n.select(".b_vList");l.for_each(function(n){a.insertBefore(i(n).getParent(),c)})}},c.prototype._tryParsingWithDOMParser=function(n){try{var t=new DOMParser;return i(t.parseFromString("<div>"+n+"<\/div>","text/html").firstChild.childNodes[1].firstChild)}catch(r){return pi.assert(!1,"Error parsing the response: "+r),null}},c.prototype._convertToResponseObject=function(n){var t=this._tryParsingWithDOMParser(n);return t||(t=i(document.createElement("div")),t.set_html(n)),t},c.prototype._getLocationInfo=function(){try{var t,n=this._taskState.point;return n&&n.length===2?c._circularViewFormat.replace("{0}",n[0].toString()).replace("{1}",n[1].toString()).replace("{2}",c._radiusInMeters):(t=this._taskState.mapBounds&&this._taskState.mapBounds.length===4?this._taskState.mapBounds:this._getLocalMapViewBounds(),c._mapViewFormat.replace("{0}",t.join(",")))}catch(i){return""}},c.prototype.isSharable=function(){return this.getMapPrimitives()&&this.getMapPrimitives().length>0},c.prototype.getMenuList=function(){for(var n=o.prototype.getMenuList.call(this),r=!1,i=0;i<n.length;i++)if(n[i].name.indexOf("print")||n[i].name.indexOf("Print")){r=!0;break}return!r&&this.hasPrintContent()&&n.push({name:t.L_Menu_Print_Link_Text,handler:function(){e.invokeHandler(f.printDataHandlerKey,{source:2,taskType:this.type,taskId:this.id,data:this.getPrintInstrumentationData()})},instData:this.getInstData("Print")}),this.isReportable()&&(this.getReportType()===4?this.shoudEnableSuggestAnEdit()&&n.push(this._getLocalFeedbackListData()):n.push(this._getFeedbackListData())),n},c.prototype._updateRoutePoints=function(n){if(this._categories)for(var t=0,i=this._categories.length;t<i;t++)e.invokeHandler(f.layerManagerDataHandlerKey,{action:"updateRoutePoints",entryPoint:u.LocalListingAlongRoute,category:this._categories[t],taskId:this.id,routePoints:n})},c.prototype.openReportLocalProblemLink=function(){var n=this.viewModel.reportLocalProblemLinkURL;n&&window.open(n,"_blank")},c.prototype._getFeedbackListData=function(){return{name:t.L_Menu_ReportProblem_Link_Text,options:{type:s.feedbackTask,activateOptions:{parentId:this.id},state:{entryPoint:2,feedbackTaskType:3,activeTaskId:this.id,title:this.getTitle(),options:this.getReportOptions()}},instData:this.getInstData("Report Problem")}},c.cleanupPrimerData=function(n){c._removeCardPrimer(n);c._removePoiPrimerLayer(n)},c.parseDataFact=function(n){var t=null;if(n)try{t=JSON.parse(n)}catch(i){}return t},c._removeCardPrimer=function(t){if(t.getConfig().enablePoiPrimer){var r=i(".cardPrimer");r&&r.length>0&&!c._removeCardPrimerTimer&&(c._removeCardPrimerTimer=Microsoft.Maps.setTimeout(function(){c._removeCardPrimerTimer=null;n.showContentFirstForPermalinks?r.set_style({display:"none"}):r&&r.removeFromParent()},500))}},c._removePoiPrimerLayer=function(n){for(var t=n.getLayers(),i,r=0,u=t.length;r<u;r++)if(t[r].getId()==="PoiPrimer"){i=t[r];break}i&&n.getFrameManager().frameRendered.addOne(function(){t.remove(i);i.dispose()})},c.prototype._buildTaskStateWithPrimerPois=function(){var n={};for(var t in this._taskState)this._taskState.hasOwnProperty(t)&&(n[t]=this._taskState[t]);return n.primerPois=this._getPrimerPoisFromViewModel(),n},c.prototype._getPrimerPoisFromViewModel=function(){var r=[],i=this.viewModel.getPushpinPrimitives(),u=i.length>5?5:i.length,t,n;for((this.type===s.localDetailsTask||this.type===s.polygonEntityDetailsTask)&&(u=1),t=0;t<u;t++)n=i[t],r.push({geometry:{y:Math.round(n.geometry.y*1e6)/1e6,x:Math.round(n.geometry.x*1e6)/1e6,bounds:[]},entity:{title:n.entity.getTitle(),id:n.entity.id,subtitle:n.entity.getAddress()}});return r},c.prototype._reduceLatLonPrecisions=function(){var n;if(this._taskState){if(this._taskState.mapBounds&&this._taskState.mapBounds.length>0)for(n=0;n<this._taskState.mapBounds.length;n++)this._taskState.mapBounds[n]&&(this._taskState.mapBounds[n]=Math.round(this._taskState.mapBounds[n]*1e6)/1e6);if(this._taskState.point&&this._taskState.point.length>0)for(n=0;n<this._taskState.point.length;n++)this._taskState.point[n]&&(this._taskState.point[n]=Math.round(this._taskState.point[n]*1e6)/1e6);if(this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>0)for(n=0;n<this._taskState.keyRoutePoints.length;n++)this._taskState.keyRoutePoints[n]&&(this._taskState.keyRoutePoints[n].latitude=Math.round(this._taskState.keyRoutePoints[n].latitude*1e6)/1e6,this._taskState.keyRoutePoints[n].longitude=Math.round(this._taskState.keyRoutePoints[n].longitude*1e6)/1e6)}},c.prototype._getLocalFeedbackListData=function(){return{name:t.L_Menu_SuggestAnEdit_Link_Text,options:{type:s.feedbackTask,activateOptions:{parentId:this.id},state:{entryPoint:2,feedbackTaskType:4,activeTaskId:this.id,title:t.L_Menu_SuggestAnEdit_Link_Text+" - "+this.getTitle(),options:this.getLocalReportOptions()}},instData:this.getInstData("Suggest an Edit")}},c.prototype.getReportOptions=function(){var n=null;return this.getReportType()!==1&&this.getReportType()!==6&&this.viewModel&&this.viewModel.getEntities()&&this.viewModel.getEntities().length>0&&(n=this.viewModel.getEntities()[0].getLocation()),{query:this._taskState.query,reportType:this.getReportType(),pushPinLocation:n,reportLocalProblemLinkURL:this.viewModel.reportLocalProblemLinkURL,taskStateId:this._taskState.id,scenarioKey:this._taskState.scenarioKey,userFacts:this.loadUserFacts(),rapEntryPoint:3}},c.prototype.getLocalReportOptions=function(){var n={},t,i;return this.getReportType()!==1&&this.viewModel&&this.viewModel.getEntities()&&this.viewModel.getEntities().length>0&&(n.pushPinLocation=this.viewModel.getEntities()[0].getLocation(),n.entityName=this.viewModel.getEntities()[0].getTitle(),n.entityYpid=this.viewModel.getEntities()[0].id),t=this.loadDataFacts(),t&&(n.dataFacts=t),i=this.loadUserFacts(),i&&(n.userFacts=i),n.query=this._taskState.query,n.reportType=this.getReportType(),n},c.prototype.loadDataFacts=function(){var n=this.panelRoot.select("div.overlay-taskpane").get_attr("data-facts");return c.parseDataFact(n)},c.prototype.loadUserFacts=function(){var n=null,t=this.panelRoot.select("div[data-ufacts]").get_attr("data-ufacts");if(t)try{n=JSON.parse(t)}catch(i){}return n},c.prototype.isReportable=function(){return this._taskState&&this.getReportType()!==0},c.prototype.isPrintable=function(){var n=this.viewModel?this.viewModel.getPushpinPrimitives():null;return ir.isEnabled&&n&&n.length>0},c.prototype.getReportType=function(){var i=this._taskState.scenarioKey,t=0;return n.reportAsNotFoundKeys.indexOf(i)>-1&&(t=1),n.reportAsMultiBusinessKeys.indexOf(i)>-1?t=6:n.reportAsAddressKeys.indexOf(i)>-1?t=this._taskState.entryPoint===u.ContextMenu?3:2:n.reportAsPlaceKeys.indexOf(i)>-1?t=5:n.reportAsLocalKeys.indexOf(i)>-1&&(t=4),t},c.prototype.getEntityMarket=function(){var n=this.loadDataFacts();return n&&n.languageCultureName?n.languageCultureName:""},c.prototype.shoudEnableSuggestAnEdit=function(){var t=!1,u=this.getEntityMarket(),i=st.ftwMarkets,n,r;if(i!=undefined){n=i.split(",");for(r in n)if(n[r].toLowerCase()===u.toLowerCase()){t=!0;break}}return t},c.prototype._getQueryParam=function(){var n="";return this._taskState&&(n+=this._taskState.query||this._taskState.taskTitle),n},c.prototype._getSegmentParam=function(){return""},c.prototype._getFiltersParam=function(){var n="";return this._taskState&&this._taskState.localFilters&&(n+=encodeURIComponent(this._taskState.localFilters+" ")),n},c._disableOSearchParameter="&DisableOSearch=1",c._circularViewFormat="&localCircularView={0},{1},{2}",c._mapViewFormat="&localMapView={0}",c._useBfpr=!1,c._cardPrimerConsumed=!1,c._overlayCloseBtnListenerAdded=!1,c._radiusInMeters="16000",c._tabID=_G.IG,c.mouseoverTimeout=500,c.mouseoutTimeout=500,c}(tt),dt=function(o){function h(n,t,i,r,u,f,e,h,c,l){var a=o.call(this,n,f,t,r)||this;return a.showCloseButton=!0,a.type=s.localDetailsTask,a.poiManager=i,a._controlTemplateFactory=h,a._buttonGroupViewModel=u,a.disposables.push(a.poiManager.contextMenuInvoked.add(function(n){return a._contextMenuInvoked(n)})),a.disposables.push(a.poiManager.poiTapped.add(function(){return a._poiTapped()})),a.disposables.push(a.poiManager.poiHoverStarted.add(function(n){return a._poiHoverStarted(n)})),a.disposables.push(a.poiManager.poiHoverStopped.add(function(){return a._poiHoverStopped()})),a.disposables.push(a.poiManager.mapViewChanged.add(function(n){return a.updateMapBounds(n)})),a._syndicatedAds=e,a._taskBar=c,a._geochainManager=l,a.scrollToTop=new g,a._taskUrlParams.push({param:"sid",paramGetter:function(){return a._getSidParam()}}),a._taskUrlParams.push({param:"ypid",paramGetter:function(){return a._getYpidParam()}}),a._taskUrlParams.push({param:"eventid",paramGetter:function(){return a._getEventIdParam()}}),a}return v(h,o),h.prototype.activate=function(n,t){var r=this,u,f;t&&(this.viewModel=new fi(this.map,this.panelRoot,this.id,this._logHelper,this._transientLensViewModel,this._buttonGroupViewModel,this._taskBar,t,this._controlTemplateFactory,this.primitiveInteracted),this.registerViewModelEvents(),u=t.taskTitle?t.taskTitle:t.fullQuery||t.query,this.setTitle(u),this.disposables.push(this.viewModel.titleChanged.add(function(n){r.setTitle(n);var t=r.viewModel;t.updatePoiTitle(n);t.resetPrimitives(r.poiManager)})),o.prototype.activate.call(this,n,t),t.content?this._processLocalDetails(t):(t.disableTaskActivate=!0,f={requestState:t},o.prototype.process.call(this,f,function(n){r.processResponse(n.data.content);r._processLocalDetails(t);sj_evt&&r.displayState&&r.displayState.stackOrder===1&&sj_evt.fire("OnCardRefresh",r.panelRoot,r.stackId)})),t&&t.scrollElement&&t.scrollElement.length>0&&sj_evt.bind("bm_scrollCard",function(){r.scrollToTop.invoke(i(t.scrollElement))}))},h.prototype.process=function(n,t){var i=n&&n.requestState,r,u;i&&(i.hideBackButton&&i.listingTaskId?(r=this.panelRoot.select(".commonButton.backArrowButton.overlayButton"),u=r.get_attr(f.taskDataHandlerKey),u&&u.indexOf(i.listingTaskId)>0&&(r.set_style({display:"none"}),r.parent().set_style({display:"none"})),t&&t({processorId:this.id,data:{}})):o.prototype.process.call(this,n,t))},h.prototype.deactivate=function(){var r,n,t;if(this._taskState.openingNewCard||this._taskState.flippingCard){var i=this.viewModel&&this.viewModel.getEntities(),u={showEntity:!0,selectedEntityId:i&&i.length>0?i[0].id:null},h={requestorType:s.localDetailsTask,requestorId:this.id,type:s.localListingTask,requestState:u,useActiveTasks:!0};e.invokeHandler(f.taskProcessDataHandlerKey,h)}this._firstFrameRenderedHandler&&this._firstFrameRenderedHandler.dispose();o.prototype.deactivate.call(this);r=this.panelRoot.select("a[data-streetside]");r.set_style({opacity:0});n=this.panelRoot.select("#bev2Img");n&&n.length>0&&n.set_style({opacity:0});t=this.panelRoot.select(".tp_tasks");t&&t.length>0&&t.set_style({opacity:0})},h.prototype.setTaskComplete=function(){var n=this,v=this._taskState&&this._taskState.id?nt.ID:nt.SB,y=this._logHelper.perfStart(v),h,t,i,u,c,a;this.map.getConfig().cardPrimerIsShown&&!l.hasCardPrimerPerfDataLogged&&(h=window.$cp_bsperf=window.$cp_bsperf||{},h.Maps_CP_CLT=h.Maps_CP_CLT||performance.now(),rt.record("Maps_CP_LDT",Math.round(h.Maps_CP_CLT)));this._firstFrameRenderedHandler=this.map.getFrameManager().frameRendered.add(function(){var i,t,u;n._firstFrameRenderedHandler.dispose();rt.logStartTime("Maps_SOPLT")===-1&&n._taskState&&n._taskState.searchPerfState&&(i=n._taskState.searchPerfState.timestamp().getTime(),rt.log("Maps_LDTTG",i),n.map.getConfig().cardPrimerIsShown&&!l.hasCardPrimerPerfDataLogged&&(rt.log("Maps_CP_LDTTG",performance.timing.navigationStart),l.hasCardPrimerPerfDataLogged=!0),t=Microsoft.Maps.Local,u=n instanceof t.HotelsDetailsTask?"Maps_HLDTTG":n instanceof t.RestaurantDetailsTask?"Maps_RLDTTG":n instanceof t.HouseDetailsTask?"Maps_RELDTTG":r._isAttractionCategory(n.viewModel.getCardCategoryId())?"Maps_ALDTTG":"",u&&rt.log(u,i));y.end("RT");n.viewModel&&n.viewModel.loadDelayedRecommendationModuleImages()},!0);t=this.viewModel.getEntities();t&&t.length>0&&(i=t[0],this.poiManager&&this.poiManager.setTargetMapView(this.viewModel.boundingBox),this.setTitle(this._taskState&&this._taskState.taskTitle?this._taskState.taskTitle:i.getTitle()),this._taskState.id||(this._taskState.id=i.id),this._taskState.taskTitle&&this._taskState.overridePoiTitle&&this.viewModel.updatePoiTitle(this._taskState.taskTitle),u=this.loadDataFacts(),u&&(i.interests=u.Interests,i.stayDuration=u["Average stay"],i.addressFields=u.addressFields));o.prototype.setTaskComplete.call(this);(this._taskState.flippingCard||this._taskState.openingNewCard)&&t&&t.length>0&&(c={hideEntity:!0,selectedEntityId:t[0].id},a={requestorType:s.localDetailsTask,requestorId:this.id,type:s.localListingTask,requestState:c,useActiveTasks:!0},e.invokeHandler(f.taskProcessDataHandlerKey,a))},h.prototype.processResponse=function(t,i){var r=this;o.prototype.processResponse.call(this,t,i);this.panelRoot&&(this.panelRoot.add_event("click",function(n){n&&n.target&&n.target.tagName.toLowerCase()==="a"&&r._logInstrumentationEventForEntityClick()}),this._showDestinationItinerariesModule(),this._showProductAdsModule(),n.hotelAdsAjaxForOpalAction&&this._fetchHotelAdsIfOpalActionWhereToStay())},h.prototype.serialize=function(n,t){var r=o.prototype.serialize.call(this,n),i=this.viewModel,u,f;return r&&i&&i.calendarSync&&i.calendarSync.length&&i.calendarSync[0]&&(r.dateTime=i.calendarSync[0].getStartDateTime()),u=i&&i.annotationControl,f=r,r&&u&&u.getCurrentName()!==u.getOriginalName()&&(f.originalName=u.getOriginalName()),r&&t&&t===2&&(f.hideBackButton=!0,f.flippingCard=!1),r},h.prototype.getOriginalName=function(){var t=this.viewModel,n=t&&t.annotationControl;return n&&n.getCurrentName()!==n.getOriginalName()?n.getOriginalName():""},h.prototype.getNotes=function(){var n=this.viewModel,t=n&&n.annotationControl;return t?t.getDescription():""},h.prototype.canColorFade=function(){return!1},h.prototype.hasPrintContent=function(){return this.isPrintable()},h.prototype.getPrintContent=function(){var n,t;return this.hasPrintContent()?(n=null,this.viewModel instanceof fi&&(n=this.viewModel.getDetailsHtmlContentForPrint(this.loadDataFacts())),t=new ni,t.insert(this.poiManager.getLayerId(),0),n?new rr(n,t,null):null):null},h.prototype.getShareDescription=function(){var i,r,u,n="",f=String.fromCharCode(183),o=this.viewModel.getEntities(),e=this.loadDataFacts(),t;return(e&&e.price&&(r=e.price),o.length===1&&(t=o[0],i=t.getAddress()||t.getDescription(),u=t.getPrimaryCategoryName()),i&&(n+=i),r&&(n+=f+r),u&&(n+=f+u),n.length&&n.charAt(0)===f&&(n=n.substr(1)),n===t.getTitle())?"":n},h.prototype.setDisplayState=function(n){o.prototype.setDisplayState.call(this,n);n.activationState===1&&n.prominence===1&&at&&at.isEditable&&!this._itineraryTaskChecked&&this._checkItineraryTasks();var t=this.panelRoot.select("a[data-streetside]");n.activationState===2||n.activationState===3?t.set_style({opacity:0}):n.activationState===1&&t.set_style({opacity:1})},h.prototype._onPoiViewStateChanged=function(t){var i,r,o;n.enableLEPoiHover2&&t&&t.primitive&&t.primitive.entity instanceof ur&&t.newValue!==t.oldValue&&(this._logPoiHoverIfNecessary(t,u.LocalDetails),i=t.primitive.entity,i&&i.id&&t.newValue===2&&(r={entryPoint:u.POI,id:i.id,openingNewCard:!0,taskTitle:i.getTitle()},o={taskColorIndex:this.displayState.colorIndex,groupName:this.id},e.invokeHandler(f.taskDataHandlerKey,{type:s.localDetailsTask,state:r,activateOptions:o})))},h.prototype._createUrl=function(n,t,i){var r=o.prototype._createUrl.call(this,n,t,i);return this._taskState&&this._taskState.adProviderId&&this._taskState.adStoreId&&(r+="&enablerelprod=true"),r},h.prototype._showProductAdsModule=function(){var t=this.panelRoot.select("div.productAdsModuleContainer"),i;if(t&&t.length){if(t.getParent().set_style({display:"none"}),!this._taskState||!this._taskState.adProviderId||!this._taskState.adStoreId||!this._taskState.adQuery||!this._taskState.adImpressionGuid||!this._taskState.adYpid||!this._taskState.adRetailEntitySource||!n.requestUrlFormatForProductAdsModule)return;i=n.requestUrlFormatForProductAdsModule.replace("{query}",this._taskState.adQuery).replace("{provid}",this._taskState.adProviderId).replace("{storeid}",this._taskState.adStoreId).replace("{ig}",this._taskState.adImpressionGuid).replace("{ypid}",this._taskState.adYpid).replace("{rsource}",this._taskState.adRetailEntitySource);it.downloadGeneric(i,"productadsajax",function(n){n&&(t.getParent().set_style({display:"block"}),t.appendHTML(n));var i=t.select("div.carouselPlaceHolder");i&&i.length&&i.removeFromParent()},null,function(){var n=t.select("div.carouselPlaceHolder");n&&n.length&&n.removeFromParent()},null,0)}},h.prototype._showDestinationItinerariesModule=function(){var u=this,t=this.panelRoot.select("div.itinerariesModuleContainer"),i,r;if(t&&t.length){if(i=t.get_attr("data-entitysid"),!n.requestUrlFormatForItineraryModule||!i){t.getParent().set_style({display:"none"});return}i&&(r=n.requestUrlFormatForItineraryModule.replace("{l2sid}",i),it.downloadGeneric(r,"travell2ajax",function(n){n?(t.appendHTML(n),u._setAddItineraryDataTask(t)):t.getParent().set_style({display:"none"})},null,function(){t.getParent().set_style({display:"none"})},null,0))}},h.prototype._findHotelAdsIndex=function(n,t){if(n&&n.length&&t)for(var i=0;i<n.length;i++)if(n[i]&&n[i].EntityId&&n[i].EntityId.indexOf(t)>-1)return i;return-1},h.prototype._fetchHotelAdsIfOpalActionWhereToStay=function(){var f=this,u=this.panelRoot.select("div.EntityCollectionModuleContainer");u&&u.length&&u.for_each(function(u){var s=u.getAttribute("data-moduletag"),e,o;if(s&&s.indexOf("MapsModule.WhereToStayOpalAction")>-1&&(e=u.getAttribute("data-hoteladsajax"),o=f._getImpressionGuid(),e&&o)){i(u).set_style({display:"none"});it.downloadGeneric(e+"&IG="+o,"hoteladsajax",function(e){var o,s,h;if(e)try{o=i.Internals.parseJSON(e);o&&o.length&&(s=i(u).select("div[class=slide]"),s&&s.length&&(h=[],s.for_each(function(n){var y=i(n).select("a[data-process]"),p,s,e,u,c,l,a,v;y&&y.length&&(p=y[0].getAttribute("data-process"),p&&(s=i.Internals.parseJSON(p),s&&s.requestState&&s.requestState.entityId&&(e=o.findIndex?o.findIndex(function(n){return n.EntityId.indexOf(s.requestState.entityId)>-1}):f._findHotelAdsIndex(o,s.requestState.entityId),e>-1&&o[e]&&o[e].Price&&(u=i(n).select("div[class=slideFacts]"),u&&u.length&&(c=r._createElement("div"),c.set_text(o[e].Price),c.add_class("lm_hpaprice"),r._createElement("p").appendTo(u),o[e].OriginalPrice&&o[e].PriceDropPercentage?(l=r._createElement("div"),l.set_text(o[e].OriginalPrice),l.add_class("lm_hpaorig"),l.appendTo(u),c.appendTo(u),r._createElement("p").appendTo(u),r._createElement("p").appendTo(u),a=r._createElement("div"),a.set_text(t.L_Deal_Text),a.add_class("b_badgeDeal b_badge"),a.appendTo(u),v=r._createElement("div"),v.set_text(o[e].PriceDropPercentage),v.add_class("lm_hpapercent"),v.appendTo(u),h.push(n)):c.appendTo(u),r._createElement("p").appendTo(u))))))}),n.forceHotelRecoModuleClientSort&&h.length>0&&h.forEach(function(n){var t=i(n).getParent();t&&t.length&&t[0].insertBefore(n,t[0].firstChild)})))}catch(c){i(u).set_style({display:"block"});return}i(u).set_style({display:"block"})},null,function(){i(u).set_style({display:"block"})},null,0);return}})},h.prototype._processLocalDetails=function(t){var f=this,e=null,l=null,a=null,v=null,o=this.viewModel.getEntities(),i,h,c,y;if(o&&o.length>0&&(l=o[0].getRoutableLocation(),a=o[0].getLocation(),v=o[0].getBoundingBox(),e=o[0].getTitle()),!e||t.taskTitle&&t.originalName?e=t.taskTitle||t.title||"":(t.taskTitle=e,this.setTitle(e)),this._processForCollectionError(t),this.pageProcessor.process(this.panelRoot,{routablePoint:l,id:this.id,showBackButton:(t.flippingCard||t.openingNewCard)&&!r._getIsSlideCardEnabled(),cameFromCollections:t.entryPoint===u.Collections,listingTaskId:t.listingTaskId,location:a,boundingBox:v,map:this.map,geochainManager:this._geochainManager,controlTemplateFactory:this._controlTemplateFactory,taskTitle:e,getDisplayState:function(){return f.displayState}},this.perfLog),i=this.viewModel,eu.enableCalendarSync?i.createCalendarSync():(h=this.panelRoot.select(".calendarSyncModule"),h&&h.getParent()&&h.getParent().set_style({display:"none"})),i.processAdvertising(t,this._syndicatedAds),i.registerActionButtonEvents(this.id),i.registerModuleClickEvents(),i.registerCalendarEvents(),i.registerLocatedAtSearchEvents(),i.processPhotostripData(),i.registerVenueMapEvents(),this._checkLoadingVenueMapTask(),i.addAnnotationControl(t),t.taskTitle&&i.updatePoiTitle(t.taskTitle),i.removeUpcomingEventContainer(),i.registerGeochainEvents(),i.expandDetailsCard(),i.prepareMenuModule(),i.prepareReviewsAccordionModule(function(){f._disableSizeChangeAction()}),i.registerActionsModuleEvents(),i.addRecommendationModuleHover(this.poiManager),n.edgeRecoModuleFix&&i.edgeRecoModuleFix(),c=this.panelRoot.select('div[id^="locovl"]'),this._imgSetOvlId||(this._imgSetOvlId=c.get_attr("data-ovl")),!t.isImgOvlOpen&&this._imgSetOvlId){var s=_d.getElementsByTagName("html")[0],w=s.style.overflowX,b=s.style.overflowY,k=s.style.overflow;sj_evt.fire("ovlHide",this._imgSetOvlId,!0);s.style.overflow=k;s.style.overflowX=w;s.style.overflowY=b}else this._imgSetOvlId=c.get_attr("data-ovl"),typeof ovlc!="undefined"&&ovlc.show(this._imgSetOvlId,t.imgSetOvlCurIndex);this._imgSetOvlShowHandlerWrapper||(this._imgSetOvlShowHandlerWrapper=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];f._imgSetOvlShowHandler.apply(f,t[0])});sj_evt.unbind("MapsImgSetOvlShow_"+this._imgOvlHitTargetId,this._imgSetOvlShowHandlerWrapper);this._imgOvlHitTargetId=c.get_attr("id");sj_evt.bind("MapsImgSetOvlShow_"+this._imgOvlHitTargetId,this._imgSetOvlShowHandlerWrapper,0);this._imgSetOvlHideHandlerWrapper||(this._imgSetOvlHideHandlerWrapper=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];f._imgSetOvlHideHandler.apply(f,t[0])});sj_evt.unbind("ovlHide",this._imgSetOvlHideHandlerWrapper);sj_evt.bind("ovlHide",this._imgSetOvlHideHandlerWrapper,0);y={searchTaskInstance:this,updateDetailsPricePoi:this._updateDetailsPricePoi};sj_evt.fire("pricePoiInit",y);this._logActivated(p.LDT)},h.prototype._updateDetailsPricePoi=function(n,t){var i,u,r;n&&t&&(i=n.searchTaskInstance,i&&(u=i.viewModel,u&&u.getPushpinPrimitives&&(r=u.getPushpinPrimitives(),r&&r.length&&r[0].entity&&(r[0].entity.iconText=t,i.poiManager&&i.poiManager.setPrimitives&&i.poiManager.setPrimitives(r)))))},h.prototype._checkLoadingVenueMapTask=function(){var n=this.panelRoot.select("div[class=bm_venueMapButton]");this._taskState.loadVenueMap&&n&&n[0]&&(this._taskState.loadVenueMap=!1,this.viewModel.handleVenueMapClick())},h.prototype._disableSizeChangeAction=function(){var n=this;Microsoft.Maps.setTimeout(function(){n.primitiveInteracted.invoke({action:2})},0)},h.prototype._processForCollectionError=function(n){var i;if(n&&n.scenarioKey&&n.scenarioKey==="ERR"&&n.entryPoint===u.Collections&&(i=this.panelRoot.select("div[class=errmsg]"),i&&i.length===1)){var f=r._createElement("p"),e=r._createElement("p"),o=r._createElement("p"),s=r._createElement("p");f.set_text(t.L_Collections_NotFound_Text);e.set_text(n.taskTitle);o.set_text(n.query);s.set_text(t.L_Collections_TryAgain_Text);i.clear();i.append(f);i.append(r._createElement("br"));i.append(e);i.append(o);i.append(r._createElement("br"));i.append(s)}},h.prototype._poiTapped=function(){if(this.primitiveInteracted.invoke(),this.displayState.activationState!==1){var n={action:"focus",id:this.id};e.invokeHandler(f.taskDataHandlerKey,n)}},h.prototype._poiHoverStarted=function(n){n&&n.primitive&&this.activateInfobox(n.primitive,this._taskState.infoboxHtml)},h.prototype._poiHoverStopped=function(){window.clearTimeout(l.mouseoverDelayHandle);l.mouseoverDelayHandle=window.setTimeout(function(){l.mapsInfobox&&l.mapsInfobox.setOptions({visible:!1})},l.mouseoutTimeout/2)},h.prototype._imgSetOvlShowHandler=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._taskState.isImgOvlOpen=!0;this._taskState.imgSetOvlCurIndex=t[2];this._imgSetOvlId=t[1];this.serializableObjectChanged.invoke({magnitude:2})},h.prototype._imgSetOvlHideHandler=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t[1]===this._imgSetOvlId&&(this._taskState.isImgOvlOpen=!1,!t[2]==!0&&this.serializableObjectChanged.invoke({magnitude:2}))},h.prototype._checkItineraryTasks=function(){var n={requestorType:s.localDetailsTask,requestorId:this.id,type:s.itineraryDetailsTask,requestState:{action:0},useActiveTasks:!0};e.invokeHandler(f.taskProcessDataHandlerKey,n);this._itineraryTaskChecked=!0},h.prototype.getCardIconInfo=function(){var n=this.viewModel;return{iconClass:n.iconClass,iconElements:this.getCardIcons(this.viewModel.getCardCategoryId())}},h.prototype._getSidParam=function(){var t="",n;return this._taskState&&(n=this._taskState.id,n&&n.indexOf("sid:")===0&&(t=n.substring(4))),t},h.prototype._getYpidParam=function(){var t="",n;return this._taskState&&(n=this._taskState.id,n&&n.indexOf("ypid:")===0&&(t=n.substring(5))),t},h.prototype._getEventIdParam=function(){var t="",n;return this._taskState&&(n=this._taskState.id,n&&n.indexOf("eventId:")===0&&(t=n.substring(8))),t},h.prototype._setAddItineraryDataTask=function(n){var e=this.viewModel.getEntities(),o=n.select("a.itineraryAdd");if(e&&e.length>0&&o&&o.length>0){var t=e[0],h=ii.getItineraryItem(t.getTitle(),t.getLocation(),t.id,t.getImageUrl(),t.getSelectedCategoryForIcon(),t.interests),r=t.addressFields;h.Destination=r&&(r.city||r.stateMunicipality||r.country);h.EntityTypes=t.getSegmentTypes();var c={entryPoint:u.LocalDetails,itineraryItem:h},l={type:s.itineraryDetailsTask,activateOptions:{},state:c},a=o[0];a.setAttribute(f.taskDataHandlerKey,i.Internals.stringify(l))}},h}(l),sf=function(t){function i(i,r,u,f,e,o,s,h,c,l){var a=t.call(this,i,r,u,f,e,o,s,h,c,l)||this;return a.setRecommendedWidth(n.hotelCardWidth),a.setCurrentWidth(n.hotelCardWidth),a._subscribeToAdsClick(),a}return v(i,t),i.prototype._createUrl=function(){var n=t.prototype._createUrl.call(this),r=Logger.getOverlayType(),i;return r?n+=this._taskState.originIG&&this._taskState.originIG===y.dynamicProperties.serpIG?"&FORM=BHO001":"&FORM=BHO002":(n+="&FORM=BHO003",n+="&mapsVertical=true"),i=this._taskState.passThruParam,i&&i.toUpperCase().indexOf("FORM=")===-1&&(n+=i.indexOf("&")!==0?"&"+i:i),n+=this._taskState&&this._taskState.parentIG?"&parentIG="+this._taskState.parentIG:"&htlsource=overlaynq",_w.hpa_roomnum&&(n+="&guests="+_w.hpa_roomnum),_w.suppressBookingAdsModule=this._taskState.isBookingModuleEntryPoint,n},i.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForLocalOverlayOnSerp},i.prototype.processResponse=function(n,i){_w.hotelsDetailsCardIG=tt.getImpressionGuid(n);t.prototype.processResponse.call(this,n,i)},i.prototype._subscribeToAdsClick=function(){var n=this;sj_evt.bind("bm_scrollCard",function(){var t=n.panelRoot.select(".hr_link"),i,r;if(t&&t.length>0)for(i=t.length,r=function(){var r=t[i],u;r&&(u=r.getAttribute("h")||r.getAttribute("data-h"),u&&(r.removeAttribute("h"),r.removeAttribute("data-h"),r.setAttribute("h1",u),sj_be(r,"click",function(t){var u=Microsoft.Maps.logger,f,i,e;u&&(f={T:"CI.HotelAdsClick",feature:"HotelAds",action:"CI.HotelAdsClick",data:{adsUrl:r.href}},u.logObject(f,n._getImpressionGuid(),!1));i=r.getAttribute("h1");i&&(e=_G.IG,_G.IG=n._getImpressionGuid(),r.setAttribute("h",i),_w.si_ct&&_w.si_ct(r,!1,t),_G.IG=e,r.removeAttribute("h"))})))};--i>=0;)r()})},i.prototype._getSegmentParam=function(){return"hotel"},i}(dt),ot=function(o){function c(n,t,i,u,f,e,h,c){var l=o.call(this,t,e,i,f)||this,a;return l._primitivesToHideAfterPrint=[],l._defaultInfoboxContentsTemplate='<a class="infoBoxLink" role="button" href="#"><div class="bm_ib_container bm_ib_titleonly"><div class="bm_ib_title">{title}<\/div><\/div><\/a>',l.showCloseButton=!0,l.type=s.localListingTask,l.poiManager=u,l._contextMenu=h,l._taskUrlParams.push({param:"poicount",paramGetter:function(){return l._getPoiCountParam()}}),l.disposables.push(l.poiManager.contextMenuInvoked.add(function(n){return l._contextMenuInvoked(n)})),l.disposables.push(f.poiSelected.add(function(n){return l._setSelectedPrimitive(n)})),l.disposables.push(l.poiManager.mapViewChanged.add(function(n){return l.updateMapBounds(n)})),l._micropoiFetched=!1,l._microPoiManager=c,a=l.poiManager.getZIndex(),l._microPoiManager.setZIndex(a-1),l.disposables.push(l._microPoiManager.poiViewStateChanged.add(function(n){l._onPoiViewStateChanged(n,!0)})),l.disposables.push(l._microPoiManager.zoomChangedOnClusterSelect.add(function(){l.map.viewChanged.addOne(function(){l.poiManager._computeBestMapViewOnSetPrimitives=!1;o.prototype._refreshWithDelay.call(l)})})),l._registerEvents(t),l.controlTemplateFactory=n,l.disposables.push(l.laneScrolled.add(function(){l._contextMenuOnListMode&&l._hideListItemContextMenu();l._logInstrumentationForScroll()})),l._setTaskCompleted=!1,l._polygonLayerAdded=!1,l._categories=new ni,l._categories.changed.add(function(n){l._onCategoriesChanged(n)}),r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&sj_evt&&sj_evt.bind("triggerMapSearch",function(n){var t,i;if(l.displayState&&l.displayState.prominence===1)if(t=n&&n[1],t){if(i=t.filters,typeof i!="undefined"){l._logInstrumentationEventForEntityClick();l.onFilterValueChanged(i)}}else l._logInstrumentationEventForEntityClick(),l._refresh({mapPannedOrZooomed:!0,isResearchOnOverlay:!0})}),l}return v(c,o),c.prototype.activate=function(n,t){var i=this,r,u,f;this.viewModel||(this.viewModel=new ei(this.map,this.panelRoot,this.id,this._logHelper,this.poiManager,this._transientLensViewModel,this.controlTemplateFactory));this.registerViewModelEvents();r=t.fullQuery?t.fullQuery:t.query;u=t.taskTitle?t.taskTitle:r;this.setTitle(u);t&&t.categoryLayers&&(this._taskState=t,this._categories.insertAll(t.categoryLayers));o.prototype.activate.call(this,n,t);t&&t.directionsTaskId&&this.enableSearchAlongRoute(t.directionsTaskId);t.content?this._logActivated(p.LLT):(t.disableTaskActivate=!0,f={requestState:t},o.prototype.process.call(this,f,function(n){i.processResponse(n.data.content);i._logActivated(p.LLT);sj_evt&&i.displayState&&i.displayState.stackOrder===1&&sj_evt.fire("OnCardRefresh",i.panelRoot,i.stackId)}))},c.prototype.process=function(n,t){var r=this,i=n&&n.requestState,u;i.hideEntity?(this._setTaskCompleted?this._hideSelectedPrimitive(i.selectedEntityId):(this._hideSelected=new g,this.disposables.push(this._hideSelected.addOne(function(){r._hideSelectedPrimitive(i.selectedEntityId)}))),t&&t({processorId:this.id,data:{}})):i.showEntity?(i.selectedEntityId&&(u=function(){var n=r.viewModel.UpdatePrimitiveState(i.selectedEntityId,0);n&&r.poiManager.invalidated.invoke()},this._setTaskCompleted?u():(this._hideSelected=new g,this.disposables.push(this._hideSelected.addOne(function(){u()})))),t&&t({processorId:this.id,data:{}})):i.hideContextMenu?(this._transientLensViewModel.hide(),t&&t({processorId:this.id,data:{}})):o.prototype.process.call(this,n,t)},c.prototype.deactivate=function(){o.prototype.deactivate.call(this);this._categories.length===0?this._microPoiManager&&this._microPoiManager.dispose():this._updateCategories("removeLayer");this._firstFrameRenderedHandler&&this._firstFrameRenderedHandler.dispose();var n={hideBackButton:!0,listingTaskId:this.id},t={requestorType:s.localListingTask,type:s.localDetailsTask,requestState:n,useActiveTasks:!0};e.invokeHandler(f.taskProcessDataHandlerKey,t);this._cityPolygonManager&&this._polygonLayerAdded&&(this._cityPolygonManager.removeLayer(),this._polygonLayerAdded=!1)},c.prototype.registerViewModelEvents=function(){var n=this;this.disposables.push(this.viewModel.loadInfobox.add(function(t){n.activateInfobox(t,"",!1,!0)}));o.prototype.registerViewModelEvents.call(this)},c.prototype.hasPrintContent=function(){return this.isPrintable()},c.prototype.getPrintContent=function(){var o=this,n,i,u,f,r,t,e;if(!this.hasPrintContent())return null;if(n=this.getMapPrimitives(),n[0]&&n[0].entity&&n[0].entity.usePricePoi)for(this._priceText=[],i=0;i<n.length;i++)u=n[i].entity,u.iconText?this._priceText.push(u.iconText):this._priceText.push("");for(f=null,this.viewModel instanceof ei&&(f=this.viewModel.getListingsHtmlContentForPrint(this._colorIndex)),r=0;r<n.length;r++)t=n[r],t&&t.viewState==3&&(this._primitivesToHideAfterPrint.push(t),t.viewState=0);return e=new ni,e.insert(this.poiManager.getLayerId(),0),yu.onPrintDialogClose.addOne(function(){return o.cleanUpPrintEntities()}),new rr(f,e,null)},c.prototype.cleanUpPrintEntities=function(){for(var u,f,r,t,n,i=0;i<this._primitivesToHideAfterPrint.length;i++)u=this._primitivesToHideAfterPrint[i],u&&(u.viewState=3);if(f=this.viewModel,f){for(r=f.getPushpinPrimitives(),t=0;t<r.length;t++)n=r[t].entity,n&&n.iconText&&n.iconText.length>0&&(n.iconText=this._priceText&&this._priceText.length>0&&n.usePricePoi?this._priceText[t]:"");this.poiManager.setPrimitives(r,!0)}},c.prototype._resetMicropois=function(){this._microPoiManager&&this._microPoiManager.fetchMicroPois(null,[])},c.prototype._onPrimitivesChanged=function(n){this._setPivotPrimitive();o.prototype._onPrimitivesChanged.call(this,n);this._categories&&this._categories.length>0&&this._updateCategories("updateTaskEntities",null,null,this.viewModel.getEntities())},c.prototype.processResponse=function(t,r){var f=this,e,a,o,s,y,p,w,h,d,g;if(this._getTaskState().content=t,this.viewModel.setResponseContent(t,this._getTaskState()),n.doubleWideListEnabled&&(e=this.viewModel.panelRoot.select("div[data-mapcardwidth]"),a=e&&e.length&&e[0].getAttribute("data-mapcardwidth"),a&&(o=parseInt(a),this.setRecommendedWidth(o),this.setCurrentWidth(o),s=this.map.getViewportPadding(),s&&(s.left=o+30,this.map.setViewportPadding(s)))),y={taskParentId:this.id,query:this._taskState.query,clickHandler:function(n,t){return f._processItemClickEvent(t)},contextMenuHandler:function(n,t){return f._processContextMenuEvent(n,t)},saveButtonClickHandler:function(n,t,i){return f._processSaveButtonClickEvent(n,t,i)},listItemCarouselHandler:function(n,t){return f.viewModel.InsertListItemCarousel(n,t)},directionsTaskId:this._getTaskState()&&this._getTaskState().directionsTaskId,originIG:this._taskState.originIG,parentIG:this._getImpressionGuid(),isBookingModuleEntryPoint:this._taskState.isBookingModuleEntryPoint},this.pageProcessor.process(this.viewModel.getResponseContainer(),y),this.viewModel.registerListItemEvents(this._taskState.query,this.isSearchAlongRouteEnabled()),this.viewModel.processSearchMapviewButtons(),this.viewModel.setIconOnlyLimitBySegmentTypeOrCategoryId(),this._registerNoResultResetFiltersClickHandler(),this._setFocusToClickedSortOptionIfApplicable(),this._updateStateWithQueryParseData(),this._processLocalTopicLinks(),p=this._getTotalResultCount(t),w=this.viewModel.enableServerPagination(this,r,p),w||(this.viewModel.processPoiPagination(this._taskState,function(){f._doScrollLaneAction()}),this._setDisableListingRefresh(t)),this.viewModel.updateAdvertising(t,this._getTaskState()),!r||!r.mapPannedOrZooomed&&!r.isPaginated)try{var h=[],k=this.panelRoot.select("div[data-boundingbox]").get_attr("data-boundingbox"),u=k&&i.Internals.parseJSON(k);if(u&&u.boundingBox&&u.boundingBox.length>1){h=[];h.push(new b(u.boundingBox[0].latitude,u.boundingBox[0].longitude));h.push(new b(u.boundingBox[1].latitude,u.boundingBox[1].longitude));var v=this.map.getMode().getMapViewForLocationsInView(h),c=ui.fromLocation(v.cameraLocation,!0),l=u.minZoomLevel;l&&!isNaN(l)&&c<l&&(c=l);d=di.fromEdges(u.boundingBox[0].latitude,u.boundingBox[0].longitude,u.boundingBox[1].latitude,u.boundingBox[1].longitude);g=ui.toLocation(d.center,c,!0);v=et.constructView(this.map,g,c,null,!1,this.map.getViewportPadding(),this.map.getActualSize());this.poiManager&&(this.poiManager.setMapViewFromBackend&&this.poiManager.setMapViewFromBackend(v),this.poiManager.MapViewFromBackendIsSet())}}catch(nt){}this.setTaskComplete(r);sj_evt&&sj_evt.fire("MapSearchTaskActivated",this.viewModel.getResponseContainer())},c.prototype.setTaskComplete=function(t){var i=this,a=this.poiManager,h=this._taskState&&this._taskState.id?nt.ID:nt.SB,c=this._logHelper.perfStart(h),f,s=this.panelRoot.select("div[data-category]"),u,e;f=s&&s.length>0?s[0].getAttribute("data-category").toLowerCase():"none";f&&n.useShowMeForSegmentMicroPoi.indexOf(f)>-1||(f=null);u=this._getTaskState();u.selectedEntityId&&(this._updateSelectedPrimitiveById(u.selectedEntityId),this._hideSelectedPrimitive(u.selectedEntityId));this.map.getConfig().cardPrimerIsShown&&!l.hasCardPrimerPerfDataLogged&&(e=window.$cp_bsperf=window.$cp_bsperf||{},e.Maps_CP_CLT=e.Maps_CP_CLT||performance.now(),rt.record("Maps_CP_LLT",Math.round(e.Maps_CP_CLT)));this._firstFrameRenderedHandler=this.map.getFrameManager().frameRendered.add(function(){var e,o,n,s;i._firstFrameRenderedHandler.dispose();c.end("RT");e=t&&t.perfState||u&&u.searchPerfState;e&&rt.logStartTime("Maps_SOPLT")===-1&&(o=e.timestamp().getTime(),rt.log("Maps_LLTTG",o),i.map.getConfig().cardPrimerIsShown&&!l.hasCardPrimerPerfDataLogged&&(rt.log("Maps_CP_LLTTG",performance.timing.navigationStart),l.hasCardPrimerPerfDataLogged=!0),n=Microsoft.Maps.Local,s=i instanceof n.HotelsListingTask?"Maps_HLLTTG":i instanceof n.RestaurantsListingTask?"Maps_RLLTTG":i instanceof n.HouseListingTask?"Maps_RELLTTG":r._isAttractionCategory(i.viewModel.getCardCategoryId())?"Maps_ALLTTG":"",s&&rt.log(s,o));u&&u.searchPerfState&&(f&&i._categories.indexOf(f)===-1&&i._categories.insert(f),i._microPoiManager&&i._microPoiManager.setTaskDisplayState({prominence:1}),i._requestMicroPoiRefresh(u))},!0);this.registerFilterBarEventHandlersV2();this.registerFilterBarSwitchQueryEventHandlers();o.prototype.setTaskComplete.call(this,t);this._setTaskCompleted=!0;this._hideSelected&&this._hideSelected.invoke();t&&t.mapPannedOrZooomed&&this.scrollLane.invoke(this.panelRoot);this._drawBoundary()},c.prototype.setDisplayState=function(n){var f=this,t,u;o.prototype.setDisplayState.call(this,n);this._categories.length===0?this._microPoiManager&&this._microPoiManager.setTaskDisplayState(n):this._updateCategories("updateDisplayState",null,this.displayState);n.activationState===2?(r._getIsSlideCardEnabled()||(t=this.viewModel.getResponseContainer(),t.remove_class(c._hoverClassName),u=i("."+c._hoverClassName,t[0]),u.remove_class(c._hoverClassName)),this._cityPolygonManager&&this._polygonLayerAdded&&(this._cityPolygonManager.removeLayer(),this._polygonLayerAdded=!1),l.mapsInfobox&&l.mapsInfobox.setOptions({visible:!1})):n.activationState===1&&(r._getIsSlideCardEnabled()&&(t=this.viewModel.getResponseContainer(),t.remove_class(c._hoverClassName),u=i("."+c._hoverClassName,t[0]),u.remove_class(c._hoverClassName)),this._taskState&&(this._taskState.selectedEntityId=null),this._taskState&&this._taskState.vdpid&&this._taskState.vdpid!==c._clearAttributeValue&&!this._polygonLayerAdded&&(this._cityPolygonManager?this._cityPolygonManager.addLayer(this._taskState.vdpid,c._polygonMinZoomLevel,c._polygonMaxZoomLevel):this.map.getCityPolygonManager().then(function(n){f.disposables.push(f._cityPolygonManager=n);n.addLayer(f._taskState.vdpid,c._polygonMinZoomLevel,c._polygonMaxZoomLevel)}),this._polygonLayerAdded=!0));typeof n.colorIndex=="number"&&(this._colorIndex=n.colorIndex)},c.prototype.isSharable=function(){return o.prototype.isSharable.call(this)},c.prototype._doScrollLaneAction=function(){this.scrollLane.invoke(this.panelRoot)},c.prototype._registerEvents=function(){var n=this;this.disposables.push(this.poiManager.refreshResultsRequired.add(function(){if(!n._taskState||!n._taskState.disableListingRefresh){var t=_ge("map_auto_refresh_checkbox");(!t||t.checked)&&(n._taskState.point&&(n._taskState.point=null),o.prototype._refreshWithDelay.call(n,{mapPannedOrZooomed:!0}),n._requestMicroPoiRefresh(n._getTaskState()))}}))},c.prototype.onFilterValueChanged=function(n,t){this._taskState.localFilters=n;this._categories.length>0&&this._updateCategories("updateFilters",this._taskState.localFilters);this.viewModel&&this.viewModel.resetServerPagination&&this.viewModel.resetServerPagination();o.prototype._refreshWithDelay.call(this,t?{appliedFilterOption:t,filterValueChanged:!0}:{filterValueChanged:!0})},c.prototype.registerFilterBarEventHandlersV2=function(){var n,i,e,t,r,u,f;if(this.panelRoot[0])if(n=this.panelRoot[0].getElementsByClassName("bm_sortOption"),n&&n.length>0)for(this._bindFiltersV2(n),i=0,e=n.length;i<e;i++)t=n[i].getElementsByClassName("b_toggle"),t&&t.length>0&&(t[0].setAttribute("tabindex","-1"),sj_be(t[0],"click",function(n){sj_pd(n)}));else r=this.panelRoot.select("#LayoutSortBar")[0],r&&this.registerFilterEventHandlers(r);u=this.panelRoot.select("#bm_contextualTaskbar")[0];u&&(f=u.getElementsByClassName("bm_filterBar")[0],f&&this.registerFilterEventHandlers(f))},c.prototype.registerFilterEventHandlers=function(n){var e=n.getElementsByClassName("filterOption"),i,t,r,u,f;for(this._bindFiltersV2(e),i=n.getElementsByClassName("b_toggle"),t=0,r=i.length;t<r;t++)u=i[t],sj_be(u,"click",function(n){sj_pd(n)});f=n.getElementsByClassName("b_filterCtrl");this._bindMultiselectFilters(f)},c.prototype.registerFilterBarSwitchQueryEventHandlers=function(){var n=this,t=this.panelRoot.select("#bm_contextualTaskbar .bm_searchSwitch a[data-switchquery]"),i;if(t&&t.length>0)for(i=0;i<t.length;i++)t[i].addEventListener("click",function(t){var i,r;t.preventDefault();i=t.currentTarget.getAttribute("data-switchquery");i&&(n._taskState.localFilters=null,n._taskState.query=i,r={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:n._taskState.query,FT:5,IS:!0}}},e.invokeHandler(f.instrumentationDataHandlerKey,r),n.viewModel&&n.viewModel.resetServerPagination&&n.viewModel.resetServerPagination(),n._resetFilterStates(),n._refresh({forceLogAsLocalListingTask:!0,forceLoggingEntryPoint:u.QuerySwitch}),n._resetMicropois(),n._requestMicroPoiRefresh(n._getTaskState()))})},c.prototype.logInstrumentationEventForServerRenderedFilter=function(n){var t=n.currentTarget&&n.currentTarget.parentElement&&n.currentTarget.parentElement.className,i=t==="ftrPr"?1:t==="ftrRt"?2:0,r=n.currentTarget&&n.currentTarget.parentElement&&n.currentTarget.parentElement.parentElement&&n.currentTarget.parentElement.parentElement.getAttribute("data-filterkey"),u={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:this._taskState.query,FT:i,FA:this._taskState.localFilters,IS:!0,CK:r}}};e.invokeHandler(f.instrumentationDataHandlerKey,u)},c.prototype._resetFilterStates=function(){this._taskState.localFilters=""},c.prototype._processLocalTopicLinks=function(){var t=this,n;this.panelRoot&&this.id&&(n=this.panelRoot.select("div[class=topicsModuleContainer]"),n&&n.length&&n.for_each(function(n){var r=i(n).select("a[data-process]");r&&r.length&&r.for_each(function(n){var u=n.getAttribute("data-process"),r=u&&i.Internals.parseJSON(u);r&&(r.requestorId=t.id,n.setAttribute("data-process",i.Internals.stringify(r)))})}))},c.prototype._registerNoResultResetFiltersClickHandler=function(){var n=this,t,i;this.panelRoot&&(t=this.panelRoot.select("div[data-answerinfo]"),t&&t.length&&t.get_attr("data-answerinfo")==="0"&&(i=this.panelRoot.select(".bm_resetButton"),i&&i.length&&i.add_event("click",function(t){t&&t.preventDefault();n._resetFilterStates();n._categories&&n._categories.length>0&&n._updateCategories("updateFilters",n._taskState.localFilters);n.viewModel&&n.viewModel.resetServerPagination&&n.viewModel.resetServerPagination();o.prototype._refreshWithDelay.call(n,{mapPannedOrZooomed:!0})})))},c.prototype._setFocusToClickedSortOptionIfApplicable=function(){if(this._sortOptionClickedToReloadContent){var n=this.panelRoot.select(".selectedSortOption");n&&n.length>0&&n[0].focus();this._sortOptionClickedToReloadContent=!1}},c.prototype._bindFiltersV2=function(n){var i=this,r,u,t;if(n&&n.length)for(r=0,u=n.length;r<u;r++)(t=n[r],t.className&&t.className.indexOf("selectedSortOption")>=0)||(sj_be(t,"click",function(n){var r=n.currentTarget.getAttribute("data-filterParam"),t=i.decodeHtmlEncoding(r);if(typeof t!="undefined"){i.onFilterValueChanged(t);i.logInstrumentationEventForServerRenderedFilter(n)}}),sj_be(t,"keydown",function(n){var t=n.which;(t===13||t===32)&&(event.currentTarget.className.indexOf("bm_sortOption")>=0&&(i._sortOptionClickedToReloadContent=!0),n.currentTarget.click&&n.currentTarget.click())}))},c.prototype._bindMultiselectFilters=function(n){for(var r,i,t=0;t<n.length;t++)r="",i=n[t].getElementsByClassName("b_filterOverlay"),i&&i.length>0&&(r=i[0].getAttribute("data-filterkey")),this._bindMultiselectFilterForId(n[t].id,r)},c.prototype._bindMultiselectFilterForId=function(n,t){var r=this;sj_evt.bind("filterItems_selected",function(u){var c,p,a,b,v,l,k;if(u[1]&&u[1].FilterControlId===n){var y=u[1],d=y.FilterControlId,s=y.SelectedFilterItemIds,o="";if(s&&s.length>0){if(o=i("#"+s[0]).get_attr("data-filterparam"),s.length>1){for(c=r.extractLocalFilterArgs(o),p=c.join(","),a=1;a<s.length;a++)for(b=i("#"+s[a]).get_attr("data-filterparam"),v=r.extractLocalFilterArgs(b),l=0;l<v.length;l++)c.indexOf(v[l])===-1&&c.push(v[l]);o=o.replace(p,c.join(","))}}else o=i("#fo_"+d).get_attr("data-nofilterparam");o=r.decodeHtmlEncoding(o);r.onFilterValueChanged(o);k={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:r._taskState.query,FT:6,FA:r._taskState.localFilters,IS:!0,CK:t}}};e.invokeHandler(f.instrumentationDataHandlerKey,k)}})},c.prototype.extractLocalFilterArgs=function(n){var r=n,i=r.indexOf("local_filters:&quot;")+20,t;return i===19?[]:(t=r.substr(i),i=t.indexOf("&quot;"),i===-1)?[]:(t=t.substr(0,i),t.length===0)?[]:t.split(",")},c.prototype.decodeHtmlEncoding=function(n){var t=sj_ce("textarea");return t.innerHTML=n,t.value},c.prototype._onPoiViewStateChanged=function(n,t){var y=this,i=n.primitive.entity,o,h,a;if(i){o=this.pageProcessor.getListItem(i.id);this._logPoiHoverIfNecessary(n,u.LocalListing,t);switch(n.newValue){case 1:if(this.viewModel&&this.viewModel.loadDelayedListingImagesInPagination(),h=n.primitive,t?(a=this._defaultInfoboxContentsTemplate.replace("{title}",i.getTitle()),this.activateInfobox(h,a,!0)):this.activateInfobox(h),Microsoft.Maps.setTimeout(function(){y._registerInfoboxClickHandler(i,t)},501),this._taskState&&typeof this._taskState.scrollListOnPoiHover!="undefined"&&!this._taskState.scrollListOnPoiHover)return;this._contextMenuOnListMode&&this._hideListItemContextMenu();this.viewModel.getResponseContainer().add_class(c._hoverClassName);break;case 2:if(i.id){o&&(this.viewModel.getResponseContainer().remove_class(c._hoverClassName),o.remove_class(c._hoverClassName));c._mapsInfobox&&c._mapsInfobox.setOptions({visible:!1});var v=this._getTaskState()&&this._getTaskState().directionsTaskId,b=v?u.POIAlongRoute:u.POI,k=this.pageProcessor.getCatId(this.viewModel.getResponseContainer()),p=this._getPoiLocalTaskState(i,v),w={parentId:this.id};e.invokeHandler(f.taskDataHandlerKey,{type:s.localDetailsTask,state:p,activateOptions:w});this._logPoiClick(i,t);this._setSelectedPrimitive(n.primitive)}break;case 0:if(l.mouseoverTimeout===0&&(l.mouseoverTimeout=500),window.clearTimeout(l.mouseoverDelayHandle),l.mouseoverDelayHandle=window.setTimeout(function(){l.mapsInfobox&&(l.mapsInfobox.preventAutoClose||l.mapsInfobox.setOptions({visible:!1}))},l.mouseoutTimeout),o){if(r._getIsSlideCardEnabled()&&this._taskState.selectedEntityId&&o===this.pageProcessor.getListItem(this._taskState.selectedEntityId))break;this.viewModel.getResponseContainer().remove_class(c._hoverClassName);o.remove_class(c._hoverClassName);c._mapsInfobox&&c._mapsInfobox.getVisible()&&(c._mapsInfobox.preventAutoClose||c._mapsInfobox.setOptions({visible:!1,closeDelayTime:500}))}}}},c.prototype._registerInfoboxClickHandler=function(n,r){var o=this,u=i(".infoBoxLink"),h;u&&(h=this._getTaskState()&&this._getTaskState().directionsTaskId,u.set_attr("aria-label",t.InfoboxListAriaLabel),u.set_style({cursor:"pointer"}),u.add_event("click",function(t){var i=o._getPoiLocalTaskState(n,h),u={parentId:o.id};e.invokeHandler(f.taskDataHandlerKey,{type:s.localDetailsTask,state:i,activateOptions:u});o._logInfoboxClick(n,r);t&&(t.preventDefault&&t.preventDefault(),t.stopImmediatePropagation&&t.stopImmediatePropagation())}))},c.prototype._getPoiLocalTaskState=function(n,t){var i=this.pageProcessor.getCatId(this.viewModel.getResponseContainer());return{entryPoint:u.Infobox,id:n.id,flippingCard:!0,taskTitle:n.getTitle(),directionsTaskId:t,selectedCategoryId:i?i:n.getSelectedCategoryForIcon&&n.getSelectedCategoryForIcon(),originIG:this._taskState&&this._taskState.originIG,parentIG:this._getImpressionGuid(),iid:this.pageProcessor.iids&&this.pageProcessor.iids[n.id],searchQueryCategory:this._taskState&&this._taskState.searchQueryCategory,listingCategoryPath:this.pageProcessor.getListingCategoryPath(this.viewModel.getResponseContainer()),asName:n&&n.getTitle&&n.getTitle(),asFormattedAddress:n&&n.getAddress&&n.getAddress()}},c.prototype._updateStateWithQueryParseData=function(){var t=this,r=this.panelRoot.select("div[data-queryparse]"),u,n,f;r&&r.length===1&&(u=r[0].getAttribute("data-queryparse"),u&&(n=i.Internals.parseJSON(u),n&&(n.queryKeyword&&(this._queryKeyword=n.queryKeyword.trim(),this._getTaskState().query=this._queryKeyword,this.setTitle(this._queryKeyword),this._initialTitle=this._queryKeyword,this._updateCategories("updateQuery"),f=this.poiManager,f&&f.labelsRendered.addOne(function(){t._taskState.mapBounds=t._getLocalMapViewBounds();t.serializableObjectChanged.invoke({magnitude:0})})),n.spellerCorrectedQuery&&(this._getTaskState().spellerCorrectedQuery=n.spellerCorrectedQuery),n.queryLocation&&(this._getTaskState().queryParseLocation=n.queryLocation),n.microPoiRequestIsAllowed&&(this._getTaskState().microPoiRequestIsAllowed=n.microPoiRequestIsAllowed),n.chainId&&(this._chainId=n.chainId),n.catId&&(this._catId=n.catId))))},c.prototype._logPoiClick=function(n,t){if(this._getTaskState()){var r=this._getTaskState().query||"",u=t?!0:!1,i=this._getlogData(n.id,r,u,w.POI);this.isSearchAlongRouteEnabled()&&(i.logData.data.AL=!0);e.invokeHandler(f.instrumentationDataHandlerKey,i);this._logInstrumentationEventForEntityClick()}},c.prototype._logInfoboxClick=function(n,t){var i,r,f;this._getTaskState()&&(i=this._getTaskState().query||"",r=t?!0:!1);f=this._getlogData(n.id,i,r,u.Infobox)},c.prototype._getlogData=function(n,t,i,r){return{logData:{feature:r,action:h.Clicked,data:{ID:n,Q:t,BB:this._getLocalMapViewBounds(),MP:i}}}},c.prototype._updateSelectedPrimitiveById=function(n){for(var t,r=this.getMapPrimitives(),i=0;i<r.length;i++)if(t=r[i],t&&t.entity&&t.entity.id===n){this._taskState.selectedEntityId=null;this._setSelectedPrimitive(t);return}},c.prototype._setSelectedPrimitive=function(n){var t,i;if(this._taskState){if(this._taskState.selectedEntityId){if(this._taskState.selectedEntityId===n.entity.id)return;this._resetSelectedPrimitive()}r._getIsSlideCardEnabled()&&(t=this.panelRoot.select("a.listings-item.hover"),t&&t.length&&t.remove_class(c._hoverClassName),i=this.pageProcessor.getListItem(n.entity.id),i&&(this.viewModel.getResponseContainer().add_class(c._hoverClassName),i.add_class(c._hoverClassName)));this._taskState.selectedEntityId=n.entity.id}},c.prototype._hideSelectedPrimitive=function(n){var t=this.viewModel.UpdatePrimitiveState(n,3);t&&(this.serializableObjectChanged.invoke({magnitude:0}),this.poiManager.invalidated.invoke())},c.prototype._resetSelectedPrimitive=function(){var n=this.viewModel.UpdatePrimitiveState(this._taskState.selectedEntityId,0);n&&this.poiManager.invalidated.invoke()},c.prototype._processItemClickEvent=function(n){for(var i=this.viewModel.getPushpinPrimitives(),t=0,r=i.length;t<r;t++)if(i[t].entity.id===n){this._setSelectedPrimitive(i[t]);break}this._logInstrumentationEventForEntityClick()},c.prototype.concatOverlayPrimitive=function(){this._contextMenuOnListMode?this._hideListItemContextMenu():o.prototype.concatOverlayPrimitive.call(this)},c.prototype._hideListItemContextMenu=function(){this._contextMenuOnListMode=!1;this._contextMenuElement.removeFromParent();this._contextMenuElement=null},c.prototype._hideContextMenuForOtherListingTasks=function(){var n={requestorType:s.localListingTask,requestorId:this.id,type:s.localListingTask,requestState:{hideContextMenu:!0},useActiveTasks:!0};e.invokeHandler(f.taskProcessDataHandlerKey,n)},c.prototype._processContextMenuEvent=function(n,t){var u=this,e,f,o;for(this._contextMenuOnListMode&&this._hideListItemContextMenu(),this._hideContextMenuForOtherListingTasks(),this._contextMenu.hide(),e=this.viewModel.getPushpinPrimitives(),f=0,o=e.length;f<o;f++)if(e[f].entity.id===t){n.preventDefault&&n.preventDefault();n.stopPropagation&&n.stopPropagation();var s=i(n.currentTarget),h=n.pageX,l=n.pageY-c._contextMenuTopPadding;this._contextMenuOnListMode=!0;this._transientLensViewModel.buildMenu(e[f],s,function(n){u._contextMenuElement=r._createElement("div");u._contextMenuElement.add_class("bm_listMenu").set_style({left:h,top:l,"pointer-events":"none"});n.appendTo(u._contextMenuElement);u.primitiveInteracted.invoke({action:1,element:u._contextMenuElement})})}},c.prototype._processSaveButtonClickEvent=function(n,t,r){var s=this.viewModel.getPushpinPrimitives(),e,l,o,f,a,c;if(s)for(e=0,l=s.length;e<l;e++)if(s[e].entity.id===r){if(n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation(),o=s[e].entity,!o)return;if(f=o.getLocation(),this._transientLensViewModel.getButtonGroupViewModel().setEntityData(o,{requestorType:"LocalListingTask",requestorId:this.id},i(t.parentElement)),!o||!f)return;a=(new ti).getIsSignedIn();c={logData:{feature:w.ListingCard,action:h.Clicked,data:{AN:"CollectionsMenu",CP:f,EP:u.LocalListing}}};a?this._transientLensViewModel.getButtonGroupViewModel().collectionMenuButtonClicked(n,f,c,u.LocalListing):at.isEditable?this._transientLensViewModel.getButtonGroupViewModel().saveWithTravelButtonClicked(n,f,c,u.LocalListing):this._transientLensViewModel.getButtonGroupViewModel().collectionButtonClicked(n,f,c,u.LocalListing)}},c.prototype._shouldProcessResponseOnRefresh=function(n,t){var i=!!this._taskState.localFilters||this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>0,u=t&&t.mapPannedOrZooomed;return o.prototype._shouldProcessResponseOnRefresh.call(this,n)||i&&!u||r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&this._taskState.scenarioKey==="ERR"},c.prototype._postRefresh=function(){sj_evt&&this.displayState&&this.displayState.prominence===1&&this.displayState.stackOrder===1&&sj_evt.fire("OnCardRefresh",this.panelRoot,this.stackId)},c.prototype._requestMicroPoiRefresh=function(n){if(n&&!(this._categories.length>0)&&!n.forceDisableMicroPoi){var t=this._isRestaurantMicropoiAllowed(n),i=this.viewModel.getCardCategoryId(),r=i==="School";(n.microPoiRequestIsAllowed||r||t||this.microPoiRequestForLocalOverlayIsAllowed())&&this._microPoiManager&&this._microPoiManager.fetchMicroPois(n.query,this.getMapPrimitives(),n.localFilters&&!t?n.localFilters:t&&n.isFilterSelected?"filterselected":null,this._chainId,this._catId,r?"90199":i)}},c.prototype._isRestaurantMicropoiAllowed=function(n){var t=this.viewModel.getEntities();return(t&&t.length>=15||this._chainId)&&(n.isFallbackRequery&&(n.category&&r._isRestaurantCategory(n.category)||n.searchQueryCategory&&n.searchQueryCategory.indexOf("Restaurant")>-1)||this instanceof kr)?(this._catId||(this._catId="90287"),!0):!1},c.prototype._onCategoriesChanged=function(n){var i,c,o,t,s,h;if(n.added&&this._taskState)for(i=0,c=n.added.length;i<c;i++)o=null,t=n.added[i],t&&r._isHotelsCategory(t)&&this._taskState.keyRoutePoints&&this._taskState.keyRoutePoints.length>=2&&(o=this._getPointsString(this._taskState.keyRoutePoints)),s=t,r._isHotelsCategory(t)&&(s="hotel"),h=this._taskState.query,(ki.useRootQueryInitially[s]||ki.useRootQueryAlways)&&this._taskState.rootKeyword&&(h=this._taskState.rootKeyword),e.invokeHandler(f.layerManagerDataHandlerKey,{action:"activateLayer",entryPoint:u.LocalListing,taskId:this.id,queryText:h,category:t,displayState:this.displayState,filters:r._isLocalOrRealEstateScenarioOverlayShownOnSerp()?this._taskState.localFilters||this._taskState.filterUrlParam:this._taskState.localFilters,cacheId:this._taskState.cacheId,mapBounds:this._taskState.mapBounds,routePoints:o,taskEntities:this.viewModel.getEntities(),disableRefresh:this._taskState.disableListingRefresh})},c.prototype._updateCategories=function(n,t,i,r){for(var o=0,s=this._categories.length;o<s;o++)e.invokeHandler(f.layerManagerDataHandlerKey,{action:n,entryPoint:u.LocalListing,taskId:this.id,displayState:i,filters:t,category:this._categories[o],queryText:this._taskState.query,taskEntities:r})},c.prototype._drawBoundary=function(){var t=this,n=this.panelRoot.select("div[data-vdpid]").get_attr("data-vdpid")||this._taskState&&this._taskState.vdpid,i=!1;if(n&&this._taskState){if(n===c._clearAttributeValue&&this._polygonLayerAdded&&this._cityPolygonManager){this._cityPolygonManager.removeLayer();this._polygonLayerAdded=!1;return}this._taskState.vdpid&&this._taskState.vdpid!==n&&(i=!0);this._taskState.vdpid=n}this._taskState&&this._taskState.vdpid&&this._taskState.vdpid!==c._clearAttributeValue&&(!this._polygonLayerAdded||i)&&(this._polygonLayerAdded&&this._cityPolygonManager&&this._cityPolygonManager.removeLayer(),this._cityPolygonManager?this._cityPolygonManager.addLayer(this._taskState.vdpid,c._polygonMinZoomLevel,c._polygonMaxZoomLevel):this.map.getCityPolygonManager().then(function(n){t.disposables.push(t._cityPolygonManager=n);n.addLayer(t._taskState.vdpid,c._polygonMinZoomLevel,c._polygonMaxZoomLevel)}),this._polygonLayerAdded=!0)},c.prototype._setPivotPrimitive=function(){var t=this._taskState.pivotEntity=this._taskState.pivotEntity||this.panelRoot.select("div[data-pivot]").get_attr("data-pivot"),n,r,u;if(t&&this.poiManager){if(t===c._clearAttributeValue){this.poiManager.setPivotPrimitive(null);return}typeof t=="string"&&(t=this._taskState.pivotEntity=i.Internals.parseJSON(t));n=t;n&&n.name&&n.idType&&n.id&&n.location&&n.location.latitude&&n.location.longitude&&!isNaN(n.location.latitude)&&!isNaN(n.location.longitude)&&(r=new b(n.location.latitude,n.location.longitude),u=new hi(n.name,null,n.idType+":"+n.id,r,r),u.setSearchCategory("PivotEntity"),u.setSelectedCategoryForIcon("PivotEntity"),this.poiManager.setPivotPrimitive(new ci(r,u)))}},c.prototype._setDisableListingRefresh=function(t){var i,r;this._taskState.disableListingRefresh!==!1&&this._taskState.scenarioKey==="EIC"&&(i=d.parseCategory(t),i=i&&i.toLowerCase(),n.enableListingRefreshCats&&n.enableListingRefreshCats.indexOf(i)>-1&&(this._taskState.disableListingRefresh=!1,r=this._queryKeyword||i,this._taskState.query=this._taskState.taskTitle=r,this._initialTitle=r,this.setTitle(r)))},c.prototype._getPoiCountParam=function(){var n="";return this._taskState&&this._taskState.poiCount!==null&&(n=this._taskState.poiCount),n},c._clearAttributeValue="nodata",c._hoverClassName="hover",c._polygonMinZoomLevel=3,c._polygonMaxZoomLevel=11,c._contextMenuTopPadding=25,c}(l),hf=function(t){function u(n,i,r,u,f,e,o,s){var h=t.call(this,n,i,r,u,f,e,o,s)||this;return h._infoboxOptions={showCloseButton:!1,zIndex:1006,showPointer:!1,visible:!0,htmlContent:null,location:null,autoAlignment:!0},h._bindEventsForInfobox(),h}return v(u,t),u.prototype.activate=function(n,i){var r=this,u=this._taskState&&this._taskState.isCompareOverlayOpen,f=i&&i.isCompareOverlayOpen;if(u&&!f){sj_evt.fire("ovlHide","ent_ovlc",!0);return}this._compareOverlayShowHandlerWrapper||(this._compareOverlayShowHandlerWrapper=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];r._compareOverlayShowHandler.apply(r,t[0])},sj_evt.bind("ovlShow",this._compareOverlayShowHandlerWrapper,0));this._compareOverlayHideHandlerWrapper||(this._compareOverlayHideHandlerWrapper=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];r._compareOverlayHideHandler.apply(r,t[0])},sj_evt.bind("ovlHide",this._compareOverlayHideHandlerWrapper,0));t.prototype.activate.call(this,n,i)},u.prototype._refresh=function(n){n&&n.mapPannedOrZooomed&&this._taskState.locationFilter&&(this._taskState.locationFilter=null,this._updateLocalFiltersForPricePoi(),this._updateCategoriesLayer("updateFilters",this._taskState.localFilters));t.prototype._refresh.call(this,n);r._isLocalOverlayShownOnSerp()&&n.isResearchOnOverlay&&this._updateCategoriesLayer("refreshData")},u.prototype.setDisplayState=function(n){n&&n.activationState===1&&n.prominence===1&&this._taskState&&this._taskState.keyRoutePoints&&(n.suppressViewChange=!0);t.prototype.setDisplayState.call(this,n)},u.prototype._updateCategoriesLayer=function(n,t){var i,u,o;if(this._categories&&this._categories.length>0)for(i=0,u=this._categories.length;i<u;i++)r._isHotelsCategory(this._categories[i])&&(o={action:n,taskId:this.id,category:this._categories[i],filters:t},e.invokeHandler(f.layerManagerDataHandlerKey,o))},u.prototype._resetFilterStates=function(){if(t.prototype._resetFilterStates.call(this),n.showPricePoiHotelsOnOneMap){if(_w.priceFilterPrice="$500",n.enableHotelBackendDates)_w.ol_startdate=undefined,_w.ol_enddate=undefined;else{var i=this._getNextNextNextSunday();_w.ol_startdate=i.toDateString();i.setDate(i.getDate()+1);_w.ol_enddate=i.toDateString()}this._taskState.locationFilter=null}},u.prototype._createUrl=function(r,u,f){var o,e;(!f||f===20)&&n.threeColumnListSegmentsEnabled&&n.threeColumnListSegmentsEnabled.length>0&&n.threeColumnListSegmentsEnabled.indexOf("Hotel")>-1&&this._isThreeColumnsOk(r)&&(f=21);this._taskState&&(this._taskState.isFallbackRequery=!0,this._taskState.scrollListOnPoiHover=!1,this._taskState.sendInstrumentationEventOnEntityClick=!0);this._updateLocalFiltersForPricePoi();o=t.prototype._createUrl.call(this,r,u,f);r&&(r.filterValueChanged||r.mapPannedOrZooomed)&&(o+="&htlsource=overlayf");var h=Logger.getOverlayType(),s=this._taskState.passThruParam;if(h?o+=this._taskState.originIG&&this._taskState.originIG===y.dynamicProperties.serpIG?s&&s.indexOf("hotelCollectionOverlay=1")!==-1?"&FORM=HOTELC":"&FORM=BHO001":"&FORM=BHO002":(o+="&FORM=BHO003",o+="&mapsVertical=true"),s&&s.toUpperCase().indexOf("FORM=")===-1&&(o+=s.indexOf("&")!==0?"&"+s:s),this._taskState.cacheId&&(o+="&cacheid="+this._taskState.cacheId),this._taskState.pivotEntity){if(e=this._taskState.pivotEntity,typeof e=="string"&&e!==ot._clearAttributeValue)try{e=i.Internals.parseJSON(e)}catch(c){}e=e;e&&e.id&&e.location&&e.location.latitude&&e.location.longitude&&(o+="&pivotinfo="+e.id+"|"+e.location.latitude+"|"+e.location.longitude)}return this._taskState.hotelCompare&&(o+="&compsel=2"),o},u.prototype._getCacheId=function(){return""},u.prototype.onFilterValueChanged=function(n,i){var f,r,e,u,o;this._taskState.originIG&&(f=/GST(\d{1,2})/,r=f.exec(n),r&&r.length>1&&(e=r[1],u=f.exec(this._taskState.localFilters),u&&u.length>1&&(o=u[1],e!=o&&sj_evt.fire("VRGuestsFilterChanged_"+this._taskState.originIG,e))));this._updateLocalFiltersForPricePoi(n);t.prototype.onFilterValueChanged.call(this,this._taskState.localFilters,i)},u.prototype.processResponse=function(n,i){var r,u;t.prototype.processResponse.call(this,n,i);this._taskState&&this.panelRoot&&(r=this.panelRoot.select("div[data-cacheid]"),r&&r.length===1&&(u=r[0].getAttribute("data-cacheid"),u&&(this._taskState.cacheId=u)))},u.prototype.registerFilterBarEventHandlersV2=function(){var i=this.panelRoot.select("#bm_contextualTaskbar")[0],n;i&&(this._processCalendarControl(),this._processPriceFilter(),n=i.getElementsByClassName("bm_filterBar")[0],n&&(_w.hpaFilter=n.getAttribute("fp"),this._processLocationFilter(n)));t.prototype.registerFilterBarEventHandlersV2.call(this)},u.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForLocalOverlayOnSerp},u.prototype._getPriceFilterFromUrlParam=function(){var n=this._taskState.filterUrlParam,i,t,u,r,f;if(n&&n.length>0&&(i=n.indexOf("LHP"),i>-1&&(t=n.indexOf("_",i),t>-1&&(u=n.substring(i+4,t),r=n.indexOf("_",t+1),r>-1))))return f=n.substring(t+5,r),"LHP-"+u+"_HHP-"+f},u.prototype._updateLocalFiltersForPricePoi=function(t){var h,p,w,e,i,r,l,a,t,v,s,y;if(n.showPricePoiHotelsOnOneMap){if(this._taskState&&this._taskState.localFilters&&this._taskState.fromSharing){h=this._taskState.localFilters;this._saveDateFromFilters(h,"_SD-\\d{8}","ol_startdate");this._saveDateFromFilters(h,"_ED-\\d{8}","ol_enddate");this._taskState.fromSharing=!1;return}p=this._taskState.filterUrlParam&&this._taskState.filterUrlParam.indexOf('HaveCustomFilters:"true"')!==-1;_w.ol_hdf=!0;p||(_w.priceFilterPrice=_w.priceFilterPrice||"$500");w=n.enableHotelBackendDates?null:this._getNextNextNextSunday().toDateString();_w.ol_startdate=this._getTaskStateStartDate()||_w.ol_startdate||w;_w.ol_enddate=this._getTaskStateEndDate()||_w.ol_enddate;_w.ol_enddate||n.enableHotelBackendDates||(e=this._getNextNextNextSunday(),e.setDate(e.getDate()+1),_w.ol_enddate=e.toDateString())}if(i=t||this._taskState.localFilters||this._taskState.filterUrlParam,i?i.indexOf('local_filters:"UR')===-1&&i.indexOf(",UR")===-1&&(i=i.replace('local_filters:"','local_filters:"UR4U,')):i='local_filters:"UR4U"',_w.ol_hdf){if(r="",r=_w.priceFilterPrice?"LHP-0_HHP-"+_w.priceFilterPrice.replace("$","").replace("+",""):this._getPriceFilterFromUrlParam(),_w.ol_startdate&&_w.ol_enddate){var b="MMddyyyy",k=_w.ol_startdate,d=_w.ol_enddate,u=null,f=null,c=_w.SpecificDateFormat,o=_w.DateFormatSeparator;typeof DateHelper!="undefined"&&typeof DateHelper.parseShortDate!="undefined"&&(c?(u=DateHelper.parseShortDate(k,o,c.split(o)),f=DateHelper.parseShortDate(d,o,c.split(o))):(u=DateHelper.parseShortDate(k),f=DateHelper.parseShortDate(d)));(!u||isNaN(u.valueOf()))&&(u=new Date(_w.ol_startdate));(!f||isNaN(f.valueOf()))&&(f=new Date(_w.ol_enddate));l=this._calendarFormatDate(u,b);a=this._calendarFormatDate(f,b);r=r?r+"_SD-"+l+"_ED-"+a:"SD-"+l+"_ED-"+a}t='hotel_filters:"'+r+'" segment:"Hotel"';v=i.indexOf("hotel_filters");i=v===-1?i+" "+t:i.slice(0,v)+t}this._taskState.locationFilter?i+=" "+this._taskState.locationFilter:_w.hotelLocationFilter&&(i+=" "+_w.hotelLocationFilter);i.indexOf("LocationFilterKey")===-1&&this.panelRoot&&(s=this.panelRoot.select("div[data-locationfilterkey]"),s&&s.length&&(y=s.get_attr("data-locationfilterkey"),y&&(i+=' LocationFilterKey:"'+y+'"')));this._taskState.localFilters=i},u.prototype._compareOverlayShowHandler=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t[1]==="ent_ovlc"&&(this._taskState.isCompareOverlayOpen=!0,this.serializableObjectChanged.invoke({magnitude:2}))},u.prototype._compareOverlayHideHandler=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t[1]==="ent_ovlc"&&(this._taskState.isCompareOverlayOpen=!1,!t[2]==!0&&this.serializableObjectChanged.invoke({magnitude:2}))},u.prototype._bindEventsForInfobox=function(){sj_evt&&sj_evt.bind("pushpinhoverstarted",function(n){var t=n[1],u=t.entity.id.replace("ypid:","").replace("sid:",""),i=_ge(u),f,r;i&&(f=new Microsoft.Maps.Location(t.geometry.y,t.geometry.x),r="<div class='MiniInfobox2' id='infobox-container'><a class='infoBoxLink' role='button' href='#'><div class='infobox-body'>"+i.innerHTML+"<\/div><\/a><\/div>",t.entity.infoboxHtml=r)})},u.prototype._processPriceFilter=function(){var n=this;this._priceChangeHandler&&sj_evt.unbind("priceFilterUpdate",this._priceChangeHandler);this._priceChangeHandler=function(){n.onFilterValueChanged(null);var t={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:n._taskState.query,FT:1,FA:n._taskState.localFilters,IS:!0}}};e.invokeHandler(f.instrumentationDataHandlerKey,t)};sj_evt.bind("priceFilterUpdate",this._priceChangeHandler)},u.prototype._processCalendarControl=function(){var n=this,t;this.panelRoot&&(t=this.panelRoot.select("div[data-calendarEndId]"),t&&t.length&&(this._calendarEndId=t.get_attr("data-calendarEndId")));this._calendarEndId&&(this._calendarChangeHandler&&sj_evt.unbind("TwoCalCombo_EndDateClick",this._calendarChangeHandler),this._calendarChangeHandler=function(t){var r=t[1],i;if(r==n._calendarEndId){_w.ol_startdate=t[2];_w.ol_enddate=t[3];n.onFilterValueChanged(null);i={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:n._taskState.query,FT:4,FA:n._taskState.localFilters,IS:!0}}};e.invokeHandler(f.instrumentationDataHandlerKey,i)}},sj_evt.bind("TwoCalCombo_EndDateClick",this._calendarChangeHandler))},u.prototype._processLocationFilter=function(n){var t=this,i=n.getElementsByClassName("catfOption"),r,u;if(i!=null&&i.length>0)for(r=0;r<i.length;r++)u=i[r],sj_be(u,"click",function(n){var u=n.currentTarget.getAttribute("data-filterParam"),i=t.decodeHtmlEncoding(u),r;if(i!=null){t._taskState.locationFilter=i;t._taskState.pivotEntity=null;t.onFilterValueChanged(null);r={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:t._taskState.query,FT:7,FA:t._taskState.localFilters,IS:!0}}};e.invokeHandler(f.instrumentationDataHandlerKey,r)}})},u.prototype._getNextNextNextSunday=function(){var n=new Date,t=6-n.getDay(),i=t+15;return n.setDate(n.getDate()+i),n},u.prototype._getTaskStateStartDate=function(){return this._taskState&&this._taskState.startDate?this._validatedDateString(this._taskState.startDate):null},u.prototype._getTaskStateEndDate=function(){return this._taskState&&this._taskState.endDate?this._validatedDateString(this._taskState.endDate):null},u.prototype._validatedDateString=function(n){var t;try{if(t=new Date(n),t){var i=t.getMonth(),r=t.getDate(),u=t.getFullYear();if(i>=0&&i<12&&r>0&&r<32&&u>2e3)return t.toDateString()}}catch(f){return null}return null},u.prototype._calendarFormatDate=function(n,t){var i=n.getMonth(),r=n.getDate();return t.replace(/yyyy/i,n.getFullYear().toString()).replace(/mm/i,(i<9?"0":"")+(i+1)).replace(/m/i,(i+1).toString()).replace(/dd/i,(r<10?"0":"")+r).replace(/d/i,r.toString())},u.prototype._saveDateFromFilters=function(n,t,i){var e=new RegExp(t,"i"),u=n.search(e),r,f;u>-1&&u+12<=n.length&&(r=n.substr(u+4,8),r&&r.length===8&&(f=this._convertFilterDate(r),f&&(_w[i]=f)))},u.prototype._convertFilterDate=function(n){var r;if(n&&n.length===8){var t=parseInt(n.substr(0,2),10),i=parseInt(n.substr(2,2),10),u=parseInt(n.substr(4,4),10);return isNaN(t)||t<1||t>12||isNaN(i)||i>31||i<1||isNaN(u)?null:(r=new Date(u,t-1,i),r?r.toDateString():null)}return null},u.prototype._getSegmentParam=function(){return"hotel"},u}(ot),cf=function(t){function i(i,r,u,f,e,o,s,h,c,l){var a=t.call(this,i,r,u,f,e,o,s,h,c,l)||this;return a.setRecommendedWidth(n.houseCardWidth),a.setCurrentWidth(n.houseCardWidth),a}return v(i,t),i.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForRealEstateOverlayOnSerp},i.prototype.processResponse=function(n,i){t.prototype.processResponse.call(this,n,i);var r=n&&n.select("[data-interestdata]").get_attr("id");r&&this.map&&this.poiManager&&this.disposables.push(this.poiManager.labelsRendered.addOne(function(){var n="SubscriptionComponent_Init_"+r;sj_evt.fire(n)}))},i.prototype._getSegmentParam=function(){return"house"},i}(dt),lf=function(t){function i(n,i,r,u,f,e,o,s){var h=t.call(this,n,i,r,u,f,e,o,s)||this;return h._infoboxOptions={showCloseButton:!1,zIndex:1006,showPointer:!1,visible:!0,htmlContent:null,location:null,autoAlignment:!0},h._bindEventsForInfobox(),h}return v(i,t),i.prototype._refresh=function(n){this.map.getMapType().id!==nr.birdseyeV2&&t.prototype._refresh.call(this,n)},i.prototype._createUrl=function(n,i,r){return this._taskState&&(this._taskState.poiCount="20",this._taskState.isFallbackRequery=!0,this._taskState.scrollListOnPoiHover=!1,this._taskState.sendInstrumentationEventOnEntityClick=!0,this._taskState.spellerCorrectedQuery&&(this._taskState.localFilters?(this._taskState.localFilters.indexOf("tsource:")<0&&(this._taskState.localFilters+=' tsource:"realestate"'),this._taskState.localFilters.indexOf("segment:")<0&&(this._taskState.localFilters+=' segment:"generic.carousel"'),this._taskState.localFilters.indexOf("secq:")<0&&(this._taskState.localFilters+=' secq:"'+this._taskState.spellerCorrectedQuery+'"')):this._taskState.localFilters='tsource:"realestate" segment:"generic.carousel" secq:"'+this._taskState.spellerCorrectedQuery+'"'),this._taskState.queryParseLocation&&(this._taskState.localFilters?this._taskState.localFilters.indexOf("loc:")<0&&(this._taskState.localFilters+=' loc:"'+this._taskState.queryParseLocation+'"'):this._taskState.localFilters='loc:"'+this._taskState.queryParseLocation+'"')),t.prototype._createUrl.call(this,n,i,r)},i.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForRealEstateOverlayOnSerp},i.prototype.logInstrumentationEventForServerRenderedFilter=function(n){var t=n.currentTarget&&n.currentTarget.parentElement&&n.currentTarget.parentElement.id,i={logData:{feature:w.FiltersBar,action:h.Selected,data:{Q:this._taskState.query,FT:t,FA:this._taskState.localFilters,IS:!0}}};e.invokeHandler(f.instrumentationDataHandlerKey,i)},i.prototype.processResponse=function(n,i){this._updateQueryParamsForSubscription(n);t.prototype.processResponse.call(this,n,i)},i.prototype._updateQueryParamsForSubscription=function(n){var r=this,t="data-interestdata",i=n&&n.select("["+t+"]").get_attr("id");i&&this.map&&this.poiManager&&this.disposables.push(this.poiManager.labelsRendered.addOne(function(){var e=et.getMapCenter(r.map),u=et.getMercatorZoomLevel(r.map),f=document.getElementById(i),n,o;f&&(n=f.getAttribute(t),n&&(n+=";"),n+="cp:"+e.latitude+"~"+e.longitude+";lvl:"+u,f.setAttribute(t,n),u>=9&&u<=20&&(o="SubscriptionComponent_Init_"+i,sj_evt.fire(o)))}))},i.prototype._bindEventsForInfobox=function(){sj_evt&&sj_evt.bind("pushpinhoverstarted",function(n){var t=n[1],u=t.entity.id.replace("ypid:","").replace("sid:",""),i=_ge(u),f,r;i&&(f=new Microsoft.Maps.Location(t.geometry.y,t.geometry.x),r="<div class='MiniInfobox2' id='infobox-container'><a class='infoBoxLink' role='button' href='#'><div class='infobox-body'>"+i.innerHTML+"<\/div><\/a><\/div>",t.entity.infoboxHtml=r)})},i.prototype._getSegmentParam=function(){return"house"},i}(ot),af=function(){function n(){this._birdseyePreviewInitialized=!1}return n.prototype.process=function(n,u,e){var o,c,h,s;n&&u&&(u.showBackButton&&(o=r._createElement("a"),o.add_class("commonButton backArrowButton overlayButton"),o.set_attr("href","#"),o.set_attr("title",u&&u.cameFromCollections?t.L_LocalSearch_BackToCollections:t.L_LocalSearch_BackToSearchResults),c=u.listingTaskId?{action:"focus",id:u.listingTaskId}:{action:"remove",id:u.id},o.set_attr(f.taskDataHandlerKey,i.Internals.stringify(c)),h=r._createElement("div"),h.add_class("overlayBackButtonText"),h.set_text(t.L_LocalSearch_ReturnToList),o.append(h),s=r._createElement("div"),s.set_attr("data-tag","detailsCardBackBtnContainer"),s.set_style({"padding-bottom":"35px"}),s.append(o),n.insertBefore(s,n[0].firstElementChild)),this._processStreetside(n,e,u),this._processGeochain(n,u))},n.prototype._processStreetside=function(n,t,r){var l=this,o=n.select("a[data-streetside]"),a=r?r.routablePoint:null,c,s,u,v,y,h;if(!er||!er.isEnabled){o&&o.getParent().getParent()&&o.getParent().getParent().removeFromParent();return}c=o&&o.get_attr("data-streetside");c?(s=i.Internals.parseJSON(c),u=s.localDetailsStartupOptions,u&&(u.fov=null,u.heading=null,u.pitch=null,!u.routablePoint&&a&&(u.routablePoint=a),o.set_attr("data-streetside",i.Internals.stringify(s))),u.canonicalImageUrlGroup&&u.canonicalImageUrlGroup.length?o.set_style({display:"block","background-image":"url('"+u.canonicalImageUrlGroup[0].url+"')"}):(o.set_attr("data-streetside",""),v=t&&t.start(ku.LocalDetailsIntegrationTime),u.sivImageContainer=o,r!=null&&r.location==null&&s!=null&&s.location!=null&&(r.location=new b(s.location.latitude,s.location.longitude)),y={action:"showBubbleImage",location:new b(s.location.latitude,s.location.longitude),localDetailsStartupOptions:u,perfState:v,callback:function(){l._processBirdsEyePreview(n,r,o,!1)},errorCallback:function(){l._processBirdsEyePreview(n,r,o,!0)}},e.invokeHandler(f.streetsideDataHandlerKey,y))):(h=n.select(".ssContainer"),h&&h.getParent()&&h.getParent().removeFromParent())},n.prototype._processBirdsEyePreview=function(n,t,i,r){var f=this,u;if(!this._birdseyePreviewInitialized){if(this._birdseyePreviewInitialized=!0,!n||!t||!t.map||!t.location){r&&i&&i.getParent().getParent()&&i.getParent().getParent().removeFromParent();return}u=n.select("a[id=bev2Img]");u&&u.length?(this._loadBirdsEyeThumbnail(n,t,i,r),t.map.mapResized.add(function(){f._loadBirdsEyeThumbnail(n,t,i,r)})):r&&i&&i.getParent()&&i.getParent().removeFromParent()}},n.prototype._loadBirdsEyeThumbnail=function(n,t,i,r){var h=this,u=n.select("a[id=bev2Img]"),c=t.location,f=t.map,o=lt.north,e=y.features.taskFramework,l=e&&e.defaultZoomLevel?e.defaultZoomLevel:16,s=ui.toLocation(c,l,!0),a=fu.imageryStartZoom+1;uu.getBirdseyeV2Thumbnail(f.getConfig(),s,a,function(n){var e;n?(u.set_style({"background-image":"url('"+n+"')"}),i.getParent().set_style({display:""}),i?(e=i.get_style("display"),e&&e.indexOf("none")===-1?(i.add_class("bm_sharedModule"),i.set_style({display:"inline-block"}),u.add_class("bm_sharedModule"),u.set_style({display:"inline-block"})):u.set_style({display:"block"})):u.set_style({display:"block"}),u.add_event("click",function(n){h._birdseyePreviewClicked(n,s,f,o,t.taskTitle,t.getDisplayState)})):(u.set_style({display:"none"}),e=i.get_style("display"),e&&e.indexOf("none")===-1&&(i.remove_class("bm_sharedModule"),i.set_style({display:"block"})),r&&i&&i.getParent().getParent()&&i.getParent().getParent().set_style({display:"none"}))},o,f.getViewport())},n.prototype._computeBirdsEyeHeading=function(n,t){if(!n||!t||isNaN(n.latitude)||isNaN(n.longitude)||isNaN(t.latitude)||isNaN(t.longitude))return lt.north;var r=this._toRad(n.longitude-t.longitude),u=Math.sin(r)*Math.cos(this._toRad(n.latitude)),f=Math.cos(this._toRad(t.latitude))*Math.sin(this._toRad(n.latitude))-Math.sin(this._toRad(t.latitude))*Math.cos(this._toRad(n.latitude))*Math.cos(r),e=this._toDeg(Math.atan2(u,f)),i=(e+360)%360;return i>=315||i>=0&&i<45?lt.north:i>=45&&i<135?lt.east:i>=135&&i<225?lt.south:i>=225&&i<315?lt.west:lt.north},n.prototype._toRad=function(n){return n*Math.PI/180},n.prototype._toDeg=function(n){return n*180/Math.PI},n.prototype._birdseyePreviewClicked=function(n,t,i,r,o,s){n&&n.preventDefault();n&&n.stopPropagation();e.invokeHandler(f.instrumentationDataHandlerKey,{logData:{feature:ft.BirdseyeV2,action:h.Clicked,data:{EP:u.LocalDetails,CP:t}}});var c=y.features.taskFramework,l=c&&c.defaultZoomLevel?c.defaultZoomLevel:16;et.setMapCenter(i,t,l,r,new au(i.getView(),new tr(ui.toLocation(t,l,!0),r)),null,null,{top:0,right:0,bottom:0,left:0});i.getFrameManager().frameRendered.addOne(function(){i.setMapType(i.createMapType(nr.birdseyeV2));i.getBirdseyeV2Manager().then(function(n){var i=s();n&&n.addContextPoi(t,o,i?i.colorIndex:3)})})},n.prototype._processGeochain=function(n,t){var i,r,u;t.geochainManager&&t.map&&(i=n?n.select(".geochainModule"):null,i&&t.location)&&(t.boundingBox||(t.boundingBox=[t.location,t.location,t.location,t.location]),r=di.fromCorners(t.boundingBox[0],t.boundingBox[1]),u=function(n){if(!n||n.length===0){i.parent().removeFromParent();return}var r=new ar(n,t.controlTemplateFactory);r.getControl().appendTo(i)},t.geochainManager.getGeochain(u,t.location,r,!0))},n}(),pr=function(){function e(){}return e.prototype.getCatId=function(n){var t;return r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&(t=this.getListingCategoryPath(n)),t},e.prototype.getListingCategoryPath=function(n){var i,t;return n&&(t=n.select("div[data-category]"),t&&t.length&&(i=t.get_attr("data-category"))),i},e.prototype.process=function(t,i){var f=this,u,r;t&&(this._listElements={},this.iids={},this._listItems=t.select("a[data-entity]"),u=this.getCatId(t),r=0,this._listItems.for_each(function(e){var o=f._processItem(r,t,e,u,i),s,h;n.listingPanelCarouselEnabled&&o&&o.entity&&(s=o.entity.fetchMoreUrl,h=e.parentElement,s&&h&&f._fetchListItemCarousel(s,h,t,r,u,i));r++}))},e.prototype._processItem=function(t,r,u,f,e){var p=u.getAttribute("data-entity"),o=p&&p.length>0&&i.Internals.parseJSON(p),c,l,w,s,a,b,v,y,h;if(o&&o.entity&&o.entity.id){if(c=i(u),l=o.entity.id,this._listElements[l]=c,w=u.getAttribute("h"),w&&(s=w.split("="),s&&s.length===2&&(s=s[1].split("."),s&&s.length&&(this.iids[l]=s[0].replace(",",".")))),h=this.getListingCategoryPath(r),a=!1,n.listingQuicksaveEnabled&&h&&n.listingQuicksaveCategoryWhitelist&&n.listingQuicksaveCategoryWhitelist.length>0)for(b=h.split("."),v=0;v<b.length;v++)if(n.listingQuicksaveCategoryWhitelist.indexOf(b[v])>-1){a=!0;break}a||(y=r.select(".quicksave"),y&&y.length>0&&y.remove_class("quicksave"));h=this.getListingCategoryPath(r);this._setTaskData(u,o.entity,e,f,h,o.extraFuiAugmentations);a&&this._addQuicksaveIcon(u,l,h,e);c.add_event("click",function(n){return e.clickHandler(n,o.entity.id)});c.add_event("contextmenu",function(n){return e.contextMenuHandler(n,o.entity.id)})}return this._updateListItemStyle(u),this._setInstrumentationData(u,o.entity.id,t,e),o},e.prototype.getListItem=function(n){return this._listElements[n]},e.prototype.getFirstListItem=function(){return i(this._listItems[0])},e.prototype._setInstrumentationData=function(n,t,r,u){var f={ID:t,Q:u&&u.query?u.query:"",PO:r+1},e=p[p.LLT]+"_"+h.Clicked,o={logData:{feature:ft.Search,action:e,data:f}};n.setAttribute("data-instrumentation",i.Internals.stringify(o))},e.prototype._updateListItemStyle=function(n){var t=i(n).select("div.inner img");t&&t.length!==0||i(n).select("div.inner").add_class("imgHolder")},e.prototype._setTaskData=function(n,t,e,o,h,c){var v=e&&e.directionsTaskId,y=v?u.LocalListingAlongRoute:u.LocalListing,l={entryPoint:y,id:t.id,flippingCard:!0,taskTitle:t.title,directionsTaskId:e&&e.directionsTaskId,selectedCategoryId:o?o:t.primaryCategoryPath,originIG:e&&e.originIG,parentIG:e&&e.parentIG,iid:this.iids[t.id],query:t.id?t.seeMoreQueryText:t.title,infoboxHtml:t.infoboxHtml,isBookingModuleEntryPoint:e&&e.isBookingModuleEntryPoint,listingCategoryPath:h,extraFuiAugmentations:c,asName:t&&t.title,asFormattedAddress:t&&t.address,disableWideCard:!0,adProviderId:t.adProviderId,adStoreId:t.adStoreId,adQuery:t.adQuery,adYpid:t.adYpid,adImpressionGuid:t.adImpressionGuid,adRetailEntitySource:t.adRetailEntitySource},a;l.id&&l.id.indexOf("eventId:")===0&&(l.latLongForEventRequery=t.latitude+","+t.longitude,l.locationForEventRequery=t.city);a={state:l,type:r._isFeatureEnabled("verticalZipcode")&&r._isZipCodeCategory(l.selectedCategoryId)?s.polygonEntityDetailsTask:s.localDetailsTask,activateOptions:{parentId:e&&e.taskParentId}};n.setAttribute(f.taskDataHandlerKey,i.Internals.stringify(a))},e.prototype._addQuicksaveIcon=function(r,u,f,e){var o=i(r).select(".bm_qsicon");o&&o.length>0&&n.listingQuicksaveClass&&(o.add_class(n.listingQuicksaveClass),n.listingQuicksaveClass==="bm_contextMenuButton"?(o.set_attr("title",t.L_EllipsisTooltip),o.add_event("click",function(n){return e.contextMenuHandler(n,u)})):n.listingQuicksaveClass==="bm_saveButton"&&(o.set_attr("title",t.L_EditButton),o.add_event("click",function(n){return e.saveButtonClickHandler(n,r,u)})))},e.prototype._fetchListItemCarousel=function(n,t,i,r,u,f){var e=this,o=function(n){var o,s,h,c;if(t.innerHTML="",sj_appHTML(t,n),typeof rms!="undefined"&&rms.start(),o=t.getElementsByClassName("listings-item"),o)for(s=0;s<o.length;s++)h=o[s],h&&(c=e._processItem(r,i,h,u,f),c&&f.listItemCarouselHandler(c,h))};it.downloadGeneric(n,"fetchListItemCarousel",o,null,null,null,0)},e}(),oi=function(n){function i(){var r=this,i={};return r=n.call(this,i)||this,r.resources=t,i.defineProperty("factLabel"),i.defineProperty("factData"),i.defineProperty("extendedFacts"),r}return v(i,n),i.prototype.dispose=function(){this.factData=null;this.factLabel=null},i.prototype.nullToDisplayNone=function(n){return n?"":"none"},i.prototype.displayOnTrails=function(n){return this.showIfEqual(n,"trails")},i.prototype.displayOnCampgrounds=function(n){return this.showIfEqual(n,"campgrounds")},i.prototype.showIfEqual=function(n,t){return n===t?"":"none"},i}(kt),wr=function(n){function t(){var i=this,t={};return i=n.call(this,t)||this,t.defineProperty("start"),t.defineProperty("end"),i}return v(t,n),t.prototype.dispose=function(){n.prototype.dispose.call(this);this.start=null;this.end=null},t}(kt),br=function(n){function t(){var i=this,t={};return i=n.call(this,t)||this,t.defineProperty("day"),t.defineProperty("hourRanges"),i}return v(t,n),t.prototype.dispose=function(){n.prototype.dispose.call(this);this.day=null},t}(kt),vf=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return v(t,n),t}(lr),vi=function(){function n(){}return n.getNameForProperty=function(n){switch(n){case"at":return t.L_PrintExtendedAt_Text;case"capital":return t.L_PrintExtendedCapitol_Text;case"countyseat":return t.L_PrintExtendedCounty_Text;case"area":return t.L_PrintExtendedArea_Text;case"population":return t.L_PrintExtendedPopulation_Text;case"cuisine":return t.L_PrintExtendedCuisine_Text;case"price":return t.L_PrintExtendedPrice_Text;case"hotelclass":return t.L_PrintExtendedHotelClass_Text;case"avgrate":return t.L_PrintExtendedAvgRate_Text;case"Founded":case"founded":return t.L_PrintExtendedFounded_Text;case"gdp":return t.L_PrintExtendedGDP_Text;case"callingcode":return t.L_PrintExtendedCC_Text;case"specialty":return t.L_PrintSpecialtyTitle_Text;case"experience":return t.L_PrintExperienceTitle_Text;case"clinic":return t.L_PrintClinicTitle_Text;case"homefacts":return t.L_PrintHomeFactsTitle_Text;case"moreinfo":return t.L_PrintMoreInfoTitle_Text;case"lastsold":return t.L_PrintLastSoldTitle_Text;case"zestimate":return t.L_PrintZestimateTitle_Text;case"Season":return t.L_PrintSeason_Text;case"Activity":case"Activities":return t.L_PrintActivities_Text;case"Rates":return t.L_PrintRates_Text;case"Open":return t.L_PrintOpen_Text;case"Sites":return t.L_PrintSites_Text;case"Interests":return t.L_PrintInterests_Text;case"Opened":return t.L_PrintOpened_Text;case"Floors":return t.L_PrintFloors_Text;case"Height":return t.L_PrintHeight_Text;case"Architect":case"Architects":return t.L_PrintArchitects_Text;case"Established":return t.L_PrintEstablished_Text;case"Artist":case"Artists":return t.L_PrintArtists_Text;case"Subjects":return t.L_PrintSubjects_Text;case"Media":return t.L_PrintMedia_Text;case"Teams":return t.L_PrintTeams_Text;case"Capacity":return t.L_PrintCapacity_Text;case"Elevation":return t.L_PrintElevation_Text;case"Prominence":return t.L_PrintProminence_Text;case"speciality":return t.L_PrintSpecialtyTitle_Text;case"Nearby airports":case"Nearby airport":return t.L_PrintNearbyAirport_Text;case"First ascent":return t.L_PrintFirstAscent_Text;case"First ascender":return t.L_PrintFirstAscender_Text;case"Mountain range":return t.L_PrintMountainRange_Text;case"Last eruption":return t.L_PrintLastEruption_Text;case"Colleges and universities":return t.L_PrintCollegesUniversities_Text;case"Architecture firm":return t.L_PrintArchitectureFirm_Text;case"Service Areas":return t.L_PrintServiceAreas_Text;case"Date completed":return t.L_PrintDateCompleted_Text;case"Annual visitors":return t.L_PrintAnnualVisitors_Text;case"Average stay":return t.L_PrintAverageStay_Text}return null},n.parseAndPushDataFactForPrint=function(t,i){var r,u;if(i&&t)for(r in t)u=n.getNameForProperty(r),n.complexType.indexOf(r)!==-1?n.pushFactToList(i,null,null,t):n.pushFactToList(i,u,n.beautifyList.indexOf(r)===-1?t[r]:n.beautify(t[r]))},n.listContains=function(n,t){for(var i=0;i<n.length;i++)if(n[i].getFactLabel()===t)return!0;return!1},n.pushFactToList=function(t,i,r,u){if(!n.listContains(t,i)){var f=n.setFactsInfo(t,i,r,u);f&&t.push(f)}},n.setFactsInfo=function(t,i,r,u){var f=null;return u?f=n.setExtendedFacts(t,u):i&&r&&(f=new oi,f.setFactLabel(i),f.setFactData(r)),f},n.setExtendedFacts=function(n,i){var o=null,r,u,f,e;return i&&(i.trails&&(r=i.trails,u=new vf,u.length=r.length?r.length:"",u.lengthIcon=r.lengthIcon?r.lengthIcon:"",u.elevation=r.elevation?r.elevation:"",u.elevationIcon=r.elevationIcon?r.elevationIcon:"",u.duration=r.duration?r.duration:"",u.durationIcon=r.durationIcon?r.durationIcon:"",u.difficulty=r.difficulty?r.difficulty:"",u.type="trails",o=new oi,o.setFactLabel(u.length||u.elevation||u.duration?t.L_PrintTrailInfo_Text:""),o.setExtendedFacts(u)),i.campgrounds&&(f=i.campgrounds,e=new ef,e.rvSites=f.RVSites?f.RVSites:"",e.rvIcon=f.RVIcon?f.RVIcon:"",e.tentSites=f.tentSites?f.tentSites:"",e.tentIcon=f.tentIcon?f.tentIcon:"",o=new oi,o.setFactLabel(e.rvSites||e.tentSites?t.L_PrintMainSites_Text:""),o.setExtendedFacts(e))),o},n.beautify=function(n){return n.split(",").join(t.L_PrintSeparator_Text)},n.beautifyList=["Main sites","Nearby airport","Nearby airports","Colleges and universities","Teams","Media","Subjects","Artist","Artists","Architect","Architects","Height","Interests","Sites","Activities","Activity"],n.complexType=["trails","campgrounds"],n}(),yf=function(n){function t(t,i,r,u,f,e,o,h,c,l){var a=n.call(this,t,i,r,u,f,e,o,h,c,l)||this;return a.type=s.polygonEntityDetailsTask,a.displayState={groupName:"PolygonEntityDetails"},a}return v(t,n),t.prototype.activate=function(t,i){r._isFeatureEnabled("verticalZipcode")&&i.selectedCategoryId&&r._isZipCodeCategory(i.selectedCategoryId.toLowerCase())&&i&&i.id&&i.id.indexOf("sid:")>=0&&(i.query=i.taskTitle,i.id=null);n.prototype.activate.call(this,t,i)},t.prototype.canColorFade=function(){return y.features.taskFramework.canCardColorFade},t.prototype.setTaskComplete=function(){n.prototype.setTaskComplete.call(this);var t=this.viewModel.getEntities()[0].getVdpId();t&&(this._taskState.vdpid=t,this.serializableObjectChanged.invoke({magnitude:0}))},t.prototype._createUrl=function(t,i,r){var u=n.prototype._createUrl.call(this,t,i,r);return this._taskState&&this._taskState.point&&this._taskState.point.length===2&&(u+="&bmpoint="+this._taskState.point[0]+","+this._taskState.point[1]),u},t}(dt),pf=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return v(t,n),t.prototype.process=function(n,t){var r=this,u,f;n&&(this._listElements={},this.iids={},this._listItems=n.select("a[data-entity]"),u=this.getCatId(n),f=0,this._listItems.for_each(function(n){var l=n.getAttribute("data-entity"),e,h,c,a,o,s,v;l&&l.length>0?(e=i.Internals.parseJSON(l),e&&e.entity&&e.entity.id&&(h=i(n),c=e.entity.id,r._listElements[c]=h,a=n.getAttribute("h"),a&&(o=a.split("="),o&&o.length===2&&(o=o[1].split("."),o&&o.length&&(r.iids[c]=o[0].replace(",",".")))),r._setTaskData(n,e.entity,t,u),h.add_event("click",function(n){return t.clickHandler(n,e.entity.id)}),h.add_event("contextmenu",function(n){return t.contextMenuHandler(n,e.entity.id)}))):(s=n.getElementsByClassName("b_factrow"),s&&s.length>0&&s[0].innerHTML&&(v=s[0].innerHTML.trim().split("-")[0],r._setTaskData(n,{title:v,primaryCategoryPath:"ZipCode"},t,u)));r._updateListItemStyle(n);r._setInstrumentationData(n,c,f,t);f++}))},t.prototype._updateListItemStyle=function(n){var t=i(n).select("div.inner img"),r;t&&t.length!==0||(r=i(n).select("div.b_vPanel"),r.set_style({"margin-left":0,"text-align":"left"}))},t}(pr),wf=function(n){function t(t,i,r,u,f,e,o,s){return n.call(this,t,i,r,u,f,e,o,s)||this}return v(t,n),t.prototype._refresh=function(){},t.prototype.activate=function(t,i){this.viewModel||(this.viewModel=new df(this.map,this.panelRoot,this.id,this._logHelper,this.poiManager,this._transientLensViewModel,this.controlTemplateFactory));n.prototype.activate.call(this,t,i)},t.prototype._onPoiViewStateChanged=function(n,t){var r=n.primitive,i=r.entity;if(i&&i.id&&r.metadata){var h=this.map.getConfig(),c=this.map.getMercatorZoomLevel(),l=h.postCodeMaxHoverClickZoom;if(n.newValue===2&&c<=l){var o=this._getTaskState()&&this._getTaskState().directionsTaskId,a=o?u.POIAlongRoute:u.POI,p=this.pageProcessor.getCatId(this.viewModel.getResponseContainer()),v={entryPoint:a,id:i.id,flippingCard:!0,taskTitle:r.metadata.title,directionsTaskId:o,originIG:this._taskState&&this._taskState.originIG,parentIG:this._getImpressionGuid(),iid:this.pageProcessor.iids&&this.pageProcessor.iids[i.id],searchQueryCategory:this._taskState&&this._taskState.searchQueryCategory},y={parentId:this.id};e.invokeHandler(f.taskDataHandlerKey,{type:s.polygonEntityDetailsTask,state:v,activateOptions:y});this._logPoiClick(i,t);this._setSelectedPrimitive(n.primitive)}}},t.prototype.processResponse=function(t,u){if(r._isZipCodeCategory(this._taskState.category)||r._isZipCodeCategory(this._taskState.searchQueryCategory)){var e=t.select(".listings-item"),f=[];e.for_each(function(n){var r=i(n),t=r.select(".b_factrow");t&&t.length>0&&t[0].innerHTML.indexOf("-")>=0&&f.push(r.getParent())});f.forEach(function(n){return n.removeFromParent()})}n.prototype.processResponse.call(this,t,u)},t.prototype._createUrl=function(t,i,r){var f=i,u;if(this._taskState.originalResponse&&(u=this._taskState.originalResponse.select("div.overlay-listings").get_attr("data-listingMetadata"),u.length>0)){var e=JSON.parse(u),o=parseInt(e.BlockedCount),s=this._taskState.originalResponse.select(".listings-item").length;f=o+s}return n.prototype._createUrl.call(this,t,f,typeof r=="number"?r:100)},t}(ot),d;(function(t){function st(n,t,i,r){var u,f,s,a,e,c;if(n&&(u=ut(n,t),u&&u.intentKey)){if(f=o[u.intentKey],pi.assert(typeof f=="function","taskInvoker is not defined!"),t&&(t.scenarioKey=u.scenarioKey,ot(n,t)),u.intentKey===h){if(l.cleanupPrimerData(r),s=vt(n,t),s){f&&f(n,s);g(n,t.entryPoint,u.scenarioKey,t.query,[]);return}}else{if(u.intentKey===nt){l.cleanupPrimerData(r);a=yt(n,i,r);g(n,t.entryPoint,u.scenarioKey,t.query,a);return}if(u.intentKey===it){if(l.cleanupPrimerData(r),e=wt(n),e){e.entryPoint=t.entryPoint;f&&f(n,e);g(n,t.entryPoint,u.scenarioKey,t.query,[]);return}}else if(u.intentKey===rt){l.cleanupPrimerData(r);c=pt(n,t,r);f&&f(n,c);g(n,t.entryPoint,u.scenarioKey,t.query,c.boundingBox);return}}f&&f(n,t)}}function ct(t,i){var h=null,u,o,e,f,s,l;if(t&&(u=ut(t,i),u&&u.intentKey)){if(i.scenarioKey&&!(r._isLocalOrRealEstateScenarioOverlayShownOnSerp()&&u.scenarioKey==="ERR")){for(e=Object.keys(n.scenarioKeys),f=0;f<e.length;f++)if(n.scenarioKeys[e[f]]===i.scenarioKey){o=e[f];break}if(o&&n.multiEntityScenarios.indexOf(o)>=0&&(u.intentKey===y||u.intentKey===v))return null}s=c[u.intentKey];s&&(l=s(),h=l.parseEntitiesFromResponse(t,i));i&&(i.scenarioKey=u.scenarioKey,ot(t,i))}return h}function et(n){var t=null,r,u;return n&&(r=n.select("div[data-category]"),r&&r.length&&(t=r.get_attr("data-category")),t||(u=n.select("div.overlay-taskpane"),u&&u.length&&u.for_each(function(n){var u=n.getAttribute("data-entity"),r;u&&u.length&&(r=i.Internals.parseJSON(u),r&&r.entity&&r.entity.primaryCategoryPath&&(t=r.entity.primaryCategoryPath))}))),t}function ut(t,i){var u=t.select("[data-answerinfo]").get_attr("data-answerinfo"),r={};return u?(n.polygonEntityScenarios.indexOf(u)>=0&&lt(t)&&at(t)?r.intentKey=v:n.singleEntityScenarios.indexOf(u)>=0?r.intentKey=i.localFilters||i.keyRoutePoints?w:y:n.multiEntityScenarios.indexOf(u)>=0?r.intentKey=w:n.directionsIntentDrivingScenarios.indexOf(u)>=0?(k=ht.driving,r.intentKey=h):n.directionsIntentTransitScenarios.indexOf(u)>=0?(k=ht.transit,r.intentKey=h):n.directionsIntentWalkingScenarios.indexOf(u)>=0?(k=ht.walking,r.intentKey=h):n.trafficIntentScenarios.indexOf(u)>=0?r.intentKey=nt:n.itineraryDetailsIntentScenarios.indexOf(u)>=0?r.intentKey=it:n.itineraryListingsIntentScenarios.indexOf(u)>=0&&(r.intentKey=rt),r.scenarioKey=n.scenarioKeys[u],r):r}function lt(n){var r=n.select("[data-entity]").get_attr("data-entity"),t;return r&&(t=i.Internals.parseJSON(r),t&&t.entity&&t.entity&&t.entity.vdpId&&t.entity.vdpId!=="")?!0:!1}function at(t){var u=t.select("[data-entity]").get_attr("data-entity"),r;return u&&(r=i.Internals.parseJSON(u),r&&r.entity&&r.entity&&r.entity.locationType&&r.entity.locationType!==""&&n.boundaryDisabledLocationTypes.indexOf(r.entity.locationType)===-1)?!0:!1}function a(n,t,i,u){u===void 0&&(u=!0);u&&i&&(i.content=t);var f=et(t);r._isHouseCategory(f)?i.searchQueryCategory="house":r._isRestaurantCategory(f)?i.searchQueryCategory="restaurant":r._isHotelsCategory(f)?i.searchQueryCategory="hotel":r._isZipCodeCategory(f)&&(i.searchQueryCategory="zipcode");n=r._overrideTasktypeBasedOnCategory(n,i);d(n,i)}function d(n,t){e.invokeHandler(f.taskDataHandlerKey,{type:n,state:t})}function vt(n,t){var c=n.select("[data-directionsintent]").get_attr("data-directionsintent"),u,o,s,f,r,e,h;if(c&&(u=i.Internals.parseJSON(c),u&&u.waypoints&&u.waypoints.length>0)){for(o=[],s=u.waypoints.length,f=0;f<s;f++)r=u.waypoints[f],r&&r.address&&r.point&&(e=new ri(r.address,new b(r.point.latitude,r.point.longitude)),f===s-1?e.waypointType=2:f===0&&(e.waypointType=1),e.rawAddress=r.rawAddress,e.eid=r.eid,o.push(e));return h={waypoints:o,mode:k,entryPoint:5,taskStartTime:t.searchPerfState&&t.searchPerfState.timestamp(),originalQuery:t.originalQuery},u.longDistanceDisplay&&(h.longDistanceDisplay=u.longDistanceDisplay),h}return null}function yt(n,t,r){var f=[],s=n.select("[data-boundingbox]").get_attr("data-boundingbox"),e=s&&i.Internals.parseJSON(s),o,u;return e&&e.boundingBox&&e.boundingBox.length>1&&(o=[],u=e.boundingBox[0],t&&t.hide(),o.push(new b(u.latitude,u.longitude)),f.push(u.latitude),f.push(u.longitude),u=e.boundingBox[1],o.push(new b(u.latitude,u.longitude)),f.push(u.latitude),f.push(u.longitude),r.setView(r.getMode().getMapViewForLocationsInView(o)),t&&t.show(2)),f}function pt(n,t,f){var h={content:n,searchTaskState:t},o,l,v;if(h.entryPoint=t.entryPoint===u.Permalink&&r._isTravelOverlayShownOnSerp()?u.TravelL2:t.entryPoint,o=n.select("div[data-title]"),o&&o.length===1){l=o[0].getAttribute("data-title");h.title=l;var s=[],c=[],a=o[0].getAttribute("data-boundingbox"),e=a&&i.Internals.parseJSON(a);e&&!isNaN(e.SouthLatitude)&&!isNaN(e.WestLongitude)&&!isNaN(e.NorthLatitude)&&!isNaN(e.EastLongitude)&&e.SouthLatitude<90&&e.SouthLatitude>-90&&e.NorthLatitude<90&&e.NorthLatitude>-90&&(s=[e.SouthLatitude,e.WestLongitude,e.NorthLatitude,e.EastLongitude],c.push(new b(s[0],s[1])),c.push(new b(s[2],s[3])),f.setView(f.getMode().getMapViewForLocationsInView(c)),h.boundingBox=s);v=o[0].getAttribute("data-vdpid");h.vdpId=v}return h}function wt(n){var t=n.select("[data-itinerary]").get_attr("data-itinerary");return t?{itineraryJson:t}:null}function g(n,t,i,r,u){var c,s=n.select("div[data-ig]"),o,h,l;s&&s.length===1&&(c=s[0].getAttribute("data-ig")||"");o={EP:t||"",Q:r||"",BB:u,SNRO:i||""};h=tt.getMasterImpressionGuid();o&&h&&(o.MIG=h);l={impressionGuid:c,logData:{feature:ft.Search,action:p[p.STP],data:o}};e.invokeHandler(f.instrumentationDataHandlerKey,l)}function ot(n,t){if(t&&t.isEatAndDrinkOpalAction){t.isFilterSelected=!0;return}var i=n.select("div[data-isFilterSelected]").get_attr("data-isFilterSelected");if(i&&i.toLowerCase().indexOf("true")>-1){t.isFilterSelected=!0;return}t.isFilterSelected=!1}var v="polygonEntity",y="singleEntity",w="multiEntity",h="directions",nt="traffic",it="itinerary",rt="itineraryList",o={},c,k;o[y]=function(n,t){a(s.localDetailsTask,n,t)};o[w]=function(n,t){a(s.localListingTask,n,t)};o[v]=function(n,t){a(s.polygonEntityDetailsTask,n,t)};o["multiPolygon"]=function(n,t){a(s.polygonListingTask,n,t)};o[h]=function(n,t){d(s.directionsTask,t)};o[nt]=function(){};o[it]=function(n,t){d(s.itineraryDetailsTask,t)};o[rt]=function(n,t){d(s.itineraryListingsTask,t)};c={};c[y]=function(){return new fi};c[w]=function(){return new ei};c[v]=function(){return new fi};t.parseResponse=st;t.getEntitiesFromResponse=ct;t.parseCategory=et;t.parseAnswerInfo=ut;t.invokeTask=a})(d||(d={}));var bf=function(t){function i(i,r,u,f,e,o,s,h,c,l){var a=t.call(this,i,r,u,f,e,o,s,h,c,l)||this;return a.setRecommendedWidth(n.restaurantCardWidth),a.setCurrentWidth(n.restaurantCardWidth),a}return v(i,t),i.prototype._createUrl=function(){var n;return Logger.getOverlayType()||(n='disablempr:"true"',this._taskState.extraFuiAugmentations?this._taskState.extraFuiAugmentations+=" "+n:this._taskState.extraFuiAugmentations=n),t.prototype._createUrl.call(this)},i.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForLocalOverlayOnSerp},i.prototype._getSegmentParam=function(){return"restaurant"},i}(dt),kr=function(t){function i(n,i,r,u,f,e,o,s){var h=t.call(this,n,i,r,u,f,e,o,s)||this;return h._infoboxOptions={showCloseButton:!1,zIndex:1006,showPointer:!1,visible:!0,htmlContent:null,location:null,autoAlignment:!0},h._bindEventsForInfobox(),h}return v(i,t),i.prototype._createUrl=function(n,i,r){this._taskState&&(this._taskState.isFallbackRequery=!0,this._taskState.scrollListOnPoiHover=!1,this._taskState.sendInstrumentationEventOnEntityClick=!0);return t.prototype._createUrl.call(this,n,i,r)},i.prototype._getRequestUrlFormat=function(){return t.prototype._getRequestUrlFormat.call(this),n.requestUrlFormatForLocalOverlayOnSerp},i.prototype._bindEventsForInfobox=function(){sj_evt&&sj_evt.bind("pushpinhoverstarted",function(n){var t=n[1],u=t.entity.id.replace("ypid:","").replace("sid:",""),i=_ge(u),f,r;i&&(f=new Microsoft.Maps.Location(t.geometry.y,t.geometry.x),r="<div class='MiniInfobox2' id='infobox-container'><a class='infoBoxLink' role='button' href='#'><div class='infobox-body'>"+i.innerHTML+"<\/div><\/a><\/div>",t.entity.infoboxHtml=r)})},i.prototype._getSegmentParam=function(){return"restaurant"},i}(ot),dr=function(){function n(){}return n.prototype.createBar=function(n){var r=new lu([],!1),u,t,f,i,e,o;if(!n||!n.categories&&!n.levels)return null;if(n.levels&&n.levels.length>0){for(u=new bt("bm_level","bm_level","Level",0,5),t=0;t<n.levels.length;t++){var s=n.levels[t],h=s.name,c=new ct(t.toString(),h,null,t===n.defaultFloor);u.addOption(c)}r.addItem(u)}if(n.categories&&n.categories.length>0){for(f=new bt("bm_category","bm_category","Category",0,5),i=0;i<n.categories.length;i++)e=n.categories[i],o=new ct(i.toString(),e),f.addOption(o);r.addItem(f)}return r.getItemsNumber()===0?null:r},n}(),vt=function(){function n(){}return n.logFilterBarInteraction=function(n,t,i,r){var o={logData:{feature:w.FiltersBar,action:t,data:{EP:u.VenueMap,ID:n,IT:i,DN:r}}};e.invokeHandler(f.instrumentationDataHandlerKey,o)},n.logBusinessClick=function(n,t,i){var r={logData:{feature:ft.VenueMap,action:h.Clicked,data:{EP:t,ID:n,YP:i,IM:y.isMobile}}};e.invokeHandler(f.instrumentationDataHandlerKey,r)},n.logMobileActivation=function(n){var t={logData:{feature:ft.VenueMap,action:h.Activated,data:{EP:u.SerpAnswer,ID:n}}};e.invokeHandler(f.instrumentationDataHandlerKey,t)},n.logMobileViewToggle=function(n,t){var i={logData:{feature:ft.VenueMap,action:h.Clicked,data:{TG:"ViewToggle",ID:n,TL:t}}};e.invokeHandler(f.instrumentationDataHandlerKey,i)},n}(),gr=function(n){function f(i,r,u,f){var e=this,s={},h,o;return e=n.call(this,s,u,r)||this,s.defineProperty("entities"),e._map=i,e.controlTemplateFactory=u,e.resources=t,e._businessYpidDictionary={},e._selecteDirectoryBusiness=null,e._venueMap=f.venueMap,e._venueMapTask=f,e._venueMapMetadata=e._venueMapTask.metadata,h=e._venueMap.defaultFloor,o=e._venueMap.floors.filter(function(n){return n.name===h}),e.activeFloor=o.length>0&&o[0],e.floors=e._venueMapMetadata.floors,e.entities=new ni,e._lang=y.dynamicProperties.market.split("-")[0].toLowerCase(),e._setPrimitiveDictionaries(),e._createUIElements(),e}return v(f,n),f.prototype._setPrimitiveDictionaries=function(){var r={},u,s,t,f,h,i,e,n,o;for(this.categories=[],u=this._venueMap.floors,s=u.length,t=0;t<s;t++)for(f=u[t].getPrimitives(),h=f.length,i=0;i<h;i++)e=f[i],n=e.metadata,n&&n.ypid&&n.category&&(!this.activeCategory||n.category===this.activeCategory)&&(this._businessYpidDictionary[n.ypid]=e,r[n.category]=!0);for(o in r)r[o]&&this.categories.push(o);this.categories.sort()},f.prototype._createUIElements=function(){this.name=this._venueMap.name;this._updateEntityList();this._createFiltersBar()},f.prototype._updateEntityList=function(){var r=this,t,i,n;if(this.entities.clear(),this.activeFloor)this._venueMap.setActiveFloor(this.activeFloor.name),this._addBusinessesToList(this.activeFloor);else{for(t=this._venueMap.floors,i=t.length,n=0;n<i;n++)this._addBusinessesToList(t[n]);this._venueMap.setActiveFloor(this._venueMap.defaultFloor)}this.updateNoEntityMessage();this._map.getTemplateSelector().then(function(){r._venueMapTask.directoryUpdated.invoke()})},f.prototype._addBusinessesToList=function(n){for(var r,t,u=n.getPrimitives(),f=u.length,i=0;i<f;i++)r=u[i],t=r.metadata,t&&t.ypid&&t.category&&(!this.activeCategory||t.category===this.activeCategory)&&(t.name=r.getTitle(),t.taskInfo=t.ypid&&this._buildEntityDataTask(t),this.entities.insert(t))},f.prototype.toggleSelectedBusiness=function(n){var t="bm_selected";this._selecteDirectoryBusiness&&this._selecteDirectoryBusiness.remove_class(t);n&&(n.add_class(t),this._selecteDirectoryBusiness=n)},f.prototype.onBusinessClick=function(n){var t=i(n.currentTarget?n.currentTarget:n);this.toggleSelectedBusiness(t);vt.logBusinessClick(this._venueMapTask.venueMapState.venueMapId,u.TaskCard,this._getYpidFromBusiness(t))},f.prototype.onBusinessMouseOver=function(n){var f,r;if(this._map.getMercatorZoomLevel()>=15&&!y.isMobile){var e=i(n.currentTarget||n),u=this._getYpidFromBusiness(e),t=u&&this._businessYpidDictionary[u];t&&(t.setState(3),f=t.metadata.polygon,r=new Microsoft.Maps.Polyline(f.getLocations(),{strokeColor:"rgb(0, 0, 0)"}),this._venueMap.activeFloorLayer.add(r),this._hoveredEntityInfo={primitive:t,highlightPolyline:r})}},f.prototype._getYpidFromBusiness=function(n){var t=n&&n.get_attr("data-task"),i=t&&t.length>0&&JSON.parse(t),r=i&&i.state&&i.state.id;return r&&r.substring(5)},f.prototype._buildEntityDataTask=function(n){var i={},t={};return t.entryPoint="LocalListing",t.id="ypid:"+n.ypid,t.flippingCard=!0,t.taskTitle=n.name.replace(/\n/g," "),t.originalName=t.taskTitle,t.selectedCategoryId=n.category,i.state=t,i.type=s.localDetailsTask,i.activateOptions={},i.activateOptions.parentId=this._venueMapTask.id,JSON.stringify(i)},f.prototype._createFiltersBar=function(){var n=this;this._filterBarViewModel=new cu(this.controlTemplateFactory);var t=this._venueMap.floors.filter(function(t){return t.name===n.activeFloor.name}),i={categories:this.categories,levels:this._venueMap.floors,defaultFloor:this._venueMap.floors.indexOf(t[0])},r=new dr;this._filtersBar=r.createBar(i);this._filterBarViewModel.filterItemDiscardedFromSelection.add(function(t){var i=n._venueMapTask.venueMapState.venueMapId;t.id==="bm_level"?(vt.logFilterBarInteraction(i,h.Removed,t.displayName,n.activeFloor.name),n.entities.clear(),n.activeFloor=null):t.id==="bm_category"&&(vt.logFilterBarInteraction(i,h.Removed,t.displayName,n.activeCategory),n.activeCategory=null,n._venueMap.setBusinessCategoryFilters([]));n._updateEntityList()});this._filterBarViewModel.filterOptionClicked.add(function(t){var r=n._venueMapTask.venueMapState.venueMapId,i=t.item,u=parseInt(t.value);i.id==="bm_level"?(n.entities.clear(),n.activeFloor=n._venueMap.floors[u],vt.logFilterBarInteraction(r,h.Selected,i.displayName,n.activeFloor.name)):i.id==="bm_category"&&(n.activeCategory=n.categories[u],n._venueMap.setBusinessCategoryFilters([n.activeCategory]),vt.logFilterBarInteraction(r,h.Selected,i.displayName,n.activeCategory));n._updateEntityList()})},f.prototype.showFiltersBar=function(){var n=r._isFeatureEnabled("mobileMyPlaces")?i("#venueFilterContainer"):this._venueMapTask.panelRoot.select("div[class=bm_filtersBarModule]");typeof n!="undefined"&&this._filterBarViewModel.update(this._filtersBar,n)},f.prototype.updateNoEntityMessage=function(){var n=this;this._map.getTemplateSelector().then(function(){var t=n._venueMapTask.panelRoot.select(".bm_noEntityMessage");t&&(t.set_style({display:n.entities.length>0?"none":""}),t.set_text(n.activeFloor&&n.activeFloor.hasRichDetailsPois?n.resources.L_VenueMapTask_NoCategory_Message:n.resources.L_VenueMapTask_NoEntity_Message))})},f.prototype.onBusinessMouseOut=function(){if(this._hoveredEntityInfo){var n=this._hoveredEntityInfo.primitive;n.setState(2);this._venueMap.activeFloorLayer.remove(this._hoveredEntityInfo.highlightPolyline);this._hoveredEntityInfo=null}},f._iconDictionary={},f}(wt),kf=function(n){function o(i,r){var u=n.call(this)||this;return u.map=i,u.type=s.venueMapDirectoryTask,u._controlTemplateFactory=r,u.resources=t,u.scrollLane=new g,u.venueMapLoaded=new g,u.directoryUpdated=new g,u}return v(o,n),o.prototype.activate=function(t,i){var r=this,u;i||this.deactivate();n.prototype.activate.call(this,t);u=t.getContainer();this.setTitle(this.resources.L_VenueMapTaskTitle_Suffix+i.title);this.venueMapState=i;u.downloadDependency("VenueMap",function(){r._venueMapType=Microsoft.Maps.VenueMaps.VenueMap;r.getVenueMetadata(r.venueMapState.venueMapId,function(n){r.metadata=n;u.instanceAsync("VenueMap",function(t){r.initVenueMap(t,n)},{venueMapId:r.venueMapState.venueMapId,venueMapMetadata:n,venueMapOptions:{businessClickedHandler:function(n){r._handleBusinessClick(n)}}})})});this.setPercentLoaded(1)},o.prototype.initVenueMap=function(n,t){var u=this,i,f,e;this.venueMap=n;this.venueMap.setActiveFloor(this.venueMap.defaultFloor);this.setTitle(this.resources.L_VenueMapTaskTitle_Suffix+this.venueMap.name);this._viewModel=new gr(this.map,r._isFeatureEnabled("mobileMyPlaces")?hr:sr,this._controlTemplateFactory,this);this.panelRoot.clear();this.changed.add(function(n){if(n&&n.name&&n.name==="displayState"&&n.newValue!==n.oldValue){var t=n.newValue,i=n.oldValue;t&&t.activationState!==3?u.venueMap.show():u.venueMap.hide()}});this.displayState.activationState===3?this.venueMap.hide():this.venueMap.show();i=t.bbox;f=this.map.getMode().getMapViewForLocationsInView([new b(i[2],i[1]),new b(i[0],i[3])]);this.map.setView(f);e=new gt(r._isFeatureEnabled("mobileMyPlaces")?hr:sr,this._viewModel).applyDataTemplate(this._viewModel);this.addControl(e);this._viewModel.showFiltersBar();this._viewModel.updateNoEntityMessage();this.venueMapLoaded.invoke()},o.prototype.getVenueMetadata=function(n,t){var u=this,e=this.map.getAuthKey(),s=this.map.getConfig().venueMapMetadataUrl.replace("{venueMapId}",n).replace("{credentials}",e).replace("{culture}",y.dynamicProperties.market),h="venueMap_"+this.id,r=1,o=function(){--r;t(null)},f=null,i;this._venueMapType.categoryToBucket||(r++,i=this.map.getConfig().venueMapCategoryToBucketUrl,i=i.replace("{credentials}",e),it.downloadJsonp(i,"venueMap",function(n){u._venueMapType.categoryToBucket=n;u._onMetadataAvailable(--r,t,f)},o));this._venueMapType.typeToBucket||(r++,i=this.map.getConfig().venueMapTypeToBucketUrl,i=i.replace("{credentials}",e),it.downloadJsonp(i,"venueMap",function(n){u._venueMapType.typeToBucket=n;u._onMetadataAvailable(--r,t,f)},o));it.downloadJsonp(s,"venueMap",function(n){f=n;u._onMetadataAvailable(--r,t,f)},o)},o.prototype.setDisplayState=function(t){t.activationState===1&&this._viewModel&&this._viewModel.toggleSelectedBusiness(null);n.prototype.setDisplayState.call(this,t)},o.prototype.deactivate=function(){var t,i;n.prototype.deactivate.call(this);t=this.venueMap&&this.venueMap.getActiveFloor();t&&(i=this.venueMap.floors.filter(function(n){return t===n.name}),this.map.getLayers().remove(i[0]));this._viewModel&&this._viewModel.entities.clear();this._viewModel&&this._viewModel.dispose();this.venueMap&&this.venueMap.dispose();n.prototype.deactivate.call(this)},o.prototype.close=function(){var n={action:"remove",id:this.id};e.invokeHandler(f.taskDataHandlerKey,n)},o.prototype.serialize=function(){return this.venueMapState},o.prototype.processCallback=function(){return},o.prototype.getMenuList=function(){return[]},o.prototype.getCardIconInfo=function(){var n=o._cardIconCatIdMapping[this.venueMapState&&this.venueMapState.venueMapType]||o._cardIconCatIdMapping["default"];return{iconClass:"vmTask",iconElements:this.getCardIcons(n)}},o.prototype.getIconColorAndClassName=function(n){var t=o._cardIconCatIdMapping[this.venueMapState&&this.venueMapState.venueMapType]||o._cardIconCatIdMapping["default"];this._buildCardIcon(null,t,function(t){n(t,"venueMapTask")})},o.prototype.isSharable=function(){return!1},o.prototype.getListingFromPushpin=function(n){var o=null,s=n&&n.metadata&&n.metadata.ypid,u,t,f,e;if(s)for(u=this.panelRoot.select(r._isFeatureEnabled("mobileMyPlaces")?".bm_venueEntity":"#bm_venueEntity"),t=0;t<u.length;t++)if(f=u[t],e=f.getAttribute("data-task"),e&&e.indexOf(s)>=0){o=i(f);break}return o},o.prototype._handleBusinessClick=function(n){var t=n.primitive,i=this.getListingFromPushpin(t),r;i&&(r=t&&t.metadata&&t.metadata.ypid,this.scrollLane.invoke(i),this._viewModel&&this._viewModel.toggleSelectedBusiness(i),e.invokeHandler(f.taskDataHandlerKey,JSON.parse(i.get_attr("data-task"))),vt.logBusinessClick(this.venueMapState.venueMapId,u.POI,r))},o.prototype._onMetadataAvailable=function(n,t,i){n===0&&this.map.getTemplateSelector().then(function(n){n.selectorReady().then(function(){var s=[],e=i.floors,r,u,f,o;if(e)for(r=0;r<e.length;r++)if(u=e[r].entities,u)for(f=0;f<u.length;f++)o=Microsoft.Maps.VenueMaps.VenueMap.getEntityBucketId(u[f]),o.geometryType===1&&s.push(o.bucketId);n.prefetchImages(s).then(function(){t(i)})})})},o._cardIconCatIdMapping={Airport:"91621",Mall:"90771","default":"91600"},o}(tt),nu=function(n){function i(i,r,u,f,e){var o=this,s={},h,c;for(o=n.call(this,s,r,li)||this,o._controlTemplateFactory=r,s.defineProperty("printEntities"),s.defineProperty("listHours"),s.defineProperty("wikiText"),s.defineProperty("printFacts"),o._entities=[],o._openHours=[],o._printFacts=[],o.resources=t,o._dataFacts=f,h=0;h<u.length;h++)c=new ai(u[h]),o._entities.push(c);return o.createHoursTemplate(),o._setPrintFacts(),o.setListHours(o._openHours),o.setPrintFacts(o._printFacts),o._entities&&o._entities.length&&o._entities[0].getTitle()!==e&&(o._entities[0].originalName=e),o.setPrintEntities(o._entities),o}return v(i,n),i.prototype.hideIfMatchedData=function(n){return n===null&&this._entities[0].getTitle()===n?"none":""},i.prototype.createHoursTemplate=function(){var t,e,o,s,l,u,v,h,a;if(this._dataFacts&&this._dataFacts.openHours!==undefined)for(t=0;t<this._dataFacts.openHours.length;t++){var f=new br,n=[],i=[];for(e=0;e<this._dataFacts.openHours[t].hoursRanges.length;e++)if(o=this._dataFacts.openHours[t].hoursRanges[e].start,s=this._dataFacts.openHours[t].hoursRanges[e].end,o!=s){f.setDay(this._dataFacts.openHours[t].day);o=o.split(":");s=s.split(":");var c=new wr,y=r._formatShortTimeString(Number(o[0]),Number(o[1]),0),p=r._formatShortTimeString(Number(s[0]),Number(s[1]),0);c.setStart(y);c.setEnd(p);n.push(c);e>=0&&this._openHours.length>0&&(i=this._openHours[this._openHours.length-1].getHourRanges())}if(i&&i.length>0&&n&&n.length>0&&i.length===n.length){for(l=!1,u=0;u<i.length;u++)(i[u].getStart()!==n[u].getStart()||i[u].getEnd()!==n[u].getEnd())&&(l=!0);l?(f.setHourRanges(n),this._openHours.push(f)):(v=f.getDay(),h=this._openHours[this._openHours.length-1].getDay(),h.indexOf("-")>0&&(a=[],a=h.split("-"),h=a[0].trim()),this._openHours[this._openHours.length-1].setDay(h+" - "+v))}else n&&n.length>0&&(f.setHourRanges(n),this._openHours.push(f))}},i.prototype._setPrintFacts=function(){if(this._entities[0].getLocation()&&!this._entities[0].id.toUpperCase().match("YPID")&&(this._entities[0].getLocationType()==="State"||this._entities[0].getLocationType()==="StreetAddress"||this._entities[0].getLocationType()==="County")){var n=this._entities[0].getLocation(),i=n.latitude.toString()+", "+n.longitude.toString();this._pushFactsIntoList(t.L_PrintExtendedLatLong_Text,i)}this._dataFacts&&(this._dataFacts.website&&!this._entities[0].getWebsite()&&this._entities[0].setWebsite(this._dataFacts.website),this._dataFacts.phone&&!this._entities[0].getPhone()&&this._entities[0].setPhone(this._dataFacts.phone),vi.parseAndPushDataFactForPrint(this._dataFacts,this._printFacts))},i.prototype._pushFactsIntoList=function(n,t,i){var r=vi.setFactsInfo(this._printFacts,n,t,i);r&&this._printFacts.push(r)},i}(wt),tu=function(n){function t(t,r,u,f,e){var o=this,v={},c,s,p,h,y,a;for(o=n.call(this,v,r,li)||this,o._controlTemplateFactory=r,v.defineProperty("printEntities"),v.defineProperty("printEntitiesList2"),o._entities1=[],o._entities2=[],c=e?e.select("a.listings-item"):null,s=0;s<u.length;s++)u[s].entity.iconText=(s+1).toString(),p=u[s].entity,h=new ai(p),o.setPrintIconTextAndColor(h,s,f),c&&s<c.length&&(y=i(c[s]).get_attr("data-facts"),y&&(a=[],o.setPrintFactsForEntity(l.parseDataFact(y),a),a.length>0&&(h.printFacts=a))),s%2==0?o._entities1.push(h):o._entities2.push(h);return o.setPrintEntities(o._entities1),o.setPrintEntitiesList2(o._entities2),o}return v(t,n),t.prototype.hideIfMatchedData=function(n){return n&&n.getAddress()===null||n.getTitle()===n.getAddress()?"none":""},t.prototype.setPrintIconTextAndColor=function(n,t,i){n.iconText=(t+1).toString();n.colorIndex=i},t.prototype.setPrintFactsForEntity=function(n,t){vi.parseAndPushDataFactForPrint(n,t)},t}(wt),df=function(n){function t(t,i,r,u,f,e,o){return n.call(this,t,i,r,u,f,e,o)||this}return v(t,n),t.prototype.setResponseContent=function(t,i){var r=this;(n.prototype.setResponseContent.call(this,t,i),t&&this.panelRoot)&&(this._zipCodes=[],this._zipCodePolygonDownloadCompleted=!1,this.zipCodePolygonsDownloaded=new g,this.zipCodePolygonsDownloaded.add(function(){r._zipCodePolygonDownloadCompleted=!0}),this._getZipCodePolygonsFromResponse(t,i))},t.prototype.registerListItemEvents=function(){var n=this;this._zipCodePolygonDownloadCompleted?this._handlerHoverEvents():this.zipCodePolygonsDownloaded.add(function(){n._handlerHoverEvents()})},t.prototype.parseEntitiesFromResponse=function(){return[]},t.prototype._shouldPaginate=function(n){return!n||n.length<=this._paginationItemsPerPage?!1:!0},t.prototype._paginationSetDisplayForItems=function(n,t,i,r){var u,f,e;if(n&&!(n.length<=this._paginationItemsPerPage)){for(u=0,f=n.length;u<f;u++)e=Math.floor(u/this._paginationItemsPerPage)+1===t,n[u].style.display=e?"list-item":"none";r&&r()}},t.prototype._handlerHoverEvents=function(){var t=this,n;this._registerListItemEventsForZipCodes();n=this._poiManager.getLayer();n?Microsoft.Maps.Internal.CityPolygonManager.bindPostCodeLayerHandlers(n,this.map):this._poiManager.primitivesRendered.addOne(function(){n=t._poiManager.getLayer();Microsoft.Maps.Internal.CityPolygonManager.bindPostCodeLayerHandlers(n,t.map)})},t.prototype._getZipCodePolygonsFromResponse=function(n){var t=this,i=n.select(this._selector);i.for_each(function(n){var i=t._findZipCodeInItem(n,!0);i&&i.length>0&&t._zipCodes.indexOf(i)<0&&t._zipCodes.push(i)});this._zipCodes.length>0&&this.map.getCityPolygonManager().then(function(){Microsoft.Maps.Internal.CityPolygonManager.populatePostCodeLayer(t.map,null,t._zipCodes,function(n){t._poiManager.setPrimitives(n);t._primitives=n;t.zipCodePolygonsDownloaded.invoke()},!0)})},t.prototype._registerListItemEventsForZipCodes=function(){var n=this,r=this.panelRoot.select("a[data-entity]"),t=Microsoft.Maps.Internal.CityPolygonManager;r.for_each(function(r){var o=n._findZipCodeInItem(r),u,f,h,c,e;if(o&&o.length>0){for(f=0,h=n._primitives.length;f<h;f++)if(c=n._primitives[f],e=c.metadata,e&&o.indexOf(e.title)>=0&&!e.polygon){u=n._primitives[f];break}if(u){var s=i(r),l=function(){t.handlePostCodePrimitiveHover({eventName:"mouseover",layer:n._poiManager.getLayer(),primitive:u});n._entityCardHoverStartTime=Date.now()},a=function(){t.handlePostCodePrimitiveHover({eventName:"mouseout",layer:n._poiManager.getLayer(),primitive:u});n._logEntityCardHoverIfNecessary(u.entity)};s.add_event("mouseenter",l).add_event("mouseleave",a);n._addEventsToEventList(s,"mouseenter",l);n._addEventsToEventList(s,"mouseleave",a)}}})},t.prototype._findZipCodeInItem=function(n,t){var r,e=n.getAttribute("data-entity"),u,f;return e&&e.length>0?(u=i.Internals.parseJSON(e),u&&u.entity&&(r=u.entity.title)):(f=n.getElementsByClassName("b_factrow"),f&&f.length>0&&(r=f[0].innerHTML)),t&&(r=r.trim().split("-")[0]),r},t}(ei),iu=function(n){function i(i,r,u,f){var e=this,o={};return e=n.call(this,o,i,uf)||this,o.defineProperty("showLeftChevron"),o.defineProperty("showRightChevron"),e._listingTask=u,e._totalResultCount=f,e.setShowLeftChevron(!1),e.setShowRightChevron(!0),e._offset=0,e._paginationItemsPerPage=r,e.resources=t,e}return v(i,n),i.prototype.leftChevronClicked=function(n){n&&(n.stopPropagation(),n.preventDefault());this._offset>=this._paginationItemsPerPage&&(this._offset-=this._paginationItemsPerPage,this._listingTask.sendPaginationRequest(this._offset,this._paginationItemsPerPage,this));this._offset===0&&this.setShowLeftChevron(!1)},i.prototype.rightChevronClicked=function(n){n&&(n.stopPropagation(),n.preventDefault());this._offset+=this._paginationItemsPerPage;this._rightChevronRequestSent=!0;this._listingTask.sendPaginationRequest(this._offset,this._paginationItemsPerPage,this)},i.prototype.updateChevrons=function(n){n>0&&(n<this._paginationItemsPerPage||this._totalResultCount&&n+this._offset>=this._totalResultCount?this.setShowRightChevron(!1):this.setShowRightChevron(!0));n===0&&this._rightChevronRequestSent&&this._offset>=this._paginationItemsPerPage&&(this._offset-=this._paginationItemsPerPage);this._offset>0?this.setShowLeftChevron(!0):this.setShowLeftChevron(!1);this._rightChevronRequestSent=!1},i}(wt);a.HotelsDetailsTask=sf;a.HotelsListingTask=hf;a.HouseDetailsTask=cf;a.HouseListingTask=lf;a.PolygonListingTask=wf;a.RestaurantDetailsTask=bf;a.RestaurantsListingTask=kr;a.AnnotationControl=cr;a.DirectoryFilterBarFactory=dr;a.GeochainListViewModel=ar;a.LocalDetailsPageProcessor=af;a.LocalDetailsPrintViewModel=nu;a.LocalDetailsTask=dt;a.LocalListingPageProcessor=pr;a.LocalListingPrintViewModel=tu;a.LocalListingTask=ot;a.LocalPrintEntity=ai;a.LocalPrintFacts=oi;a.LocalPrintHourRange=wr;a.LocalPrintOpenHours=br;a.LocalSearchTask=l;a.LogHelper=vr;a.PolygonEntityDetailsTask=yf;a.PolygonListingPageProcessor=pf;a.ResponseIntentProcessor=d;a.ServerPaginationViewModel=iu;a.VenueMapLogHelper=vt;a.VenueMapTask=kf;a.VenueMapTaskViewModel=gr}catch(ru){if(o.logger)o.logger.logCriticalError(ru);else throw ru;}}).call(window)